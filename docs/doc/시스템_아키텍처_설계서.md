# 시스템 아키텍처 설계서
## 소상공인 광고 콘텐츠 생성 서비스

**작성일**: 2026-01-03
**프로젝트 기간**: 2025-12-29 ~ 2026-01-27 (4주)  
**1단계 (MVP)**: 2026-01-15까지 (기본 기능 완성)  
**2단계 (개선)**: 2026-01-16 ~ 2026-01-27 (품질 향상)  
**버전**: 2.0

---

## 목차
1. [시스템 개요](#1-시스템-개요)
2. [전체 시스템 아키텍처](#2-전체-시스템-아키텍처)
3. [인프라 구성 (GCP VM 기반)](#3-인프라-구성-gcp-vm-기반)
4. [핵심 플로우 시퀀스 다이어그램](#4-핵심-플로우-시퀀스-다이어그램)
5. [데이터베이스 설계](#5-데이터베이스-설계)
6. [개발 단계별 기능](#6-개발-단계별-기능)

---

## 1. 시스템 개요

### 1.1 서비스 목적
소상공인이 생성형 AI 기술을 활용하여 **업종 제약 없이** 광고 이미지와 마케팅 문구를 손쉽게 제작할 수 있는 웹 기반 서비스

### 1.2 MVP 핵심 기능 (1단계: ~ 2026-01-15)
✅ **필수 구현 항목**:
1. 텍스트 입력 → 광고 이미지 생성
2. 텍스트 입력 → 광고 문구 자동 생성
3. 챗봇 UI (대화형 인터페이스)
4. 회원가입/로그인
5. 광고 생성 이력 조회
6. 이미지 비율 선택 (1:1, 4:3, 3:4)

### 1.3 품질 개선 기능 (2단계: 2026-01-16 ~ 27)
⏳ **추가 구현 항목**:
1. 채팅 이력 관리 및 세션 저장
2. 브랜드 설정 (로고 업로드)
3. UI/UX 개선 (반응형, 애니메이션)
4. 성능 최적화
5. 에러 처리 고도화
6. 오늘의 추천 기능

### 1.4 주요 사용자
- **주 타겟**: 소상공인 (카페, 식당, 소매점, 서비스업 등 **업종 제약 없음**)
- **비회원**: 1회성 광고 생성 가능 (이력 미저장)
- **회원**: 이력 관리 및 재사용 가능

---

## 2. 전체 시스템 아키텍처

### 2.1 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                    사용자 (웹 브라우저)                       │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTPS
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   프론트엔드 (Svelte)                        │
│  - Vercel 자동 배포                                          │
│  - 챗봇 UI, 광고 생성 폼                                     │
│  - 회원가입/로그인 UI                                        │
│  - 생성 이력 조회                                            │
└────────────────────────┬────────────────────────────────────┘
                         │ REST API (JSON)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              GCP VM 인스턴스 (단일 서버)                      │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         백엔드 API (FastAPI)                          │   │
│  │  - 포트: 8000                                         │   │
│  │  - 엔드포인트: /generate, /auth, /history             │   │
│  └──────────────┬───────────────────────────────────────┘   │
│                 │                                           │
│                 ▼                                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │        비즈니스 로직 (services.py)                    │   │
│  │  - 워크플로우 조율                                    │   │
│  │  - AI 모델 호출                                       │   │
│  └──────┬───────────────────┬───────────────────────────┘   │
│         │                   │                               │
│         ▼                   ▼                               │
│  ┌─────────────┐     ┌─────────────────┐                    │
│  │ AI 모델     │     │ PostgreSQL      │                    │
│  │ 이미지: SDXL│     │ - 포트: 5432     │                    │
│  │ 텍스트: GPT │     │ - DB: adbizdb   │                    │
│  └─────────────┘     └─────────────────┘                    │
│                                │                            │
│                                ▼                            │
│                      ┌──────────────────┐                   │
│                      │ 로컬 파일 저장소  │                   │
│                      │ /data/images     │                   │
│                      └──────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 기술 스택

| 레이어 | 기술 | 배포 환경 | 비고 |
|--------|------|----------|------|
| **프론트엔드** | Svelte | Vercel | Git push 시 자동 배포 |
| **백엔드 API** | FastAPI | GCP VM | 단일 VM 내 실행 |
| **비즈니스 로직** | Python 3.10+ | GCP VM | asyncio 비동기 처리 |
| **이미지 생성** | SDXL (Stable Diffusion XL) | GCP VM | GPU 사용 권장 |
| **텍스트 생성** | OpenAI GPT API | 외부 API | gpt-4o-mini 사용 |
| **데이터베이스** | PostgreSQL 15 | GCP VM (localhost) | 동일 VM 내 설치 |
| **파일 저장소** | 로컬 파일 시스템 | GCP VM | /data/ 디렉토리 |
| **컨테이너** | Docker (선택) | GCP VM | 환경 격리 |

---

## 3. 인프라 구성 (GCP VM 기반)

### 3.1 GCP VM 인스턴스 사양

**실제 사양**:
- **머신 타입**: g2-standard-4 (vCPU 4개, 메모리 16GB)
- **CPU 플랫폼**: Intel Cascade Lake
- **GPU**: 1x NVIDIA L4
- **부팅 디스크**: 
  - 이미지: ubuntu-accelerator-2204-amd64-with-nvidia-570-v20251218
  - 아키텍처: X86_64
  - 용량: 200GB
- **방화벽**: 포트 8000 (FastAPI), 5432 (PostgreSQL - 외부 차단) 허용

### 3.2 VM 내부 디렉토리 구조

```
/home/{user}/codeit_ad_smallbiz/
├── src/                     # 소스 코드 루트
│   ├── frontend/            # Svelte (개발용, 실제 배포는 Vercel)
│   │   ├── src/
│   │   ├── public/
│   │   └── package.json
│   ├── backend/             # FastAPI
│   │   ├── __init__.py
│   │   ├── routes.py
│   │   ├── services.py
│   │   ├── db_processor.py
│   │   └── schemas.py
│   ├── generation/          # AI 모델
│   │   ├── __init__.py
│   │   ├── image_generation/
│   │   │   ├── __init__.py
│   │   │   └── unified_generator.py
│   │   └── text_generation/
│   │       ├── __init__.py
│   │       ├── prompt_manager.py
│   │       └── text_generator.py
│   ├── utils/               # 전역 유틸리티
│   │   ├── __init__.py
│   │   ├── validators.py    # DB 유효성 검사
│   │   ├── config.py        # 환경 설정 관리
│   │   ├── logging_config.py # 로깅 시스템
│   │   ├── database.py      # DB 연결 관리
│   │   └── storage.py       # 파일 저장/로드
│   ├── deployment/          # 배포 관련
│   │   ├── __init__.py
│   │   ├── docker/
│   │   │   ├── Dockerfile.frontend
│   │   │   ├── Dockerfile.backend
│   │   │   └── docker-compose.yml
│   │   └── scripts/
│   │       └── deploy.sh
│   └── tests/               # 테스트 코드
│       ├── __init__.py
│       ├── test_api.py      # API 엔드포인트 테스트
│       ├── test_models.py   # AI 모델 테스트
│       └── test_integration.py # 통합 테스트
├── data/                    # 파일 저장소
│   └── images/
│       ├── input/           # 사용자 업로드 이미지 (2단계)
│       └── generated/       # AI 생성 이미지
├── logs/                    # 로그 파일
├── models/                  # AI 모델 다운로드 위치
│   ├── sdxl/
│   └── flux/
├── .env                     # 환경 변수
├── .gitignore
├── requirements.txt
└── README.md
```

**주요 디렉토리 설명**:
- `src/`: 모든 소스 코드의 루트 디렉토리
  - `backend/`: FastAPI 백엔드 핵심 로직
  - `generation/`: AI 모델 (이미지, 텍스트 생성)
  - `utils/`: 전역 유틸리티 (설정, 로깅, 검증, DB, 파일 저장)
  - `deployment/`: 배포 설정 (Docker, 스크립트)
  - `tests/`: 테스트 코드
- `data/`: 사용자 업로드 및 생성 이미지
- `models/`: AI 모델 가중치 파일 (약 7GB)
- `models/`: AI 모델 가중치 파일 다운로드 위치 (약 7GB)

### 3.3 PostgreSQL 설정

**설치 및 설정**:
```bash
# PostgreSQL 설치
sudo apt-get update
sudo apt-get install postgresql postgresql-contrib

# 데이터베이스 생성
sudo -u postgres psql
CREATE DATABASE adbizdb;
CREATE USER ad_user WITH PASSWORD 'your_password';
GRANT ALL PRIVILEGES ON DATABASE adbizdb TO ad_user;

# 로컬 접속만 허용 (보안)
# /etc/postgresql/15/main/pg_hba.conf 편집
# host  adbizdb  ad_user  127.0.0.1/32  md5
```

**연결 정보**:
- Host: `localhost` (또는 `127.0.0.1`)
- Port: `5432`
- Database: `adbizdb`
- User: `ad_user`
- Connection String: `postgresql://ad_user:password@localhost:5432/adbizdb`

### 3.4 서비스 실행 구조

```
[VM 시작 시 자동 실행]
1. PostgreSQL 서비스 (systemd)
2. FastAPI 서버 (systemd 또는 supervisor)
   - cd /home/{user}/codeit_ad_smallbiz
   - uvicorn src.backend.routes:app --host 0.0.0.0 --port 8000

[개발 환경]
- tmux/screen 세션에서 개별 실행
- 디버깅 모드: 
  cd /home/{user}/codeit_ad_smallbiz
  uvicorn src.backend.routes:app --reload --host 0.0.0.0 --port 8000
```

**Python 경로 설정**:
```bash
# .env 또는 환경 변수에 추가
export PYTHONPATH=/home/{user}/codeit_ad_smallbiz:$PYTHONPATH

# 또는 프로젝트 루트에서 실행 시 자동으로 src/ 인식
cd /home/{user}/codeit_ad_smallbiz
python -m src.backend.routes  # 모듈 방식 실행 가능
```

### 3.5 파일 저장소 구조

```
/home/{user}/codeit_ad_smallbiz/data/images/
├── input/                   # 사용자 업로드 이미지 (2단계)
│   └── {user_id}/
│       └── {hash}.png
└── generated/               # 생성된 광고 이미지
    └── {user_id}/
        └── {timestamp}_{hash}.png

# 이미지 접근 방식
- DB에 상대 경로 저장: "images/generated/1/2026-01-10_abc123.png"
- FastAPI에서 정적 파일 서빙: /static/images/{path}
```

---

## 4. 핵심 플로우 시퀀스 다이어그램

### 4.1 광고 생성 플로우 (전체)

```mermaid
sequenceDiagram
    actor User as 사용자
    participant Frontend as 프론트엔드<br/>(Svelte)
    participant API as 백엔드 API<br/>(FastAPI)
    participant Service as 비즈니스 로직<br/>(services.py)
    participant PromptMgr as 프롬프트 생성<br/>(PromptTemplateManager)
    participant GPT as GPT API<br/>(OpenAI)
    participant ImgGen as 이미지 생성<br/>(UnifiedImageGenerator)
    participant SDXL as SDXL 모델<br/>(Diffusers)
    participant DB as PostgreSQL
    participant Storage as 파일 저장소<br/>(/storage)

    User->>Frontend: 1. 텍스트 입력 + 비율 선택<br/>"카페 신메뉴 홍보, 3:4"
    Frontend->>API: 2. POST /generate<br/>{user_id, input_text, aspect_ratio}
    
    API->>API: 3. Task ID 생성 (UUID)
    API-->>Frontend: 4. Task ID 반환<br/>{task_id: "abc-123"}
    
    Frontend->>Frontend: 5. 로딩 UI 표시<br/>(Spinner + "생성 중...")
    
    API->>Service: 6. 백그라운드 작업 시작<br/>create_advertisement()
    
    Service->>PromptMgr: 7. 프롬프트 생성 요청<br/>generate_image_prompt(input_text)
    PromptMgr->>GPT: 8. API 호출<br/>"카페 신메뉴 홍보를 태그로"
    GPT-->>PromptMgr: 9. 태그 반환<br/>"cafe, new menu, warm, cozy, ..."
    PromptMgr-->>Service: 10. 이미지 프롬프트
    
    Service->>PromptMgr: 11. 광고 문구 요청<br/>generate_ad_copy(input_text)
    PromptMgr->>GPT: 12. API 호출<br/>"광고 문구 생성"
    GPT-->>PromptMgr: 13. 문구 반환<br/>"따뜻한 겨울, 새로운 맛"
    PromptMgr-->>Service: 14. 광고 문구
    
    Service->>ImgGen: 15. 이미지 생성 요청<br/>generate(prompt, aspect_ratio)
    ImgGen->>SDXL: 16. 모델 추론 실행<br/>(30-60초 소요)
    SDXL-->>ImgGen: 17. PIL Image 객체
    ImgGen->>ImgGen: 18. 후처리<br/>(리사이징, 압축, 텍스트 오버레이)
    ImgGen-->>Service: 19. 이미지 경로 + 메타데이터<br/>{path, seed, style}
    
    Service->>Storage: 20. 파일 저장<br/>save_image(image_path, user_id)
    Storage->>Storage: 21. 파일 해시 계산<br/>SHA-256
    Storage->>Storage: 22. 파일 복사<br/>/data/images/generated/...
    Storage-->>Service: 23. 저장 경로 반환
    
    Service->>DB: 24. 생성 이력 저장<br/>save_generation_history()
    DB-->>Service: 25. 저장 완료 (ID)
    
    Service->>DB: 26. 챗봇 대화 저장<br/>save_chat_message() x2
    DB-->>Service: 27. 저장 완료
    
    Service->>API: 28. Task 상태 업데이트<br/>status="completed"
    
    loop 상태 확인 (1초마다)
        Frontend->>API: 29. GET /status/{task_id}
        API-->>Frontend: 30. 상태 응답<br/>{status: "processing"}
    end
    
    Frontend->>API: 31. GET /status/{task_id}
    API-->>Frontend: 32. 완료 응답<br/>{status: "completed", result: {...}}
    
    Frontend->>Frontend: 33. 결과 렌더링<br/>이미지 표시 + 광고 문구
    Frontend->>User: 34. 생성 완료 표시
```

### 4.2 회원가입 플로우

```mermaid
sequenceDiagram
    actor User as 사용자
    participant Frontend as 프론트엔드
    participant API as 백엔드 API
    participant Service as services.py
    participant Validator as validators.py
    participant DB as PostgreSQL

    User->>Frontend: 1. 회원가입 폼 작성<br/>{login_id, login_pw}
    Frontend->>Frontend: 2. 클라이언트 유효성 검증<br/>(길이, 형식)
    
    Frontend->>API: 3. POST /auth/signup<br/>{login_id, login_pw}
    API->>Validator: 4. 서버 유효성 검증
    Validator-->>API: 5. 검증 통과
    
    API->>Service: 6. register_user(login_id, login_pw)
    Service->>DB: 7. 중복 확인<br/>check_duplicate_id(login_id)
    
    alt ID 중복
        DB-->>Service: 8a. COUNT > 0
        Service-->>API: 9a. 중복 에러 반환
        API-->>Frontend: 10a. {success: false, error: "ID 중복"}
        Frontend->>User: 11a. 에러 메시지 표시
    else ID 사용 가능
        DB-->>Service: 8b. COUNT = 0
        Service->>Service: 9b. 비밀번호 해시<br/>bcrypt.hashpw()
        Service->>DB: 10b. 사용자 생성<br/>create_user(login_id, hash)
        DB-->>Service: 11b. user_id 반환
        Service-->>API: 12b. 성공 응답
        API-->>Frontend: 13b. {success: true, user_id}
        Frontend->>User: 14b. "회원가입 완료" 메시지
        Frontend->>Frontend: 15b. 로그인 폼으로 전환
    end
```

### 4.3 로그인 플로우

```mermaid
sequenceDiagram
    actor User as 사용자
    participant Frontend as 프론트엔드
    participant API as 백엔드 API
    participant Service as services.py
    participant DB as PostgreSQL

    User->>Frontend: 1. 로그인 폼 작성<br/>{login_id, login_pw}
    Frontend->>API: 2. POST /auth/login<br/>{login_id, login_pw}
    
    API->>Service: 3. authenticate_user(login_id, login_pw)
    Service->>DB: 4. 사용자 조회<br/>get_user_by_login_id(login_id)
    
    alt 사용자 없음
        DB-->>Service: 5a. NULL
        Service-->>API: 6a. 인증 실패
        API-->>Frontend: 7a. {success: false, error: "계정 없음"}
        Frontend->>User: 8a. "ID 또는 비밀번호 오류" 표시
    else 사용자 존재
        DB-->>Service: 5b. {user_id, hashed_pw}
        Service->>Service: 6b. 비밀번호 검증<br/>bcrypt.checkpw()
        
        alt 비밀번호 불일치
            Service-->>API: 7b1. 인증 실패
            API-->>Frontend: 8b1. {success: false}
            Frontend->>User: 9b1. 에러 메시지
        else 비밀번호 일치
            Service->>Service: 7b2. JWT 토큰 생성<br/>jwt.encode({user_id, exp})
            Service-->>API: 8b2. 성공 응답 + 토큰
            API-->>Frontend: 9b2. {success: true, user_id, session_token}
            Frontend->>Frontend: 10b2. 토큰 저장<br/>localStorage.setItem()
            Frontend->>Frontend: 11b2. 로그인 상태 업데이트<br/>isLoggedIn = true
            Frontend->>User: 12b2. 메인 화면으로 이동
        end
    end
```

### 4.4 생성 이력 조회 플로우

```mermaid
sequenceDiagram
    actor User as 사용자
    participant Frontend as 프론트엔드
    participant API as 백엔드 API
    participant Service as services.py
    participant DB as PostgreSQL
    participant Storage as 파일 저장소

    User->>Frontend: 1. 이력 조회 페이지 접근
    Frontend->>Frontend: 2. 로그인 상태 확인<br/>sessionToken 존재?
    
    Frontend->>API: 3. GET /history/generation<br/>?user_id={user_id}
    
    API->>Service: 4. get_generation_history(user_id)
    Service->>DB: 5. SQL 쿼리 실행<br/>SELECT * WHERE user_id=...
    DB-->>Service: 6. 이력 데이터 반환<br/>[{id, output_url, created_at, ...}]
    Service-->>API: 7. 데이터 전달
    API-->>Frontend: 8. JSON 응답<br/>[{id, output_url, ...}]
    
    Frontend->>Frontend: 9. 썸네일 그리드 렌더링
    
    loop 각 이미지에 대해
        Frontend->>Storage: 10. GET /static/images/{path}
        Storage-->>Frontend: 11. 이미지 파일 반환
    end
    
    Frontend->>User: 12. 이력 목록 표시
    
    User->>Frontend: 13. 특정 이미지 클릭
    Frontend->>Frontend: 14. 모달 표시<br/>(원본 이미지 + 상세 정보)
```

### 4.5 에러 처리 플로우

```mermaid
sequenceDiagram
    participant Frontend as 프론트엔드
    participant API as 백엔드 API
    participant Service as services.py
    participant ImgGen as 이미지 생성

    Frontend->>API: 1. POST /generate
    API->>Service: 2. create_advertisement()
    Service->>ImgGen: 3. generate()
    
    alt GPU 메모리 부족
        ImgGen->>ImgGen: 4a. torch.cuda.OutOfMemoryError
        ImgGen->>ImgGen: 5a. GPU 캐시 정리
        ImgGen->>ImgGen: 6a. 재시도 (1회)
        
        alt 재시도 성공
            ImgGen-->>Service: 7a1. 이미지 반환
        else 재시도 실패
            ImgGen-->>Service: 7a2. 에러 발생
            Service->>Service: 8a2. Task 상태 = "failed"
            Service->>Service: 9a2. 에러 로그 기록
        end
    else 타임아웃 (60초 초과)
        ImgGen->>ImgGen: 4b. 시간 초과
        ImgGen-->>Service: 5b. TimeoutError
        Service->>Service: 6b. Task 상태 = "failed"
    else GPT API 호출 실패
        Service->>Service: 4c. OpenAI API Error
        Service->>Service: 5c. 재시도 (최대 3회)
        
        alt 재시도 성공
            Service->>Service: 6c1. 계속 진행
        else 재시도 실패
            Service->>Service: 6c2. Task 상태 = "failed"
        end
    end
    
    Frontend->>API: N. GET /status/{task_id}
    API-->>Frontend: N+1. {status: "failed", error: "..."}
    Frontend->>Frontend: N+2. 에러 메시지 표시
```

---

## 5. 데이터베이스 설계

### 5.1 ERD (Entity Relationship Diagram)

```
┌─────────────────────┐
│       user          │
├─────────────────────┤
│ user_id (PK)        │◄─────┐
│ login_id (UNIQUE)   │      │
│ login_pw            │      │
│ created_at          │      │
└─────────────────────┘      │
                             │ FK
                             │
┌────────────────────────────┴───────────────────────────┐
│                generation_history                      │
├────────────────────────────────────────────────────────┤
│ id (PK)                                                │
│ user_id (FK) → user.user_id (NULL 허용)                │
│ input_text                                             │
│ input_image_hash                                       │
│ content_type                                           │
│ output_hash                                            │
│ generation_method                                      │
│ style                                                  │
│ industry                                               │
│ seed                                                   │
│ aspect_ratio                                           │
│ created_at                                             │
└────────────────────────────────────────────────────────┘
                              │
                              │ FK
                              │
┌─────────────────────────────┴──────────────────────────┐
│                  chat_history                          │
├────────────────────────────────────────────────────────┤
│ id (PK)                                                │
│ user_id (FK) → user.user_id (NULL 허용)                │
│ session_id                                             │
│ message_id                                             │
│ role                                                   │
│ content                                                │
│ input_image_hash                                       │
│ gen_image_hash                                         │
│ created_at                                             │
└────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────┐
│                 image_matching                         │
├────────────────────────────────────────────────────────┤
│ id (PK)                                                │
│ file_hash (UNIQUE)                                     │
│ file_directory                                         │
│ file_type (사용자 입력 / AI 생성 이미지 구분 )           │
│ created_at                                             │
└────────────────────────────────────────────────────────┘
```

### 5.2 테이블 스키마 (상세)

#### 5.2.1 user (사용자 정보)

```sql
CREATE TABLE "user" (
    user_id SERIAL PRIMARY KEY,
    login_id VARCHAR(50) UNIQUE NOT NULL,
    login_pw VARCHAR(255) NOT NULL,  -- bcrypt 해시 저장
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_user_login_id ON "user"(login_id);
```

#### 5.2.2 generation_history (광고 생성 이력)

```sql
CREATE TABLE generation_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES "user"(user_id) ON DELETE SET NULL,
    input_text TEXT NOT NULL,
    input_image_hash VARCHAR(64),  -- SHA-256 (2단계)
    content_type VARCHAR(10) CHECK (content_type IN ('image', 'text', 'both')),
    output_url TEXT,  -- 상대 경로: "generated_images/1/2026-01-10_abc.png"
    generation_method VARCHAR(20) CHECK (generation_method IN ('t2i', 'controlnet')),
    style TEXT,  -- "warm, cozy, cafe" 등 태그 저장
    industry VARCHAR(50),  -- "cafe", "restaurant" 등
    seed INTEGER,  -- 이미지 생성 시드
    aspect_ratio VARCHAR(10) CHECK (aspect_ratio IN ('1:1', '4:3', '3:4')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_gen_user_id ON generation_history(user_id);
CREATE INDEX idx_gen_created_at ON generation_history(created_at DESC);
```

#### 5.2.3 chat_history (챗봇 대화 이력)

```sql
CREATE TABLE chat_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES "user"(user_id) ON DELETE SET NULL,
    session_id VARCHAR(64) NOT NULL,  -- UUID v4
    message_id INTEGER NOT NULL,  -- 세션 내 메시지 순서
    role VARCHAR(10) CHECK (role IN ('user', 'assistant')) NOT NULL,
    content TEXT NOT NULL,
    input_image_hash VARCHAR(64),  -- 사용자가 입력한 이미지 (2단계)
    gen_image_url TEXT,  -- assistant가 생성한 이미지
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_chat_user_session ON chat_history(user_id, session_id);
CREATE INDEX idx_chat_session ON chat_history(session_id);
```

#### 5.2.4 image_matching (이미지 파일 매칭)

```sql
CREATE TABLE image_matching (
    id SERIAL PRIMARY KEY,
    file_hash VARCHAR(64) UNIQUE NOT NULL,  -- SHA-256
    file_directory TEXT NOT NULL,  -- "generated_images/1/2026-01-10_abc.png"
    file_type VARCHAR(10) CHECK (file_type IN ('input', 'generated')) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스
CREATE INDEX idx_img_file_hash ON image_matching(file_hash);
```

### 5.3 데이터 흐름 예시

**광고 생성 시 DB 저장 순서**:

1. **이미지 파일 저장**
   ```python
   file_hash = calculate_hash(image_file)
   file_path = f"generated_images/{user_id}/{timestamp}_{file_hash}.png"
   save_to_disk(image_file, file_path)
   ```

2. **image_matching 테이블 삽입**
   ```sql
   INSERT INTO image_matching (file_hash, file_directory, file_type)
   VALUES ('abc123...', 'generated_images/1/...', 'generated');
   ```

3. **generation_history 테이블 삽입**
   ```sql
   INSERT INTO generation_history (
       user_id, input_text, content_type, output_url,
       generation_method, style, seed, aspect_ratio
   ) VALUES (
       1, '카페 신메뉴 홍보', 'image', 'generated_images/1/...',
       't2i', 'warm, cozy, cafe', 12345, '3:4'
   );
   ```

4. **chat_history 테이블 삽입** (2개 레코드)
   ```sql
   -- 사용자 메시지
   INSERT INTO chat_history (user_id, session_id, message_id, role, content)
   VALUES (1, 'session-uuid', 1, 'user', '카페 신메뉴 홍보');
   
   -- AI 응답
   INSERT INTO chat_history (user_id, session_id, message_id, role, content, gen_image_url)
   VALUES (1, 'session-uuid', 2, 'assistant', '따뜻한 겨울, 새로운 맛', 'generated_images/1/...');
   ```

---

## 6. 개발 단계별 기능

### 6.1 1단계 (MVP): ~ 2026-01-15

#### 6.1.1 프론트엔드 (Svelte)
✅ **필수 구현**:
- [ ] 챗봇 UI (텍스트 입력, 비율 선택, 결과 표시)
- [ ] 회원가입/로그인 UI
- [ ] 생성 이력 조회 UI (썸네일 그리드)
- [ ] 로딩 상태 표시 (Spinner)
- [ ] 기본 반응형 레이아웃

#### 6.1.2 백엔드 API (FastAPI)
✅ **필수 구현**:
- [ ] POST /generate (광고 생성 요청)
- [ ] GET /status/{task_id} (작업 상태 조회)
- [ ] POST /auth/signup (회원가입)
- [ ] POST /auth/login (로그인)
- [ ] GET /history/generation (생성 이력 조회)
- [ ] GET /static/images/{path} (이미지 파일 서빙)

#### 6.1.3 비즈니스 로직
✅ **필수 구현**:
- [ ] create_advertisement() 워크플로우
- [ ] register_user() / authenticate_user()
- [ ] Task 상태 관리 (메모리 기반)

#### 6.1.4 AI 모델
✅ **필수 구현**:
- [ ] SDXL t2i 기본 생성
- [ ] GPT API 프롬프트 생성 (이미지용)
- [ ] GPT API 광고 문구 생성
- [ ] 후처리 (리사이징, 압축, 텍스트 오버레이)

#### 6.1.5 데이터베이스
✅ **필수 구현**:
- [ ] user, generation_history 테이블
- [ ] image_matching 테이블
- [ ] 기본 CRUD 함수

#### 6.1.6 인프라
✅ **필수 구현**:
- [ ] GCP VM PostgreSQL 설치
- [ ] FastAPI 서버 실행
- [ ] 로컬 파일 저장소 (/storage)
- [ ] 기본 로깅 설정

### 6.2 2단계 (개선): 2026-01-16 ~ 27

#### 6.2.1 프론트엔드
⏳ **개선 항목**:
- [ ] 채팅 이력 UI (세션별 관리)
- [ ] 브랜드 설정 UI (Sidebar)
- [ ] UI/UX 고도화 (애니메이션, 트랜지션)
- [ ] 모바일 최적화
- [ ] 에러 메시지 개선 (Toast 알림)

#### 6.2.2 백엔드 API
⏳ **개선 항목**:
- [ ] GET /history/chat/sessions (채팅 세션 목록)
- [ ] GET /history/chat (세션별 대화 이력)
- [ ] POST /upload (로고 이미지 업로드)
- [ ] 에러 처리 고도화

#### 6.2.3 비즈니스 로직
⏳ **개선 항목**:
- [ ] 채팅 세션 관리
- [ ] 이미지 업로드 처리
- [ ] 캐싱 시스템 (Redis 또는 메모리)

#### 6.2.4 AI 모델
⏳ **개선 항목**:
- [ ] Flux.1 모델 지원 (고품질 옵션)
- [ ] ControlNet (로고 이미지 반영)
- [ ] 모델 자동 선택 로직
- [ ] 네거티브 프롬프트

#### 6.2.5 데이터베이스
⏳ **개선 항목**:
- [ ] chat_history 테이블 활용
- [ ] 인덱스 최적화
- [ ] DB 백업 스크립트

#### 6.2.6 인프라
⏳ **개선 항목**:
- [ ] Docker 컨테이너화
- [ ] systemd 서비스 등록 (자동 시작)
- [ ] 모니터링 (로그 분석)
- [ ] 성능 테스트 및 최적화

---

## 7. 보안 및 성능 고려사항

### 7.1 보안
- **비밀번호**: bcrypt 해시 저장 (cost factor: 12)
- **세션**: JWT 토큰 (만료: 7일, Secret Key 환경 변수 관리)
- **API 키**: .env 파일로 관리, Git에 커밋 금지
- **CORS**: 프론트엔드 도메인만 허용
- **PostgreSQL**: 로컬 접속만 허용 (외부 포트 차단)
- **파일 업로드**: 파일 타입 검증, 크기 제한 (10MB)

### 7.2 성능
- **비동기 처리**: AI 모델 호출은 백그라운드 작업
- **이미지 압축**: JPEG 품질 85, 파일 크기 < 2MB
- **DB 연결 풀**: 최대 20개 연결
- **정적 파일**: FastAPI StaticFiles로 캐싱 활용
- **GPU 최적화**: torch.cuda.empty_cache() 주기적 호출

### 7.3 확장성
- **1단계**: 단일 VM 환경 (동시 사용자 10명 이하)
- **2단계 이후**: 
  - AI 모델 서버 분리 (별도 GPU VM)
  - Redis 캐싱 도입
  - Cloud SQL 마이그레이션 (고가용성)

---

## 8. 배포 전략

### 8.1 1단계 배포 (MVP)
```
[프론트엔드]
- Vercel: Git push 시 자동 배포
- 환경 변수: VITE_API_URL=http://{GCP_VM_IP}:8000

[백엔드]
- GCP VM: 수동 배포
- 실행: tmux 세션에서 uvicorn 실행
- 외부 접속: 방화벽 규칙 설정 (포트 8000)
```

### 8.2 2단계 배포 (개선)
```
[프론트엔드]
- 동일 (Vercel)

[백엔드]
- systemd 서비스 등록
- 자동 재시작 설정
- 로그 로테이션
```

---

## 9. 리스크 및 대응

| 리스크 | 확률 | 영향 | 대응 방안 |
|--------|------|------|----------|
| AI 모델 생성 시간 초과 | 높음 | 높음 | 타임아웃 60초, 사용자에게 예상 시간 안내 |
| GPU 메모리 부족 | 중간 | 높음 | 캐시 정리, 재시도 로직, CPU 폴백 |
| GPT API 비용 초과 | 중간 | 중간 | 프롬프트 길이 제한, 요청 횟수 모니터링 |
| VM 디스크 용량 부족 | 낮음 | 중간 | 영구 디스크 추가, 오래된 이미지 삭제 |
| PostgreSQL 동시 접속 | 낮음 | 낮음 | 연결 풀 설정 |

---

## 부록: 기술 스택 상세

### A.1 프론트엔드 (Svelte)
- **버전**: Svelte 4.x
- **빌드 도구**: Vite
- **상태 관리**: Svelte stores
- **HTTP 클라이언트**: fetch API
- **스타일**: Tailwind CSS (선택)

### A.2 백엔드 (FastAPI)
- **버전**: FastAPI 0.100+
- **ASGI 서버**: uvicorn
- **검증**: Pydantic v2
- **인증**: PyJWT
- **비밀번호**: bcrypt

### A.3 AI 모델
- **이미지 생성**: 
  - SDXL: `stabilityai/stable-diffusion-xl-base-1.0`
  - Diffusers 0.20+
  - PyTorch 2.0+
- **텍스트 생성**: 
  - OpenAI API: gpt-4o-mini
  - openai 1.0+

### A.4 데이터베이스
- **PostgreSQL**: 15.x
- **Python 드라이버**: psycopg2-binary 또는 asyncpg

### A.5 유틸리티
- **이미지 처리**: Pillow (PIL)
- **파일 해시**: hashlib (내장)
- **로깅**: logging (내장)

---

**문서 버전**: 2.1
**최종 수정**: 2026-01-05
**작성자**: 신승목