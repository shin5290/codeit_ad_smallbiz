# 시스템 아키텍처 설계서
## 소상공인 광고 콘텐츠 생성 서비스

**작성일**: 2026-01-27
**프로젝트 기간**: 2025-12-29 ~ 2026-01-28 (4주)
**버전**: 4.0

---

## 목차
1. [시스템 개요](#1-시스템-개요)
2. [전체 시스템 아키텍처](#2-전체-시스템-아키텍처)
3. [핵심 모듈 상세](#3-핵심-모듈-상세)
4. [데이터베이스 설계](#4-데이터베이스-설계)
5. [API 엔드포인트](#5-api-엔드포인트)
6. [핵심 플로우](#6-핵심-플로우)
7. [부록: 디렉토리 구조](#부록-디렉토리-구조)

---

## 1. 시스템 개요

### 1.1 서비스 목적
소상공인이 생성형 AI 기술을 활용하여 **업종 제약 없이** 광고 이미지와 마케팅 문구를 손쉽게 제작할 수 있는 웹 기반 서비스

### 1.2 핵심 기능

**RAG 기반 대화형 챗봇**
- Intent 분석: generation / modification / consulting 분류
- 플랫폼별 자동 비율 결정 (Instagram, YouTube, Story 등)
- 스타일 자동 감지 (ultra_realistic, semi_realistic, anime)
- 수정 강도(strength) 자동 결정
- SSE 스트리밍 응답

**AI 광고 이미지 생성**
- Z-Image Turbo 모델 기반 고속 생성 (~1-2초, 8 steps)
- Text-to-Image (T2I) 및 Image-to-Image (I2I) 지원
- LoRA를 통한 스타일 전환
- 한글 입력 → GPT → 영어 프롬프트 자동 변환

**AI 광고 문구 생성**
- GPT-4o-mini 기반 맞춤형 마케팅 카피
- 톤 앤 매너: warm, professional, friendly, energetic
- 길이 조절: 10~200자

**사용자 인증**
- JWT 기반 인증 (HttpOnly 쿠키)
- bcrypt 비밀번호 해싱

### 1.3 주요 사용자
- **주 타겟**: 소상공인 (카페, 식당, 소매점, 서비스업 등)
- **비회원**: 광고 생성 가능 (이력 미저장)
- **회원**: 세션별 이력 관리 및 재사용 가능

---

## 2. 전체 시스템 아키텍처

### 2.1 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                    사용자 (웹 브라우저)                       │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTPS
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   프론트엔드 (Svelte)                        │
│  - Vercel 자동 배포                                          │
│  - 챗봇 UI, SSE 스트리밍 수신                                │
│  - 회원가입/로그인 UI                                        │
│  - 생성 이력 조회                                            │
│  - 관리자 대시보드 (admin.html)                              │
└────────────────────────┬────────────────────────────────────┘
                         │ REST API + SSE (JSON)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              GCP VM 인스턴스 (g2-standard-4)                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         FastAPI Backend (main.py)                    │   │
│  │  - 포트: 8000                                         │   │
│  │  - Lifespan: DB 초기화, 모델/RAG Preload             │   │
│  └──────────────┬───────────────────────────────────────┘   │
│                 │                                           │
│                 ▼                                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │        API 라우터 레이어 (routers/)                   │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  auth.py: /auth/*                              │  │   │
│  │  │  - 회원가입, 로그인/로그아웃, 회원정보 관리     │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  chat.py: /chat/*                              │  │   │
│  │  │  - 챗봇 메시지 스트리밍, 세션/히스토리 관리     │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  admin.py: /admin/*                            │  │   │
│  │  │  - 사용자 관리, 생성 이력 조회 (관리자 전용)    │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  └──────────────┬───────────────────────────────────────┘   │
│                 │                                           │
│                 ▼                                           │
│  ┌──────────────────────────────────────────────────────┐   │
│  │        비즈니스 로직 레이어                           │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  services.py                                   │  │   │
│  │  │  - 인증: register_user, authenticate_user      │  │   │
│  │  │  - 생성: generate_contents, persist_generation │  │   │
│  │  │  - 스트림: handle_chat_message_stream          │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  chatbot.py (RAG 챗봇)                         │  │   │
│  │  │  - ConversationManager: 대화 히스토리 관리      │  │   │
│  │  │  - LLMOrchestrator: Intent 분석, Refinement    │  │   │
│  │  │  - ConsultingService: 상담 응답 스트리밍        │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  process_db.py                                 │  │   │
│  │  │  - User, ChatSession, ChatHistory CRUD         │  │   │
│  │  │  - GenerationHistory, ImageMatching CRUD       │  │   │
│  │  │  - Admin: list_users, delete_users_by_ids      │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  └──────┬───────────────────┬───────────────────────────┘   │
│         │                   │                               │
│         ▼                   ▼                               │
│  ┌─────────────────┐ ┌─────────────────────────────────┐    │
│  │ Text Generation │ │ Image Generation                │    │
│  │ (GPT-4o-mini)   │ │ (Z-Image Turbo)                 │    │
│  │                 │ │                                 │    │
│  │ text_generator  │ │ generator.py → workflow.py     │    │
│  │   .py           │ │   → nodes/text2image.py        │    │
│  │                 │ │   → nodes/image2image.py       │    │
│  │                 │ │   → prompt/prompt_manager.py   │    │
│  └─────────────────┘ └─────────────────────────────────┘    │
│         │                   │                               │
│         └─────────┬─────────┘                               │
│                   ▼                                         │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         Preload Layer                                │   │
│  │  - preload.py: 이미지 생성 모델 GPU 사전 로딩        │   │
│  │  - rag_preload.py: RAG 벡터스토어/임베딩 사전 로딩   │   │
│  └──────────────────────────────────────────────────────┘   │
│                   │                                         │
│  ┌────────────────▼─────────────────────────────────────┐   │
│  │         Data Layer                                   │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  PostgreSQL (adbizdb)                          │  │   │
│  │  │  - User (is_admin 포함)                        │  │   │
│  │  │  - ChatSession, ChatHistory                    │  │   │
│  │  │  - GenerationHistory, ImageMatching            │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  │  ┌────────────────────────────────────────────────┐  │   │
│  │  │  File Storage (data/)                          │  │   │
│  │  │  - generated/ (생성된 이미지)                   │  │   │
│  │  │  - uploads/ (업로드된 이미지)                   │  │   │
│  │  └────────────────────────────────────────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 기술 스택

| 레이어 | 기술 | 비고 |
|--------|------|------|
| **프론트엔드** | Svelte 4.x, Vite | Vercel 배포 |
| **백엔드 API** | FastAPI 0.104+ | Uvicorn ASGI |
| **인증** | JWT (python-jose), bcrypt | HttpOnly 쿠키 |
| **이미지 생성** | Z-Image Turbo, Diffusers | 8 steps, LoRA |
| **텍스트 생성** | OpenAI GPT-4o-mini | 프롬프트/문구 생성 |
| **데이터베이스** | PostgreSQL 15, SQLAlchemy 2.0+ | Alembic 마이그레이션 |
| **파일 저장소** | 로컬 파일 시스템 | data/ 디렉토리 |

### 2.3 GCP VM 사양

- **머신 타입**: g2-standard-4 (vCPU 4개, 메모리 16GB)
- **GPU**: 1x NVIDIA L4 (24GB VRAM)
- **부팅 디스크**: Ubuntu 22.04, 200GB

---

## 3. 핵심 모듈 상세

### 3.1 main.py (FastAPI 진입점)

```python
# 라이프사이클 관리
@asynccontextmanager
async def lifespan(app: FastAPI):
    process_db.init_db()                    # DB 초기화
    start_model_preload(device="cuda")      # 이미지 생성 모델 GPU Preload
    start_rag_preload()                     # 상담 RAG 벡터스토어 Preload
    yield

# 라우터 등록
app.include_router(admin.router)  # /admin/*
app.include_router(auth.router)   # /auth/*
app.include_router(chat.router)   # /chat/*

# 주요 엔드포인트
@app.get("/")                     # 메인 페이지 (main.html)
@app.get("/admin")                # 관리자 페이지 (admin.html, 관리자 전용)
@app.get("/images/{file_hash}")   # 이미지 서빙 (썸네일 지원)
```

### 3.2 services.py (비즈니스 로직)

**핵심 함수**:
- `get_current_user()`: JWT 토큰에서 현재 사용자 추출
- `register_user()`: 회원가입 처리
- `authenticate_user()`: 로그인 및 쿠키 설정
- `ingest_user_message()`: 입력 수집/저장 레이어
- `generate_contents()`: 콘텐츠 생성 (text/image)
- `persist_generation_result()`: 생성 결과 DB 저장
- `handle_chat_message_stream()`: RAG 챗봇 스트리밍 처리
- `handle_chat_revise()`: 광고 수정 요청 처리

**데이터 클래스**:
```python
@dataclass
class IngestResult:
    session_id: str
    chat_history_id: int
    input_image: Optional[dict]

@dataclass
class GeneratedContent:
    content_type: str           # "text" | "image"
    input_text: str
    input_image: Optional[dict]
    output_text: Optional[str]
    output_image: Optional[dict]
    prompt: Optional[str]
    generation_method: Optional[str]
    style: Optional[str]
    industry: Optional[str]
    seed: Optional[int]
    aspect_ratio: Optional[str]
    strength: Optional[float]
```

### 3.3 chatbot.py (RAG 챗봇)

**ConversationManager**
- DB 접근 레이어
- 대화/생성 이력 CRUD

**LLMOrchestrator**
- `analyze_intent()`: 의도 분석 + 생성 파라미터 자동 결정
  - Intent: generation / modification / consulting
  - 플랫폼 감지: Instagram, YouTube, Story 등 → 비율 자동 결정
  - 스타일 감지: ultra_realistic, semi_realistic, anime
  - 수정 강도 감지: strength 0.3~0.95
  - 텍스트 톤/길이 감지
- `refine_generation_input()`: 전체 맥락 반영 입력 정제 + 수정 대상 ID 탐색
- `stream_consulting_response()`: 상담 응답 스트리밍

**ConsultingService**
- 상담 전용 비즈니스 로직
- Knowledge Base 검색 (선택적)

### 3.4 image_generation/generator.py

**Z-Image Turbo 특징**:
- 8 steps로 고품질 이미지 생성 (~1-2초)
- 긴 프롬프트 지원 (CLIP 77 토큰 제한 없음, T5 기반)
- LoRA를 통한 스타일 전환
- Negative Prompt 미지원 (CFG 미사용)

**핵심 함수**:
```python
def generate_and_save_image(
    user_input: str,                    # 한글 사용자 입력
    style: str = "realistic",           # ultra_realistic, semi_realistic, anime
    aspect_ratio: str = "1:1",          # 1:1, 3:4, 4:3, 16:9, 9:16
    industry: Optional[str] = None,     # cafe, restaurant, retail, service
    num_inference_steps: int = 8,       # Z-Image Turbo 기본값
    seed: Optional[int] = None,
    reference_image: Optional[Image] = None,  # I2I용
    strength: float = 0.6,              # I2I 변형 강도
) -> Dict[str, Any]:
    """
    한글 입력 → GPT → 영어 프롬프트 → Z-Image Turbo → 이미지 저장

    Returns:
        {
            "success": bool,
            "image_path": str,
            "filename": str (SHA-256 해시),
            "width": int,
            "height": int,
            "style": str,
            "seed": int,
            "generation_time": float,
            "prompt": str,
            "error": str or None
        }
    """
```

**워크플로우**:
1. PromptTemplateManager → GPT로 한글→영어 프롬프트 변환
2. ImageGenerationWorkflow 구성
   - T2I: Text2ImageNode
   - I2I: Image2ImageNode
3. 이미지 생성 실행
4. SHA-256 해시 기반 파일명 생성 및 저장

### 3.5 text_generation/text_generator.py

```python
class TextGenerator:
    def generate_ad_copy(
        self,
        user_input: str,        # 사용자 요청 텍스트
        tone: str = "warm",     # warm, professional, friendly, energetic
        max_length: int = 100   # 최대 글자 수
    ) -> str:
        """
        GPT-4o-mini 기반 광고 문구 생성
        """
```

### 3.6 utils/ (유틸리티)

**config.py**
```python
class Settings(BaseSettings):
    DATABASE_URL: str
    OPENAI_API_KEY: Optional[str]
    JWT_SECRET_KEY: Optional[str]
    JWT_ALGO: str = "HS256"
    JWT_EXPIRE_MINUTES: int = 60
```

**security.py**
- `hash_password()`: bcrypt 해시
- `verify_password()`: 비밀번호 검증
- `create_access_token()`: JWT 생성
- `decode_token()`: JWT 디코딩

**session.py**
- `normalize_session_id()`: 세션 ID 정규화
- `ensure_chat_session()`: 세션 확보/생성/귀속
- `resolve_session_id()`: 세션 ID 조회/생성

**image.py**
- `save_uploaded_image()`: 업로드 이미지 저장 (SHA-256 해시)
- `load_image_from_payload()`: 파일 경로 → PIL Image
- `get_image_file_response()`: 이미지 서빙 (썸네일 지원)

**logging.py**
- `setup_logging()`: 로깅 설정 초기화
- `get_logger()`: 모듈별 로거 획득

### 3.7 routers/ (API 라우터)

**auth.py** (`/auth` prefix)
- `GET /me`: 현재 로그인 사용자 정보 (is_admin 포함)
- `POST /signup`: 회원가입
- `POST /login`: 로그인 (OAuth2PasswordRequestForm)
- `POST /logout`: 로그아웃 (쿠키 삭제)
- `PUT /user`: 회원정보 수정
- `DELETE /user`: 회원 탈퇴

**chat.py** (`/chat` prefix)
- `POST /message/stream`: 챗봇 메시지 SSE 스트리밍
- `POST /session`: 세션 조회/생성
- `GET /history`: 유저 대화 히스토리 (커서 기반 페이징)
- `GET /history/{session_id}`: 세션별 대화 히스토리
- `GET /generation/{session_id}`: 세션별 생성 이력

**admin.py** (`/admin` prefix, 관리자 전용)
- `require_admin()`: 관리자 권한 검증 의존성
- `GET /users`: 사용자 목록 조회 (필터링/페이징)
- `POST /users/delete`: 사용자 일괄 삭제
- `GET /generations`: 생성 이력 조회 (필터링/페이징)

### 3.8 generation/chat_bot/ (RAG 챗봇 모듈)

**데이터 파이프라인**:
- `01_crawl_naver.py`: 네이버 광고 정보 크롤링
- `02_split_data.py`: 크롤링 데이터 분할
- `03_build_documents_v5.py`: LangChain Document 빌드
- `06_build_vectorstore.py`: 벡터스토어 구축

**RAG 핵심 모듈**:
- `rag/chain.py`: RAG 체인 구성
- `rag/knowledge_base.py`: 지식베이스 관리
- `rag/prompts.py`: RAG 프롬프트 템플릿

**평가 모듈**:
- `evaluation/04_evaluate_embeddings.py`: 임베딩 모델 평가
- `evaluation/05_evaluate_reranker.py`: 리랭커 평가
- `evaluation/evaluate_prompts.py`: 프롬프트 평가

---

## 4. 데이터베이스 설계

### 4.1 ERD (Entity Relationship Diagram)

```
┌─────────────────────┐
│       user          │
├─────────────────────┤
│ user_id (PK)        │◄───────┐
│ login_id (UNIQUE)   │        │
│ login_pw            │        │ FK
│ name                │        │
│ is_admin            │        │
│ created_at          │        │
└─────────────────────┘        │
                               │
                     ┌─────────┴────────┐
                     │                  │
                     ▼                  │
       ┌──────────────────────┐        │
       │    chat_session      │        │
       ├──────────────────────┤        │
       │ session_id (PK)      │◄───────┼───────┐
       │ user_id (FK, NULL)   │        │       │
       │ created_at           │        │       │ FK
       └──────────────────────┘        │       │
                 │                     │       │
           ┌─────┴─────┐               │       │
           │ FK        │ FK            │       │
           ▼           ▼               │       │
   ┌───────────────┐   ┌─────────────────────────────┐
   │ chat_history  │   │   generation_history        │
   ├───────────────┤   ├─────────────────────────────┤
   │ id (PK)       │   │ id (PK)                     │
   │ session_id    │   │ session_id (FK)             │
   │ role          │   │ content_type                │
   │ content       │   │ input_text                  │
   │ image_id (FK) │─┐ │ output_text                 │
   │ created_at    │ │ │ prompt                      │
   └───────────────┘ │ │ input_image_id (FK) ──┐     │
                     │ │ output_image_id (FK) ─┼─┐   │
                     │ │ generation_method      │ │   │
                     │ │ style                  │ │   │
                     │ │ industry               │ │   │
                     │ │ seed                   │ │   │
                     │ │ strength               │ │   │
                     │ │ aspect_ratio           │ │   │
                     │ │ created_at             │ │   │
                     │ └─────────────────────────┘ │   │
                     │                             │   │
                     └────┬────────────────────────┘   │
                          │                            │
                          ▼                            │
              ┌────────────────────────┐               │
              │   image_matching       │◄──────────────┘
              ├────────────────────────┤
              │ id (PK)                │
              │ file_hash (UNIQUE)     │
              │ file_directory         │
              │ created_at             │
              └────────────────────────┘
```

### 4.2 테이블 상세

#### user
```sql
CREATE TABLE "user" (
    user_id SERIAL PRIMARY KEY,
    login_id VARCHAR(50) UNIQUE NOT NULL,
    login_pw VARCHAR(255) NOT NULL,  -- bcrypt 해시
    name VARCHAR(50) NOT NULL,
    is_admin BOOLEAN NOT NULL DEFAULT FALSE,  -- 관리자 권한
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### chat_session
```sql
CREATE TABLE chat_session (
    session_id VARCHAR(100) PRIMARY KEY,
    user_id INTEGER REFERENCES "user"(user_id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### chat_history
```sql
CREATE TABLE chat_history (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(100) REFERENCES chat_session(session_id) ON DELETE RESTRICT NOT NULL,
    role VARCHAR(20) NOT NULL,  -- 'user' | 'assistant'
    content TEXT NOT NULL,
    image_id INTEGER REFERENCES image_matching(id) ON DELETE SET NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### generation_history
```sql
CREATE TABLE generation_history (
    id SERIAL PRIMARY KEY,
    session_id VARCHAR(100) REFERENCES chat_session(session_id) ON DELETE RESTRICT NOT NULL,
    content_type VARCHAR(20) NOT NULL,  -- 'image' | 'text'
    input_text TEXT,
    output_text TEXT,
    prompt TEXT,
    input_image_id INTEGER REFERENCES image_matching(id) ON DELETE SET NULL,
    output_image_id INTEGER REFERENCES image_matching(id) ON DELETE SET NULL,
    generation_method VARCHAR(50),
    style VARCHAR(50),
    industry VARCHAR(50),
    seed BIGINT,
    strength FLOAT,
    aspect_ratio VARCHAR(10),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### image_matching
```sql
CREATE TABLE image_matching (
    id SERIAL PRIMARY KEY,
    file_hash VARCHAR(128) UNIQUE NOT NULL,  -- SHA-256
    file_directory TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 5. API 엔드포인트

### 5.1 인증 API (`/auth/*`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | `/auth/me` | 현재 로그인 사용자 정보 (is_admin 포함) | 필요 |
| POST | `/auth/signup` | 회원가입 | 불필요 |
| POST | `/auth/login` | 로그인 (OAuth2PasswordRequestForm) | 불필요 |
| POST | `/auth/logout` | 로그아웃 | 불필요 |
| PUT | `/auth/user` | 회원정보 수정 | 필요 |
| DELETE | `/auth/user` | 회원 탈퇴 | 필요 |

### 5.2 채팅 API (`/chat/*`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| POST | `/chat/message/stream` | 챗봇 메시지 (SSE 스트리밍) | 선택 |
| POST | `/chat/session` | 세션 조회/생성 | 필요 |
| GET | `/chat/history` | 유저 대화 히스토리 (페이징) | 필요 |
| GET | `/chat/history/{session_id}` | 세션별 대화 히스토리 | 필요 |
| GET | `/chat/generation/{session_id}` | 세션별 생성 이력 | 필요 |

### 5.3 이미지 API (`/images/*`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | `/images/{file_hash}` | 이미지 파일 서빙 (size 쿼리로 썸네일 지원) | 불필요 |

### 5.4 관리자 API (`/admin/*`)

| Method | Endpoint | 설명 | 인증 |
|--------|----------|------|------|
| GET | `/admin/users` | 사용자 목록 조회 (필터링/페이징) | 관리자 |
| POST | `/admin/users/delete` | 사용자 일괄 삭제 | 관리자 |
| GET | `/admin/generations` | 생성 이력 조회 (필터링/페이징) | 관리자 |

**관리자 API 쿼리 파라미터**:

`GET /admin/users`:
- `limit`: 페이지 크기 (기본 15, 최대 200)
- `offset`: 오프셋
- `user_id`: 사용자 ID 필터
- `login_id`: 로그인 ID 필터
- `name`: 이름 필터
- `is_admin`: 관리자 여부 필터
- `start_date`, `end_date`: 가입일 범위 필터

`GET /admin/generations`:
- `page`: 페이지 번호 (1부터 시작)
- `limit`: 페이지 크기 (기본 5, 최대 50)
- `user_id`: 사용자 ID 필터
- `login_id`: 로그인 ID 필터
- `session_id`: 세션 ID 필터
- `content_type`: 콘텐츠 타입 필터 (image/text)
- `start_date`, `end_date`: 생성일 범위 필터

---

## 6. 핵심 플로우

### 6.1 챗봇 메시지 처리 플로우 (SSE 스트리밍)

```
사용자 메시지 입력
        │
        ▼
┌─────────────────────────────┐
│  /chat/message/stream       │
│  (POST, SSE)                │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  1. ingest_user_message()   │
│  - 세션 확보/생성           │
│  - 이미지 저장 (있으면)      │
│  - 채팅 히스토리 저장        │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  2. LLM analyze_intent()    │
│  - Intent 분류              │
│  - 플랫폼/비율 감지         │
│  - 스타일/업종 감지         │
│  - strength 감지 (수정시)    │
└─────────────────────────────┘
        │
        ▼
    ┌───┴───┐
    │Intent │
    └───┬───┘
        │
   ┌────┼────┬────────────┐
   ▼    ▼    ▼            ▼
consulting  generation  modification
   │         │            │
   ▼         ▼            ▼
┌──────┐  ┌──────────┐  ┌────────────────┐
│상담   │  │refine +  │  │refine +        │
│스트림 │  │generate  │  │target ID 탐색 +│
│      │  │          │  │generate        │
└──────┘  └──────────┘  └────────────────┘
   │         │            │
   └────┬────┴────────────┘
        │
        ▼
┌─────────────────────────────┐
│  3. persist_generation()    │
│  - 이미지 DB 저장           │
│  - 채팅 히스토리 저장        │
│  - 생성 이력 저장           │
└─────────────────────────────┘
        │
        ▼
    SSE done 이벤트
```

### 6.2 Intent 분석 상세

**analyze_intent() 반환값**:
```json
{
  "intent": "generation|modification|consulting",
  "confidence": 0.0-1.0,
  "generation_type": "image|text|null",
  "aspect_ratio": "1:1|16:9|9:16|4:3" or null,
  "style": "ultra_realistic|semi_realistic|anime" or null,
  "industry": "cafe|restaurant|..." or null,
  "strength": 0.0-1.0 or null,
  "text_tone": "warm|professional|friendly|energetic" or null,
  "text_max_length": 10-200 or null
}
```

**플랫폼별 비율 매핑**:
| 플랫폼 | aspect_ratio |
|--------|--------------|
| Instagram 피드 | 1:1 |
| YouTube 썸네일 | 16:9 |
| Instagram Story | 9:16 |
| Facebook | 4:3 |
| 포스터/전단지 | 4:3 |
| 배너 | 16:9 |

**수정 강도(strength) 매핑**:
| 표현 | strength |
|------|----------|
| 살짝, 약간, 조금 | 0.35 |
| 좀, 적당히 (기본) | 0.55 |
| 많이, 크게, 확실하게 | 0.75 |
| 완전히 다르게, 처음부터 | 0.9 |

### 6.3 이미지 생성 플로우

```
한글 사용자 입력
        │
        ▼
┌─────────────────────────────┐
│  PromptTemplateManager      │
│  generate_detailed_prompt() │
│  - GPT로 영어 프롬프트 생성 │
│  - 스타일 감지              │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  ImageGenerationWorkflow    │
│  - T2I: Text2ImageNode      │
│  - I2I: Image2ImageNode     │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  Z-Image Turbo 추론         │
│  - 8 steps                  │
│  - LoRA 스타일 적용         │
└─────────────────────────────┘
        │
        ▼
┌─────────────────────────────┐
│  이미지 저장                │
│  - SHA-256 해시 파일명      │
│  - data/generated/{hash}.jpg │
└─────────────────────────────┘
```

---

## 부록: 디렉토리 구조

```
codeit_ad_smallbiz/
├── main.py                               # FastAPI 앱 진입점
├── alembic.ini                           # Alembic 설정
├── requirements.txt                      # Python 의존성
├── run.sh                                # 실행 스크립트
├── README.md
│
├── alembic/                              # DB 마이그레이션
│   ├── env.py
│   ├── script.py.mako
│   └── versions/
│       ├── 001_add_generation_revision_columns.py
│       ├── 002_add_pgvector_embedding.py
│       ├── 003_remove_revision_columns.py
│       ├── 004_remove_pgvector_embedding.py
│       ├── 005_expand_generation_seed_bigint.py
│       └── 006_add_admin_role.py
│
├── src/
│   ├── backend/
│   │   ├── models.py                     # SQLAlchemy ORM 모델
│   │   ├── schemas.py                    # Pydantic 스키마
│   │   ├── process_db.py                 # DB CRUD
│   │   ├── services.py                   # 비즈니스 로직
│   │   ├── chatbot.py                    # RAG 챗봇
│   │   ├── consulting_knowledge_base.py  # 상담 지식베이스
│   │   ├── rag_preload.py                # RAG 사전 로딩
│   │   └── routers/                      # API 라우터
│   │       ├── admin.py                  # 관리자 API
│   │       ├── auth.py                   # 인증 API
│   │       └── chat.py                   # 채팅 API
│   │
│   ├── generation/
│   │   ├── text_generation/
│   │   │   ├── text_generator.py         # 텍스트 생성 메인
│   │   │   ├── ad_generator.py           # 광고 문구 생성
│   │   │   ├── prompt_manager.py         # 프롬프트 관리
│   │   │   └── evaluate_prompt.py        # 프롬프트 평가
│   │   │
│   │   ├── image_generation/
│   │   │   ├── generator.py              # 메인 진입점 (Z-Image Turbo)
│   │   │   ├── generator_sdxl.py         # SDXL 생성기
│   │   │   ├── workflow.py               # 이미지 생성 워크플로우
│   │   │   ├── config.py                 # 설정
│   │   │   ├── preload.py                # 모델 사전 로딩
│   │   │   ├── shared_cache.py           # 모델 캐시
│   │   │   ├── nodes/                    # 생성 노드
│   │   │   │   ├── base.py               # 기본 노드
│   │   │   │   ├── text2image.py         # T2I 노드
│   │   │   │   ├── image2image.py        # I2I 노드
│   │   │   │   ├── controlnet.py         # ControlNet 노드
│   │   │   │   ├── preprocessing.py      # 전처리
│   │   │   │   ├── postprocessing.py     # 후처리
│   │   │   │   ├── text_overlay.py       # 텍스트 오버레이
│   │   │   │   ├── save_image.py         # 이미지 저장
│   │   │   │   ├── prompt_processor.py   # 프롬프트 처리
│   │   │   │   ├── gpt_layout_analyzer.py      # GPT 레이아웃 분석
│   │   │   │   ├── product_layout_analyzer.py  # 제품 레이아웃 분석
│   │   │   │   └── sdxl/                 # SDXL 전용 노드
│   │   │   │       ├── text2image_sdxl.py
│   │   │   │       ├── image2image_sdxl.py
│   │   │   │       └── controlnet_sdxl.py
│   │   │   ├── prompt/                   # 프롬프트 관리
│   │   │   │   ├── prompt_manager.py     # 프롬프트 매니저
│   │   │   │   ├── prompt_templates.py   # 프롬프트 템플릿
│   │   │   │   ├── style_router.py       # 스타일 라우터
│   │   │   │   ├── config_loader.py      # 설정 로더
│   │   │   │   └── input_parser.py       # 입력 파서
│   │   │   ├── tools/                    # 유틸리티 도구
│   │   │   │   ├── font_loader.py        # 폰트 로더
│   │   │   │   └── text_layout_tools.py  # 텍스트 레이아웃
│   │   │
│   │   └── chat_bot/                     # RAG 챗봇 모듈
│   │       ├── agent/
│   │       │   └── agent.py              # 에이전트
│   │       ├── api/
│   │       │   └── endpoints.py          # API 엔드포인트
│   │       ├── config/
│   │       │   └── settings.py           # 설정
│   │       ├── rag/
│   │       │   ├── chain.py              # RAG 체인
│   │       │   ├── knowledge_base.py     # 지식베이스
│   │       │   └── prompts.py            # 프롬프트
│   │       ├── refine/
│   │       │   └── self_refine.py        # 자기 개선
│   │       ├── data/                     # 데이터 처리
│   │       │   ├── 01_crawl_naver.py     # 네이버 크롤링
│   │       │   ├── 02_split_data.py      # 데이터 분할
│   │       │   ├── 03_build_documents_v5.py  # 문서 빌드
│   │       │   └── 06_build_vectorstore.py   # 벡터스토어 빌드
│   │       └── evaluation/               # 평가
│   │           ├── 04_evaluate_embeddings.py
│   │           ├── 05_evaluate_reranker.py
│   │           ├── build_responses.py
│   │           └── evaluate_prompts.py
│   │
│   ├── utils/
│   │   ├── config.py                     # 환경설정 (Settings)
│   │   ├── security.py                   # 보안 (JWT, bcrypt)
│   │   ├── session.py                    # 세션 관리
│   │   ├── image.py                      # 이미지 유틸리티
│   │   └── logging.py                    # 로깅 설정
│   │
│   └── frontend/
│       ├── main.html                     # 메인 페이지
│       ├── admin.html                    # 관리자 페이지
│       └── static/                       # 정적 파일 (CSS, JS)
│
├── data/
│   ├── generated/                        # 생성된 이미지
│   └── uploads/                          # 업로드된 이미지
│
├── docs/
│   └── doc/                              # 문서
│
└── logs/                                 # 로그 파일
```

---

**문서 버전**: 4.0
**최종 수정**: 2026-01-27
