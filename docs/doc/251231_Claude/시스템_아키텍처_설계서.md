# 시스템 아키텍처 설계서
## 소상공인 광고 콘텐츠 생성 서비스

**작성일**: 2025-01-01  
**프로젝트 기간**: 4주  
**버전**: 1.0

---

## 1. 시스템 개요

### 1.1 서비스 목적
소상공인이 생성형 AI 기술을 활용하여 **업종 제약 없이** 광고 이미지와 마케팅 문구를 손쉽게 제작할 수 있는 웹 기반 서비스

### 1.2 핵심 기능 (1차 목표)
- **텍스트 기반 광고 이미지 생성**: 사용자가 입력한 텍스트 요청사항을 바탕으로 광고 이미지 자동 생성
- **광고 문구 생성**: GPT API를 활용한 맞춤형 마케팅 카피 생성
- **챗봇 인터페이스**: 대화형 UI를 통한 직관적인 사용자 경험
- **생성 이력 관리**: 회원별 광고 생성 및 채팅 이력 저장/조회

### 1.3 주요 사용자
- **주 타겟**: 소상공인 (카페, 식당, 소매점, 서비스업 등)
- **비회원**: 1회성 광고 생성 가능
- **회원**: 이력 관리 및 브랜드 일관성 유지 가능

---

## 2. 전체 시스템 아키텍처

### 2.1 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                        사용자 (웹 브라우저)                     │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTPS
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                     프론트엔드 (Svelte)                        │
│  - Vercel 배포                                               │
│  - 챗봇 UI, 광고 생성 폼, 이력 조회                            │
│  - 회원가입/로그인 UI                                         │
└────────────────────────┬────────────────────────────────────┘
                         │ REST API (JSON)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   백엔드 API (FastAPI)                        │
│  - Cloud Run 배포                                            │
│  - 엔드포인트: /generate, /auth, /history 등                 │
│  - 요청 검증 (Pydantic)                                      │
│  - 작업 상태 관리 (비동기)                                    │
└───────┬─────────────────┬─────────────────┬─────────────────┘
        │                 │                 │
        ▼                 ▼                 ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ 비즈니스     │  │ 인증/세션    │  │ DB 접근      │
│ 로직         │  │ 관리         │  │ 레이어       │
│ (services)   │  │              │  │ (db_proc)    │
└──────┬───────┘  └──────────────┘  └──────┬───────┘
       │                                    │
       ▼                                    ▼
┌──────────────────────────────────────────────────┐
│              AI 모델 레이어                       │
│  ┌─────────────────┐  ┌─────────────────┐       │
│  │ 이미지 생성     │  │ 텍스트/프롬프트 │       │
│  │ (SDXL/Flux)     │  │ 생성 (GPT API)  │       │
│  └─────────────────┘  └─────────────────┘       │
└──────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────┐
│           데이터 저장소 레이어                     │
│  ┌─────────────┐  ┌──────────────┐              │
│  │ PostgreSQL  │  │ GCS / 로컬   │              │
│  │ (메타데이터)│  │ (이미지 저장)│              │
│  └─────────────┘  └──────────────┘              │
└──────────────────────────────────────────────────┘
```

### 2.2 기술 스택

| 레이어 | 기술 | 비고 |
|--------|------|------|
| **프론트엔드** | Svelte | Vercel 자동 배포 |
| **백엔드 API** | FastAPI | Cloud Run 배포 |
| **비즈니스 로직** | Python | 비동기 처리 포함 |
| **이미지 생성** | SDXL, Flux.1, (QWEN) | GPU 인스턴스 필요 |
| **텍스트 생성** | OpenAI GPT API | 외부 API 호출 |
| **데이터베이스** | PostgreSQL | 메타데이터 저장 |
| **파일 저장소** | GCS (우선) / 로컬 | 이미지 파일 저장 |
| **컨테이너** | Docker | 각 서비스별 컨테이너화 |
| **CI/CD** | GitHub Actions | 자동 테스트/배포 |

---

## 3. 레이어별 상세 설계

### 3.1 프론트엔드 레이어

#### 3.1.1 주요 컴포넌트
```
frontend/
├── app.py                    # 메인 진입점
├── ui_components.py          # UI 컴포넌트 통합
│   ├── ChatbotUI             # 챗봇 인터페이스
│   ├── AuthUI                # 회원가입/로그인
│   ├── GenerationHistoryUI   # 광고 생성 이력
│   ├── ChatHistoryUI         # 채팅 이력
│   ├── BrandSettingUI        # (추가) 브랜드 설정
│   └── RecommendationUI      # (추가) 오늘의 추천
└── backend_client.py         # FastAPI 통신 클라이언트
```

#### 3.1.2 주요 기능
1. **챗봇 UI**
   - 사용자 입력 폼 (텍스트 + 이미지 비율 선택: 1:1, 4:3, 3:4)
   - 실시간 대화 표시 (사용자: 오른쪽, AI: 왼쪽)
   - 생성 진행 상태 표시 (Spinner)
   - 최종 결과 표시 (이미지 + 광고 문구)

2. **인증 UI**
   - 회원가입: user_id, user_pw 입력 및 유효성 검증
   - 로그인: 인증 성공 시 세션 생성, 실패 시 에러 메시지

3. **이력 관리 UI**
   - 광고 생성 이력: 썸네일 표시, 클릭 시 상세 뷰
   - 채팅 이력: 세션별 구분, 최초 채팅 시각 또는 앞 10글자 표시

#### 3.1.3 데이터 흐름
```
사용자 입력 → backend_client.py → FastAPI (/generate)
                                  ↓
                            작업 ID 반환
                                  ↓
                    주기적 상태 확인 (/status/{task_id})
                                  ↓
                    완료 시 결과 수신 및 UI 렌더링
```

### 3.2 백엔드 API 레이어

#### 3.2.1 디렉토리 구조
```
backend/
├── routes.py                 # FastAPI 엔드포인트 정의
├── services.py               # 비즈니스 로직 통합
├── db_processor.py           # DB CRUD 작업
├── schemas.py                # Pydantic 스키마
└── utils/
    ├── database.py           # DB 연결 관리
    ├── storage.py            # 파일 저장/로드
    ├── validators.py         # 유효성 검증
    ├── config.py             # 환경 설정
    └── logging_config.py     # 로깅 설정
```

#### 3.2.2 주요 엔드포인트

| 엔드포인트 | 메서드 | 기능 | 요청 예시 | 응답 예시 |
|-----------|--------|------|----------|----------|
| `/generate` | POST | 광고 생성 요청 | `{user_id, input_text, aspect_ratio}` | `{task_id}` |
| `/status/{task_id}` | GET | 작업 상태 조회 | - | `{status, progress, result}` |
| `/auth/signup` | POST | 회원가입 | `{login_id, login_pw}` | `{user_id, success}` |
| `/auth/login` | POST | 로그인 | `{login_id, login_pw}` | `{user_id, session_token}` |
| `/history/generation` | GET | 광고 생성 이력 | `?user_id=1` | `[{id, output_url, created_at}]` |
| `/history/chat` | GET | 채팅 이력 | `?user_id=1&session_id=abc` | `[{role, content, timestamp}]` |

#### 3.2.3 비동기 작업 관리
```
1. 사용자 요청 수신 (/generate)
   ↓
2. Task ID 생성 및 즉시 반환
   ↓
3. 백그라운드에서 AI 모델 호출
   - 프롬프트 생성 (GPT API)
   - 이미지 생성 (SDXL/Flux)
   - 후처리 (리사이징, 텍스트 오버레이)
   ↓
4. 작업 상태 업데이트 (진행 중 → 완료/실패)
   ↓
5. 결과 DB 및 파일 저장
```

### 3.3 AI 모델 레이어

#### 3.3.1 이미지 생성 (UnifiedImageGenerator)

**모듈 위치**: `generation/image_generation/`

**모델 선택 기준**:
- **SDXL** (기본): 빠른 생성 속도, 애니메이션 스타일
- **Flux.1** (고품질): 범용적 실사 이미지
- **QWEN** (선택): 고품질 실사, 생성 시간 가장 느림 (후순위)

**주요 함수**:
```
UnifiedImageGenerator:
  - generate()                        # 총괄 함수
  - decide_generation_method()        # t2i/ControlNet 선택
  - analyze_image_quality()           # 입력 이미지 품질 분석
  - preprocess_image()                # 배경 제거, 밝기 조정
  - generate_t2i()                    # 텍스트→이미지
  - generate_controlnet()             # ControlNet 기반 생성
  - postprocess_image()               # 리사이징, 압축, 텍스트 오버레이
```

**입력**:
- 태그 기반 프롬프트 (GPT로 생성)
- (선택) 사용자 로고 이미지

**출력**:
- 광고 이미지 파일 (리사이징, 압축 완료)
- 메타데이터 (사용된 모델, 시드, 스타일)

#### 3.3.2 텍스트/프롬프트 생성

**모듈 위치**: `models/text_generation/`

**클래스**:
1. **PromptTemplateManager**
   - 이미지 생성용 프롬프트 템플릿 (업종별/스타일별)
   - 텍스트 생성용 프롬프트 템플릿 (톤앤매너별)

2. **TextGenerator**
   - GPT API 연동
   - 광고 카피 생성
   - 응답 파싱 및 검증

**입력**:
- 사용자 요청 텍스트
- 키워드 (업종, 메뉴, 계절, 스타일 등)

**출력**:
- 이미지 생성용 프롬프트 (태그 형태)
- 광고 문구 (텍스트 오버레이용 또는 단독 제공)

### 3.4 데이터 저장소 레이어

#### 3.4.1 데이터베이스 스키마 (PostgreSQL)

**1. user (회원 정보)**
```sql
CREATE TABLE user (
    user_id SERIAL PRIMARY KEY,
    login_id VARCHAR(50) UNIQUE NOT NULL,
    login_pw VARCHAR(255) NOT NULL,  -- 해시 저장
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**2. generation_history (광고 생성 이력)**
```sql
CREATE TABLE generation_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES user(user_id) ON DELETE SET NULL,
    input_text TEXT NOT NULL,
    input_image_hash VARCHAR(64),  -- SHA-256
    content_type VARCHAR(10) CHECK (content_type IN ('image', 'text')),
    output_url TEXT,  -- GCS URL 또는 해시값
    generation_method VARCHAR(20) CHECK (generation_method IN ('t2i', 'controlnet')),
    style TEXT,  -- 사용된 스타일 태그
    industry VARCHAR(50),
    seed INTEGER,
    aspect_ratio VARCHAR(10),  -- '1:1', '4:3', '3:4'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**3. chat_history (채팅 이력)**
```sql
CREATE TABLE chat_history (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES user(user_id) ON DELETE SET NULL,
    session_id VARCHAR(64) NOT NULL,  -- 세션 식별자 (해시)
    message_id INTEGER NOT NULL,  -- 세션 내 메시지 순서
    role VARCHAR(10) CHECK (role IN ('user', 'assistant')),
    content TEXT NOT NULL,
    input_image_hash VARCHAR(64),  -- 사용자가 입력한 이미지 해시
    gen_image_url TEXT,  -- assistant가 생성한 이미지 URL
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**4. image_matching (이미지 파일 매칭)**
```sql
CREATE TABLE image_matching (
    id SERIAL PRIMARY KEY,
    file_hash VARCHAR(64) UNIQUE NOT NULL,  -- SHA-256
    file_directory TEXT NOT NULL,  -- 저장 경로
    file_type VARCHAR(10) CHECK (file_type IN ('input', 'generated')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.4.2 파일 저장소 구조

**GCS 버킷 구조** (우선):
```
gs://ad-generator-bucket/
├── input_images/          # 사용자 입력 이미지
│   └── {user_id}/
│       └── {file_hash}.png
└── generated_images/      # 생성된 광고 이미지
    └── {user_id}/
        └── {timestamp}_{file_hash}.png
```

**로컬 저장소** (대안):
```
/storage/
├── input_images/
└── generated_images/
```

---

## 4. 데이터 흐름

### 4.1 광고 생성 플로우

```
[사용자] 
  ↓ "카페 신메뉴 홍보 이미지 만들어줘, 3:4 비율"
[프론트엔드]
  ↓ POST /generate {user_id: 1, input_text: "...", aspect_ratio: "3:4"}
[routes.py]
  ↓ 요청 검증 (schemas.py)
  ↓ Task ID 생성 및 반환
  ↓ 백그라운드 작업 시작
[services.py]
  ↓ 1. 프롬프트 생성 (TextGenerator)
  ↓    - GPT API 호출: "카페, 신메뉴, 홍보" → 태그 추출
  ↓ 2. 이미지 생성 (UnifiedImageGenerator)
  ↓    - 모델 선택 (SDXL)
  ↓    - generate_t2i() 호출
  ↓    - 후처리 (3:4 리사이징, 압축)
  ↓ 3. 파일 저장 (storage.py)
  ↓    - 파일 해시 계산
  ↓    - GCS 업로드
  ↓    - URL 반환
  ↓ 4. DB 저장 (db_processor.py)
  ↓    - generation_history 삽입
  ↓    - image_matching 삽입
  ↓ 5. Task 상태 업데이트 (완료)
[프론트엔드]
  ↓ GET /status/{task_id} (주기적 폴링)
  ↓ 결과 수신: {status: "completed", result: {image_url, ad_copy}}
[사용자]
  ← 생성된 이미지 + 광고 문구 표시
```

### 4.2 회원가입/로그인 플로우

**회원가입**:
```
[프론트엔드] POST /auth/signup {login_id, login_pw}
             ↓
[routes.py]  유효성 검증 (validators.py)
             ↓
[services.py] 비밀번호 해시 (bcrypt)
             ↓
[db_processor.py] user 테이블 삽입
             ↓ (중복 시 에러 반환)
[프론트엔드] ← {user_id: 1, success: true}
```

**로그인**:
```
[프론트엔드] POST /auth/login {login_id, login_pw}
             ↓
[services.py] 비밀번호 검증
             ↓
             세션 토큰 생성 (JWT)
             ↓
[프론트엔드] ← {user_id: 1, session_token: "..."}
             (토큰 저장, 이후 요청에 헤더 포함)
```

---

## 5. 보안 및 성능 고려사항

### 5.1 보안
- **비밀번호**: bcrypt 해시 저장
- **세션**: JWT 토큰 기반 인증
- **API 키**: 환경 변수로 관리 (GPT API 키 등)
- **CORS**: 프론트엔드 도메인만 허용
- **입력 검증**: Pydantic 스키마로 모든 입력 검증

### 5.2 성능
- **비동기 처리**: AI 모델 호출은 백그라운드 작업으로 처리
- **이미지 압축**: 생성 후 자동 압축 (용량 최적화)
- **캐싱**: 동일 프롬프트 재요청 시 캐시 활용 (선택 기능)
- **GPU 최적화**: 배치 처리 지원 (여러 요청 동시 처리)

### 5.3 확장성
- **마이크로서비스**: 각 모듈 독립 배포 가능
- **로드 밸런싱**: Cloud Run 자동 스케일링
- **DB 최적화**: 인덱스 설정 (user_id, session_id)

---

## 6. 인프라 및 배포

### 6.1 컨테이너 구조

```
deployment/docker/
├── docker-compose.yml        # 전체 오케스트레이션
├── frontend/
│   └── Dockerfile            # Svelte 빌드
├── backend/
│   └── Dockerfile            # FastAPI
└── gpu_server/
    └── Dockerfile            # AI 모델 서버 (선택)
```

### 6.2 배포 전략

| 서비스 | 배포 대상 | 특징 |
|--------|----------|------|
| 프론트엔드 | Vercel | Git push 시 자동 배포 |
| 백엔드 API | Cloud Run | 컨테이너 기반, 자동 스케일링 |
| GPU 서버 | GCP Compute Engine | GPU 인스턴스 (NVIDIA T4) |
| 데이터베이스 | Cloud SQL (PostgreSQL) | 관리형 DB |
| 파일 저장소 | GCS | 무료 5GB 활용 |

### 6.3 CI/CD 파이프라인

```yaml
# .github/workflows/deploy.yml
1. 코드 푸시 (main 브랜치)
   ↓
2. 자동 테스트 실행
   - 단위 테스트
   - 통합 테스트
   ↓
3. Docker 이미지 빌드
   ↓
4. 배포
   - 프론트엔드 → Vercel
   - 백엔드 → Cloud Run
```

---

## 7. 1차 목표 (4주) vs 향후 확장 기능

### 7.1 1차 목표 (필수)
✅ 텍스트 입력 기반 광고 이미지 생성  
✅ GPT 기반 광고 문구 생성  
✅ 챗봇 UI  
✅ 회원가입/로그인  
✅ 광고 생성 이력 조회  
✅ 채팅 이력 조회  
✅ 이미지 비율 선택 (1:1, 4:3, 3:4)  

### 7.2 향후 확장 (2차 이후)
⏳ 사용자 로고 이미지 입력 (ControlNet)  
⏳ 브랜드 설정 UI (스타일 일관성 유지)  
⏳ 오늘의 추천 (계절/기념일 기반)  
⏳ 이미지 편집 기능 (텍스트 위치 조정 등)  
⏳ 다국어 지원  

---

## 8. 리스크 및 대응 방안

| 리스크 | 영향도 | 대응 방안 |
|--------|--------|----------|
| AI 모델 생성 시간 초과 | 높음 | 타임아웃 설정, 사용자에게 예상 시간 안내 |
| GPU 비용 초과 | 중간 | SDXL 우선 사용, Flux는 고품질 요청 시만 |
| GPT API 비용 | 중간 | 프롬프트 길이 제한, 캐싱 활용 |
| DB 동시 접속 | 낮음 | 연결 풀 설정, Cloud SQL 사용 |
| 이미지 저장 용량 초과 | 낮음 | GCS 5GB 활용, 압축 최적화 |

---

## 9. 성공 지표 (KPI)

1. **기능 완성도**: 1차 목표 100% 구현
2. **생성 성공률**: 95% 이상
3. **평균 생성 시간**: 30초 이내
4. **사용자 만족도**: 사용성 테스트 점수 4점/5점 이상
5. **시스템 안정성**: 배포 후 24시간 무중단 운영

---

## 부록: 용어 정의

- **t2i**: Text-to-Image (텍스트→이미지 생성)
- **ControlNet**: 이미지 조건부 생성 (구도, 스타일 제어)
- **SDXL**: Stable Diffusion XL (빠른 이미지 생성 모델)
- **Flux.1**: 고품질 이미지 생성 모델
- **GCS**: Google Cloud Storage
- **Cloud Run**: 서버리스 컨테이너 플랫폼
