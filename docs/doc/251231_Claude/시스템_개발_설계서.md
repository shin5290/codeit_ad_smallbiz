# 시스템 개발 설계서
## 소상공인 광고 콘텐츠 생성 서비스

**작성일**: 2025-01-01  
**프로젝트 기간**: 4주  
**버전**: 1.0

---

## 목차
1. [개발 환경 설정](#1-개발-환경-설정)
2. [프론트엔드 영역 (이유노)](#2-프론트엔드-영역-이유노)
3. [백엔드 비즈니스 로직 영역 (진수경)](#3-백엔드-비즈니스-로직-영역-진수경)
4. [이미지 생성 영역 (이현석)](#4-이미지-생성-영역-이현석)
5. [텍스트 및 프롬프트 생성 영역 (배현석)](#5-텍스트-및-프롬프트-생성-영역-배현석)
6. [인프라 영역 (신승목)](#6-인프라-영역-신승목)
7. [모듈 간 통신 규약](#7-모듈-간-통신-규약)
8. [에러 처리 규약](#8-에러-처리-규약)

---

## 1. 개발 환경 설정

### 1.1 공통 개발 도구
- **Python**: 3.10 이상
- **Node.js**: 18 이상 (프론트엔드)
- **Git**: 버전 관리
- **Docker**: 컨테이너 환경 통일

### 1.2 프로젝트 디렉토리 구조
```
ad-generator/
├── frontend/                # Svelte 앱
│   ├── src/
│   │   ├── App.svelte
│   │   ├── components/
│   │   └── lib/
│   └── package.json
├── backend/                 # FastAPI 앱
│   ├── routes.py
│   ├── services.py
│   ├── db_processor.py
│   ├── schemas.py
│   └── utils/
├── generation/              # AI 모델
│   ├── image_generation/
│   │   └── unified_generator.py
│   └── text_generation/
│       ├── prompt_manager.py
│       └── text_generator.py
├── deployment/              # 배포 설정
│   ├── docker/
│   └── scripts/
├── tests/                   # 테스트 코드
└── requirements.txt
```

### 1.3 환경 변수 (.env)
```
# API 키
OPENAI_API_KEY=your_gpt_api_key

# 데이터베이스
DATABASE_URL=postgresql://user:password@localhost:5432/ad_generator

# 파일 저장
GCS_BUCKET_NAME=ad-generator-bucket
STORAGE_PATH=/storage/

# 기타
SECRET_KEY=your_jwt_secret_key
DEBUG=True
```

---

## 2. 프론트엔드 영역 (이유노)

### 2.1 담당 범위
- **디렉토리**: `frontend/`
- **기술 스택**: Svelte, Vercel
- **주요 업무**: UI/UX 설계, 백엔드 API 통신, 사용자 플로우 구현

### 2.2 주요 컴포넌트 및 기능

#### 2.2.1 App.svelte (메인 앱)
**역할**: 전체 애플리케이션 라우팅 및 상태 관리

**주요 상태**:
- `isLoggedIn`: 로그인 상태 (boolean)
- `currentUser`: 현재 사용자 정보 (user_id, login_id)
- `sessionToken`: JWT 토큰 (localStorage 저장)

**구조**:
```
<Header>
  - 로고
  - 로그인/회원가입 버튼 (isLoggedIn에 따라 변경)
  - 로그아웃 버튼
</Header>

<MainContent>
  <ChatbotUI />
  <GenerationHistoryUI />
  <ChatHistoryUI />
</MainContent>

<Sidebar> (선택 기능)
  <BrandSettingUI />
  <RecommendationUI />
</Sidebar>
```

#### 2.2.2 ChatbotUI 컴포넌트
**역할**: 사용자와 AI의 대화형 인터페이스

**입력 요소**:
1. 텍스트 입력 필드
   - placeholder: "어떤 광고를 만들고 싶으신가요?"
   - maxLength: 500자
2. 이미지 비율 선택 (라디오 버튼 또는 드롭다운)
   - 옵션: "1:1", "4:3", "3:4"
3. 생성 버튼

**출력 요소**:
1. 대화 이력 표시 영역
   - 사용자 메시지: 오른쪽 정렬, 파란색 배경
   - AI 메시지: 왼쪽 정렬, 회색 배경
   - 이미지가 포함된 경우 썸네일 표시
2. 생성 진행 상태
   - Spinner 애니메이션
   - 상태 텍스트 ("이미지 생성 중...", "광고 문구 생성 중...")
3. 최종 결과
   - 생성된 이미지 (클릭 시 확대)
   - 광고 문구 (복사 버튼 포함)
   - 다운로드 버튼

**동작 흐름**:
```
1. 사용자 입력 → 버튼 클릭
2. backendClient.generateAd() 호출
   - 요청: {user_id, input_text, aspect_ratio}
3. Task ID 수신
4. 상태 확인 루프 시작 (1초마다)
   - backendClient.checkTaskStatus(task_id)
5. 상태가 "completed"이면 결과 표시
   - 이미지 URL로 <img> 렌더링
   - 광고 문구 텍스트 표시
```

#### 2.2.3 AuthUI 컴포넌트
**역할**: 회원가입 및 로그인 처리

**회원가입 폼**:
- 입력 필드: login_id (3-20자), login_pw (8-30자)
- 유효성 검증: 
  - ID: 영문, 숫자만 허용
  - PW: 영문, 숫자, 특수문자 포함
- 제출 버튼

**로그인 폼**:
- 입력 필드: login_id, login_pw
- 제출 버튼
- "회원가입하기" 링크

**동작 흐름**:
```
[회원가입]
1. 폼 제출 → backendClient.signup(login_id, login_pw)
2. 응답 처리:
   - 성공: "회원가입 완료" 메시지, 로그인 폼으로 전환
   - 실패 (중복 ID): "이미 사용 중인 아이디입니다" 에러 표시

[로그인]
1. 폼 제출 → backendClient.login(login_id, login_pw)
2. 응답 처리:
   - 성공: sessionToken 저장, isLoggedIn = true, 화면 갱신
   - 실패: "아이디 또는 비밀번호가 일치하지 않습니다" 에러 표시
```

#### 2.2.4 GenerationHistoryUI 컴포넌트
**역할**: 사용자의 광고 생성 이력 표시

**표시 내용**:
- 썸네일 그리드 (3-4열)
- 각 항목: 이미지, 생성 일시, 스타일 태그
- 클릭 시 모달로 상세 정보 표시
  - 원본 크기 이미지
  - 입력 텍스트
  - 광고 문구
  - 다운로드 버튼

**데이터 로드**:
```
1. 컴포넌트 마운트 시
2. backendClient.getGenerationHistory(user_id) 호출
3. 응답 데이터를 배열로 저장
4. 반복문으로 썸네일 렌더링
```

#### 2.2.5 ChatHistoryUI 컴포넌트
**역할**: 과거 채팅 세션 목록 표시

**표시 내용**:
- 세션 목록 (시간 역순)
- 각 세션: 최초 채팅 시각, 첫 메시지 앞 10글자
- 클릭 시 해당 세션의 대화 이력 로드

**데이터 로드**:
```
1. backendClient.getChatSessions(user_id) 호출
2. 세션 목록 표시
3. 세션 클릭 시
   - backendClient.getChatHistory(user_id, session_id)
   - ChatbotUI에 이력 로드
```

### 2.3 backend_client.py (API 통신 클라이언트)

**역할**: FastAPI와 통신하는 클라이언트 모듈

**주요 함수**:

#### generateAd(user_id, input_text, aspect_ratio)
- **요청**: POST /generate
- **입력**: 
  ```javascript
  {
    user_id: number | null,  // 비회원은 null
    input_text: string,
    aspect_ratio: "1:1" | "4:3" | "3:4"
  }
  ```
- **출력**: 
  ```javascript
  {
    task_id: string  // 작업 추적용 ID
  }
  ```

#### checkTaskStatus(task_id)
- **요청**: GET /status/{task_id}
- **출력**:
  ```javascript
  {
    status: "pending" | "processing" | "completed" | "failed",
    progress: number,  // 0-100
    result: {
      image_url: string,
      ad_copy: string
    } | null,
    error: string | null
  }
  ```

#### signup(login_id, login_pw)
- **요청**: POST /auth/signup
- **입력**: `{login_id, login_pw}`
- **출력**: `{success: boolean, user_id: number | null, error: string | null}`

#### login(login_id, login_pw)
- **요청**: POST /auth/login
- **입력**: `{login_id, login_pw}`
- **출력**: `{success: boolean, user_id: number, session_token: string, error: string | null}`

#### getGenerationHistory(user_id)
- **요청**: GET /history/generation?user_id={user_id}
- **출력**:
  ```javascript
  [
    {
      id: number,
      output_url: string,
      created_at: string,
      style: string,
      aspect_ratio: string
    },
    ...
  ]
  ```

#### getChatSessions(user_id)
- **요청**: GET /history/chat/sessions?user_id={user_id}
- **출력**:
  ```javascript
  [
    {
      session_id: string,
      first_message: string,  // 앞 10글자
      created_at: string
    },
    ...
  ]
  ```

#### getChatHistory(user_id, session_id)
- **요청**: GET /history/chat?user_id={user_id}&session_id={session_id}
- **출력**:
  ```javascript
  [
    {
      role: "user" | "assistant",
      content: string,
      image_url: string | null,
      created_at: string
    },
    ...
  ]
  ```

### 2.4 routes.py (FastAPI 엔드포인트)

**역할**: 프론트엔드 요청을 받아 백엔드 로직으로 전달

**주요 엔드포인트**:

#### POST /generate
```python
입력: GenerateRequest (Pydantic 스키마)
  - user_id: int | None
  - input_text: str
  - aspect_ratio: str

처리:
1. 요청 검증 (schemas.py)
2. Task ID 생성 (UUID)
3. 백그라운드 작업 시작
   - services.create_advertisement() 호출
4. 즉시 Task ID 반환

출력: {"task_id": "..."}
```

#### GET /status/{task_id}
```python
입력: task_id (경로 매개변수)

처리:
1. Task 상태 조회 (메모리 또는 Redis)
2. 상태 정보 반환

출력: TaskStatus (Pydantic 스키마)
```

#### POST /auth/signup
```python
입력: SignupRequest
  - login_id: str
  - login_pw: str

처리:
1. 유효성 검증 (validators.py)
2. services.register_user() 호출

출력: {"success": bool, "user_id": int | None, "error": str | None}
```

#### POST /auth/login
```python
입력: LoginRequest
  - login_id: str
  - login_pw: str

처리:
1. services.authenticate_user() 호출
2. JWT 토큰 생성

출력: {"success": bool, "user_id": int, "session_token": str, "error": str | None}
```

#### GET /history/generation
```python
입력: user_id (쿼리 매개변수)

처리:
1. db_processor.get_generation_history(user_id) 호출

출력: List[GenerationHistoryItem]
```

#### GET /history/chat/sessions
```python
입력: user_id (쿼리 매개변수)

처리:
1. db_processor.get_chat_sessions(user_id) 호출

출력: List[ChatSession]
```

#### GET /history/chat
```python
입력: user_id, session_id (쿼리 매개변수)

처리:
1. db_processor.get_chat_history(user_id, session_id) 호출

출력: List[ChatMessage]
```

---

## 3. 백엔드 비즈니스 로직 영역 (진수경)

### 3.1 담당 범위
- **디렉토리**: `backend/`
- **주요 업무**: DB CRUD, 비즈니스 로직 통합, 챗봇 로직

### 3.2 services.py (비즈니스 로직 통합)

**역할**: AI 모델 호출 및 전체 워크플로우 조율

**주요 함수**:

#### create_advertisement(task_id, user_id, input_text, aspect_ratio)
```python
입력:
  - task_id: str
  - user_id: int | None
  - input_text: str
  - aspect_ratio: str

처리 과정:
1. Task 상태 초기화 (pending)

2. 프롬프트 생성
   - PromptTemplateManager.generate_image_prompt(input_text)
     입력: "카페 신메뉴 홍보, 따뜻한 느낌"
     출력: "cafe, new menu, warm atmosphere, cozy, latte art, ..."
   
   - TextGenerator.generate_ad_copy(input_text)
     입력: "카페 신메뉴 홍보, 따뜻한 느낌"
     출력: "따뜻한 겨울, 새로운 메뉴와 함께 하세요!"

3. 이미지 생성
   - UnifiedImageGenerator.generate(
       prompt="...",
       aspect_ratio="3:4"
     )
     출력: image_path, metadata (seed, style, model)

4. 파일 저장
   - storage.save_image(image_path, user_id)
     출력: image_url (GCS URL 또는 로컬 경로)

5. DB 저장
   - db_processor.save_generation_history({
       user_id, input_text, output_url, 
       content_type="image", generation_method="t2i",
       style=metadata.style, seed=metadata.seed,
       aspect_ratio
     })

6. 챗봇 이력 저장
   - db_processor.save_chat_message({
       user_id, session_id, role="user", content=input_text
     })
   - db_processor.save_chat_message({
       user_id, session_id, role="assistant", 
       content=ad_copy, gen_image_url=image_url
     })

7. Task 상태 업데이트 (completed)
   - 결과 저장: {image_url, ad_copy}

출력: None (백그라운드 작업)
```

#### register_user(login_id, login_pw)
```python
입력:
  - login_id: str
  - login_pw: str

처리:
1. 중복 확인
   - db_processor.check_duplicate_id(login_id)
   - 중복 시 에러 반환

2. 비밀번호 해시
   - bcrypt.hashpw(login_pw)

3. DB 저장
   - db_processor.create_user(login_id, hashed_pw)

출력: user_id (int)
```

#### authenticate_user(login_id, login_pw)
```python
입력:
  - login_id: str
  - login_pw: str

처리:
1. 사용자 조회
   - db_processor.get_user_by_login_id(login_id)

2. 비밀번호 검증
   - bcrypt.checkpw(login_pw, stored_hash)

3. JWT 토큰 생성
   - jwt.encode({user_id, exp: 7일}, SECRET_KEY)

출력: {user_id, session_token}
```

### 3.3 db_processor.py (DB CRUD)

**역할**: PostgreSQL과의 모든 데이터베이스 작업

**주요 함수**:

#### create_user(login_id, hashed_pw)
```sql
INSERT INTO user (login_id, login_pw) 
VALUES (%s, %s) 
RETURNING user_id;
```

#### check_duplicate_id(login_id)
```sql
SELECT COUNT(*) FROM user WHERE login_id = %s;
```

#### get_user_by_login_id(login_id)
```sql
SELECT user_id, login_pw FROM user WHERE login_id = %s;
```

#### save_generation_history(data)
```sql
INSERT INTO generation_history 
(user_id, input_text, output_url, content_type, 
 generation_method, style, industry, seed, aspect_ratio)
VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
RETURNING id;
```

#### get_generation_history(user_id, limit=20)
```sql
SELECT id, output_url, created_at, style, aspect_ratio
FROM generation_history
WHERE user_id = %s
ORDER BY created_at DESC
LIMIT %s;
```

#### save_chat_message(data)
```sql
INSERT INTO chat_history
(user_id, session_id, message_id, role, content, 
 input_image_hash, gen_image_url)
VALUES (%s, %s, %s, %s, %s, %s, %s);
```

#### get_chat_sessions(user_id)
```sql
SELECT DISTINCT session_id, 
       MIN(created_at) as created_at,
       SUBSTRING(content, 1, 10) as first_message
FROM chat_history
WHERE user_id = %s AND role = 'user'
GROUP BY session_id
ORDER BY created_at DESC;
```

#### get_chat_history(user_id, session_id)
```sql
SELECT role, content, gen_image_url, created_at
FROM chat_history
WHERE user_id = %s AND session_id = %s
ORDER BY message_id ASC;
```

#### save_image_matching(file_hash, file_directory, file_type)
```sql
INSERT INTO image_matching (file_hash, file_directory, file_type)
VALUES (%s, %s, %s)
ON CONFLICT (file_hash) DO NOTHING;
```

#### get_image_by_hash(file_hash)
```sql
SELECT file_directory FROM image_matching WHERE file_hash = %s;
```

### 3.4 schemas.py (Pydantic 스키마)

**역할**: 요청/응답 데이터 검증

**주요 스키마**:

```python
class GenerateRequest(BaseModel):
    user_id: int | None
    input_text: str = Field(min_length=1, max_length=500)
    aspect_ratio: Literal["1:1", "4:3", "3:4"]

class TaskStatus(BaseModel):
    status: Literal["pending", "processing", "completed", "failed"]
    progress: int = Field(ge=0, le=100)
    result: dict | None
    error: str | None

class SignupRequest(BaseModel):
    login_id: str = Field(min_length=3, max_length=20, pattern="^[a-zA-Z0-9]+$")
    login_pw: str = Field(min_length=8, max_length=30)

class LoginRequest(BaseModel):
    login_id: str
    login_pw: str

class GenerationHistoryItem(BaseModel):
    id: int
    output_url: str
    created_at: datetime
    style: str | None
    aspect_ratio: str

class ChatMessage(BaseModel):
    role: Literal["user", "assistant"]
    content: str
    image_url: str | None
    created_at: datetime
```

---

## 4. 이미지 생성 영역 (이현석)

### 4.1 담당 범위
- **디렉토리**: `generation/image_generation/`
- **주요 업무**: AI 모델 선택, 이미지 생성, 후처리

### 4.2 UnifiedImageGenerator 클래스

**역할**: 통합 이미지 생성 클래스

**초기화**:
```python
입력:
  - model_type: "sdxl" | "flux" | "qwen"  (기본값: "auto")
  - device: "cuda" | "cpu"

동작:
  - 지정된 모델 로드
  - GPU 메모리 확인
```

**주요 함수**:

#### generate(prompt, aspect_ratio, negative_prompt=None)
```python
입력:
  - prompt: str (태그 형태)
      예: "cafe, new menu, warm, cozy, latte art, winter, promotional"
  - aspect_ratio: "1:1" | "4:3" | "3:4"
  - negative_prompt: str (선택)
      예: "low quality, blurry, text, watermark"

처리:
1. 비율에 따른 해상도 계산
   - "1:1" → 1024x1024
   - "4:3" → 1024x768
   - "3:4" → 768x1024

2. 모델 자동 선택 (model_type="auto"인 경우)
   - decide_model(prompt)
     조건: 프롬프트에 "realistic", "photo" → Flux
           프롬프트에 "anime", "illustration" → SDXL
           기본값 → SDXL (속도 우선)

3. 이미지 생성
   - generate_t2i(prompt, resolution, negative_prompt)

4. 후처리
   - postprocess_image(image, aspect_ratio)

출력:
  - image_path: str (로컬 경로)
  - metadata: dict {
      model: "sdxl",
      seed: 12345,
      style: "warm, cozy",
      resolution: "1024x768"
    }
```

#### decide_model(prompt)
```python
입력: prompt (str)

처리:
  - 키워드 분석
    "realistic", "photo", "portrait" → Flux
    "anime", "cartoon", "illustration" → SDXL
    기본값 → SDXL

출력: "sdxl" | "flux"
```

#### generate_t2i(prompt, resolution, negative_prompt)
```python
입력:
  - prompt: str
  - resolution: tuple (width, height)
  - negative_prompt: str

처리:
1. 시드 생성 (랜덤 또는 고정)
2. 모델 파이프라인 호출
   - SDXL: StableDiffusionXLPipeline
   - Flux: FluxPipeline
3. 추론 실행
   - num_inference_steps: 30 (SDXL), 50 (Flux)
   - guidance_scale: 7.5

출력: PIL.Image 객체
```

#### postprocess_image(image, aspect_ratio)
```python
입력:
  - image: PIL.Image
  - aspect_ratio: str

처리:
1. 리사이징 (이미 generate()에서 처리됨)
2. 압축
   - JPEG 품질: 85
   - 파일 크기 < 2MB 목표
3. 임시 파일로 저장

출력: image_path (str)
```

#### add_text_overlay(image, text, position="bottom")
```python
입력:
  - image: PIL.Image
  - text: str (광고 문구)
  - position: "top" | "bottom" | "center"

처리:
1. PIL.ImageDraw로 텍스트 렌더링
2. 폰트 크기 자동 조정 (이미지 너비의 5%)
3. 배경 반투명 박스 추가
4. 텍스트 중앙 정렬

출력: PIL.Image (텍스트 포함)
```

### 4.3 ControlNet 지원 (선택 기능, 2차 이후)

#### generate_controlnet(prompt, control_image, aspect_ratio)
```python
입력:
  - prompt: str
  - control_image: PIL.Image (사용자 로고)
  - aspect_ratio: str

처리:
1. ControlNet 전처리
   - preprocess_image(control_image)
     배경 제거, 밝기 조정
2. ControlNet 파이프라인 호출
3. 후처리

출력: image_path, metadata
```

---

## 5. 텍스트 및 프롬프트 생성 영역 (배현석)

### 5.1 담당 범위
- **디렉토리**: `generation/text_generation/`
- **주요 업무**: GPT API 연동, 프롬프트 템플릿 관리

### 5.2 PromptTemplateManager 클래스

**역할**: 이미지/텍스트 생성용 프롬프트 템플릿 관리

**주요 함수**:

#### generate_image_prompt(user_input)
```python
입력: user_input (str)
  예: "카페 신메뉴 홍보, 따뜻한 느낌, 겨울 시즌"

처리:
1. GPT API 호출
   - 시스템 프롬프트:
     "당신은 이미지 생성을 위한 태그 추출 전문가입니다.
      사용자 입력을 분석하여 Stable Diffusion에 적합한 
      영문 태그를 쉼표로 구분하여 생성하세요."
   
   - 사용자 프롬프트:
     "입력: {user_input}
      업종: 카페
      스타일: 따뜻한, 아늑한
      계절: 겨울
      
      위 정보를 바탕으로 이미지 생성 태그를 만들어주세요."

2. 응답 파싱
   - GPT 응답: "cafe interior, warm lighting, cozy atmosphere, 
                 latte art, winter season, new menu board, ..."

3. 품질 태그 추가
   - 기본 추가: "high quality, detailed, professional"

출력: prompt (str)
```

#### generate_text_prompt(user_input)
```python
입력: user_input (str)

처리:
1. GPT API 호출
   - 시스템 프롬프트:
     "당신은 광고 카피라이터입니다. 
      소상공인을 위한 짧고 임팩트 있는 광고 문구를 만들어주세요."
   
   - 사용자 프롬프트:
     "업종: 카페
      내용: {user_input}
      
      다음 요구사항을 충족하는 광고 문구를 생성하세요:
      - 20자 이내
      - 감성적이고 따뜻한 톤
      - 계절감 반영"

2. 응답 파싱

출력: ad_copy (str)
  예: "따뜻한 겨울, 새로운 맛과 함께"
```

### 5.3 TextGenerator 클래스

**역할**: GPT API 연동 및 텍스트 생성

**초기화**:
```python
입력: api_key (str)

동작:
  - OpenAI 클라이언트 초기화
  - 기본 모델: "gpt-4o-mini" (비용 절감)
```

**주요 함수**:

#### generate_ad_copy(user_input, tone="warm")
```python
입력:
  - user_input: str
  - tone: "warm" | "professional" | "friendly" | "energetic"

처리:
1. 톤별 시스템 프롬프트 선택
   - warm: "따뜻하고 감성적인 톤으로..."
   - professional: "전문적이고 신뢰감 있는 톤으로..."

2. GPT API 호출
   - model: "gpt-4o-mini"
   - temperature: 0.7
   - max_tokens: 100

3. 응답 후처리
   - 특수문자 제거
   - 길이 제한 (30자 이내)

출력: ad_copy (str)
```

#### extract_keywords(user_input)
```python
입력: user_input (str)

처리:
1. GPT API 호출
   - "다음 입력에서 핵심 키워드를 추출하세요: {user_input}"

2. 응답 파싱
   - 쉼표로 구분된 키워드 리스트

출력: keywords (List[str])
  예: ["카페", "신메뉴", "겨울", "따뜻한"]
```

---

## 6. 인프라 영역 (신승목)

### 6.1 담당 범위
- **디렉토리**: `deployment/`, `tests/`, `backend/utils/`
- **주요 업무**: Docker, CI/CD, 파일 저장, 테스트

### 6.2 utils/storage.py

**역할**: 파일 저장 및 로드

**주요 함수**:

#### save_image(image_path, user_id)
```python
입력:
  - image_path: str (로컬 임시 파일 경로)
  - user_id: int | None

처리:
1. 파일 해시 계산
   - hashlib.sha256(file_content).hexdigest()

2. 저장 경로 결정
   - GCS: gs://bucket/generated_images/{user_id}/{hash}.png
   - 로컬: /storage/generated_images/{user_id}/{hash}.png

3. 파일 업로드
   - GCS: google.cloud.storage 사용
   - 로컬: shutil.copy()

4. DB 저장
   - db_processor.save_image_matching(file_hash, path, "generated")

출력: image_url (str)
  - GCS: 공개 URL
  - 로컬: 상대 경로
```

#### load_image(file_hash)
```python
입력: file_hash (str)

처리:
1. DB 조회
   - db_processor.get_image_by_hash(file_hash)

2. 파일 로드
   - GCS: 다운로드 URL 생성
   - 로컬: 파일 경로 반환

출력: image_url (str)
```

### 6.3 utils/validators.py

**역할**: 입력 유효성 검증

**주요 함수**:

#### validate_login_id(login_id)
```python
입력: login_id (str)

검증:
  - 길이: 3-20자
  - 허용 문자: 영문, 숫자
  - 정규식: ^[a-zA-Z0-9]+$

출력: bool (통과 여부)
```

#### validate_password(password)
```python
입력: password (str)

검증:
  - 길이: 8-30자
  - 필수 포함: 영문, 숫자
  - 권장 포함: 특수문자

출력: bool
```

### 6.4 Docker 설정

#### deployment/docker/backend/Dockerfile
```dockerfile
목적: FastAPI 앱 컨테이너화

주요 내용:
  - Base image: python:3.10-slim
  - 의존성 설치: requirements.txt
  - 작업 디렉토리: /app
  - 포트: 8000
  - 실행 명령: uvicorn backend.routes:app --host 0.0.0.0
```

#### deployment/docker/docker-compose.yml
```yaml
목적: 전체 서비스 오케스트레이션

서비스:
  - backend: FastAPI
  - postgres: PostgreSQL 15
  - (선택) gpu_server: 이미지 생성 서버

네트워크:
  - 내부 네트워크로 서비스 간 통신
```

### 6.5 CI/CD (.github/workflows/deploy.yml)

**트리거**: main 브랜치 푸시

**작업 단계**:
1. 코드 체크아웃
2. 의존성 설치
3. 테스트 실행
   - pytest tests/
4. Docker 이미지 빌드
5. GCP 배포
   - Cloud Run에 이미지 푸시
6. 배포 완료 알림

### 6.6 tests/

#### tests/test_api.py
```python
목적: API 엔드포인트 테스트

테스트 케이스:
  - test_generate_endpoint()
    POST /generate 요청 후 task_id 수신 확인
  
  - test_signup_success()
    회원가입 성공 시나리오
  
  - test_signup_duplicate()
    중복 ID 에러 처리 확인
  
  - test_login_success()
    로그인 성공 및 토큰 발급 확인
```

#### tests/test_image_generation.py
```python
목적: 이미지 생성 모듈 테스트

테스트 케이스:
  - test_generate_t2i()
    텍스트→이미지 생성 확인
  
  - test_postprocess()
    후처리 (리사이징, 압축) 확인
```

---

## 7. 모듈 간 통신 규약

### 7.1 데이터 전달 형식
- **프론트 ↔ 백엔드**: JSON (REST API)
- **백엔드 ↔ AI 모델**: Python 함수 호출
- **백엔드 ↔ DB**: SQL 쿼리

### 7.2 에러 코드 규약
| 코드 | 의미 | 처리 |
|------|------|------|
| 400 | 잘못된 요청 | 입력 검증 실패 |
| 401 | 인증 실패 | 로그인 필요 |
| 409 | 중복 데이터 | ID 중복 등 |
| 500 | 서버 에러 | AI 모델 실패 등 |

### 7.3 비동기 작업 상태
- **pending**: 대기 중
- **processing**: 생성 중
- **completed**: 완료
- **failed**: 실패

---

## 8. 에러 처리 규약

### 8.1 프론트엔드
```javascript
try {
  const result = await backendClient.generateAd(...)
} catch (error) {
  if (error.status === 400) {
    // 입력 오류 메시지 표시
  } else if (error.status === 500) {
    // "일시적인 오류가 발생했습니다" 표시
  }
}
```

### 8.2 백엔드
```python
try:
  result = UnifiedImageGenerator.generate(...)
except ModelNotLoadedError:
  # Task 상태를 "failed"로 업데이트
  # 에러 로그 기록
except Exception as e:
  # 일반 에러 처리
  logging.error(f"Unexpected error: {e}")
```

### 8.3 로깅
- **레벨**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **형식**: `[시간] [레벨] [모듈] 메시지`
- **저장**: 파일 (로컬) 또는 Cloud Logging (배포)

---

## 부록: 개발 우선순위 (4주 일정)

### 1주차
- 인프라: Docker, DB 설정
- 백엔드: routes.py, schemas.py 기본 구조
- 프론트엔드: 챗봇 UI 프로토타입

### 2주차
- 이미지 생성: SDXL 기본 연동
- 텍스트 생성: GPT API 연동
- 백엔드: 전체 워크플로우 통합

### 3주차
- 프론트엔드: 이력 관리 UI
- 백엔드: 인증 시스템
- 통합 테스트

### 4주차
- 배포 (Vercel + Cloud Run)
- 버그 수정
- 사용성 테스트
