# Phase 5: 대화 히스토리 연동 가이드

> **작성일**: 2026-01-16
> **작성자**: 진수경
> **목적**: 생성 모듈 담당자분들께 변경사항 안내

---

## 개요

기존에는 광고 생성 시 **현재 메시지만** 사용하여 프롬프트를 생성했습니다.
이번 업데이트로 **대화 히스토리**를 프롬프트에 포함하여 **맥락 기반 생성**이 가능해졌습니다.

### Before (기존)
```
사용자: "딸기라떼 광고 만들어줘"
→ 프롬프트 생성 (맥락 없음)
→ 광고 생성
```

### After (개선)
```
사용자: "따뜻하고 아늑한 느낌으로 해줘"
사용자: "딸기라떼 광고 만들어줘"
→ 대화 히스토리 조회 (최근 10개)
→ 프롬프트 생성 ("따뜻하고 아늑한 느낌" 반영)
→ 맥락 기반 광고 생성
```

---

## 1. 텍스트 생성 (TextGenerator)

### 담당자: 배현석 -> 이유노

### 변경 파일
`src/generation/text_generation/text_generator.py`

### 변경 내용

#### 1.1 `generate_ad_copy()` 함수 시그니처 변경

```python
# Before
def generate_ad_copy(self, user_input, tone="warm", max_length=20):

# After
def generate_ad_copy(self, user_input, tone="warm", max_length=20, conversation_history=None):
```

#### 1.2 새로운 파라미터

| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `conversation_history` | `list[dict]` | 선택 | 대화 히스토리 |

**conversation_history 형식:**
```python
[
    {"role": "user", "content": "카페 광고 만들고 싶어"},
    {"role": "assistant", "content": "어떤 스타일을 원하세요?"},
    {"role": "user", "content": "따뜻하고 아늑한 느낌으로"},
    ...
]
```

#### 1.3 내부 동작 변경

`_build_user_prompt()` 함수에서 대화 히스토리를 프롬프트에 포함:

```python
def _build_user_prompt(self, user_input, max_length, conversation_history=None):
    conversation_context = ""
    if conversation_history and len(conversation_history) > 0:
        # 최근 5개 메시지만 사용 (토큰 절약)
        recent_messages = conversation_history[-5:]
        conv_str = "\n".join([
            f"- {msg['role']}: {msg['content'][:100]}"
            for msg in recent_messages
        ])
        conversation_context = f"""
대화 맥락:
사용자가 AI 어시스턴트와 대화를 나누고 있습니다. 이전 대화를 참고하여 더 맞춤형 광고 문구를 생성하세요:
{conv_str}

이전 대화에서 언급된 스타일, 선호도, 세부사항을 반영하세요.
"""
    # ... 프롬프트 구성
```

#### 1.4 호환성

- `conversation_history`는 **선택적 파라미터**
- 기존 호출 방식 그대로 동작 (하위 호환성 보장)

```python
# 기존 방식 (여전히 동작)
text_gen.generate_ad_copy(user_input="딸기라떼 광고", tone="warm")

# 새로운 방식 (대화 히스토리 포함)
text_gen.generate_ad_copy(
    user_input="딸기라떼 광고",
    tone="warm",
    conversation_history=[...]
)
```

---

## 2. 이미지 생성 (PromptTemplateManager + Generator)

### 담당자: 이현석

### 변경 파일
1. `src/generation/image_generation/prompt/prompt_manager.py`
2. `src/generation/image_generation/generator.py`

---

### 2.1 PromptTemplateManager 변경

#### 변경된 함수 시그니처

```python
# Before
def generate_detailed_prompt(self, user_input: str, style: str = "realistic") -> dict:

# After
def generate_detailed_prompt(self, user_input: str, style: str = "realistic", conversation_history: list = None) -> dict:
```

#### 새로운 파라미터

| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `conversation_history` | `list[dict]` | 선택 | 대화 히스토리 |

#### 내부 동작 변경

GPT에게 전달하는 프롬프트에 대화 컨텍스트 추가:

```python
# 대화 히스토리 컨텍스트 구성
conversation_context = ""
if conversation_history and len(conversation_history) > 0:
    recent_messages = conversation_history[-5:]
    conv_str = "\n".join([
        f"- {msg['role']}: {msg['content'][:100]}"
        for msg in recent_messages
    ])
    conversation_context = f"""
===== CONVERSATION CONTEXT =====
The user has been chatting with an AI assistant. Consider this context when generating the prompt:
{conv_str}

Use this context to understand what the user wants (e.g., style preferences, specific details mentioned earlier).
=================================
"""
```

#### GPT 프롬프트 변경

사용자 프롬프트 끝에 다음 지시 추가:
```
- If conversation context provided, incorporate any specific details or preferences mentioned
```

---

### 2.2 Generator 변경

#### 변경된 함수 시그니처

```python
# Before
def generate_and_save_image(
    user_input: str,
    style: Literal[...] = "realistic",
    aspect_ratio: Literal[...] = "1:1",
    ...
) -> Dict[str, Any]:

# After
def generate_and_save_image(
    user_input: str,
    style: Literal[...] = "realistic",
    aspect_ratio: Literal[...] = "1:1",
    ...
    conversation_history: Optional[list] = None,  # 추가됨
) -> Dict[str, Any]:
```

#### 새로운 파라미터

| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| `conversation_history` | `list[dict]` | 선택 | 대화 히스토리 |

#### 내부 동작 변경

PromptTemplateManager 호출 시 대화 히스토리 전달:

```python
prompt_generator = PromptTemplateManager()
prompt_result = prompt_generator.generate_detailed_prompt(
    user_input=user_input,
    style=style,
    conversation_history=conversation_history  # 추가됨
)
```

---

## 3. 백엔드 연동 (services.py)

### 호출 방식

백엔드에서는 다음과 같이 대화 히스토리를 조회하여 전달합니다:

```python
# 대화 히스토리 조회 (최근 10개)
chatbot = get_chatbot()
conversation_history = chatbot.conv.get_recent_messages(db, session_id, limit=10)

# 텍스트 생성
ad_copy = text_gen.generate_ad_copy(
    user_input=input_text,
    tone="warm",
    max_length=20,
    conversation_history=conversation_history
)

# 이미지 생성
img_result = generate_and_save_image(
    user_input=input_text,
    style="ultra_realistic",
    aspect_ratio="1:1",
    conversation_history=conversation_history
)
```

---

## 4. 테스트 방법

### 4.1 텍스트 생성 테스트

```python
from src.generation.text_generation.text_generator import TextGenerator

gen = TextGenerator()

# 대화 히스토리 시뮬레이션
history = [
    {"role": "user", "content": "카페 광고 만들고 싶어"},
    {"role": "assistant", "content": "어떤 스타일을 원하세요?"},
    {"role": "user", "content": "따뜻하고 아늑한 느낌으로"},
]

result = gen.generate_ad_copy(
    user_input="딸기라떼 신메뉴 홍보",
    tone="warm",
    conversation_history=history
)
print(result)
# 예상: "따뜻한 느낌"이 반영된 문구
```

### 4.2 이미지 생성 테스트

```python
from src.generation.image_generation.generator import generate_and_save_image

history = [
    {"role": "user", "content": "밝고 화사한 느낌으로 해줘"},
    {"role": "assistant", "content": "밝고 화사한 스타일로 만들어 드릴게요"},
]

result = generate_and_save_image(
    user_input="카페 딸기라떼 광고",
    style="realistic",
    conversation_history=history
)
print(result["prompt"])
# 예상: "bright", "vibrant" 등의 키워드가 포함된 프롬프트
```

---

## 5. 요약

| 모듈 | 파일 | 변경된 함수 | 새 파라미터 |
|------|------|-------------|-------------|
| 텍스트 생성 | `text_generator.py` | `generate_ad_copy()` | `conversation_history` |
| 프롬프트 생성 | `prompt_manager.py` | `generate_detailed_prompt()` | `conversation_history` |
| 이미지 생성 | `generator.py` | `generate_and_save_image()` | `conversation_history` |

### 핵심 포인트
1. 모든 파라미터는 **선택적** (하위 호환성 보장)
2. 최근 **5개 메시지**만 프롬프트에 포함 (토큰 절약)
3. 백엔드에서 최근 **10개 메시지** 조회 후 전달

---

## 문의

질문이나 이슈가 있으시면 진수경에게 연락해주세요.
