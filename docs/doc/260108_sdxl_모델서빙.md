# GCP VM에서 SDXL 모델 공유 설정 가이드

## 다중 사용자 공유를 위한 올바른 설정
- 필요한 모델명: stabilityai/stable-diffusion-xl-base-1.0

---

## (완료) 1. 공유 모델 디렉토리 초기 설정

### 1.1 AI 사용자 그룹 생성 (다중 사용자 환경)

```bash
# AI 모델 전용 그룹 생성
sudo groupadd ai-users

# 현재 사용자를 그룹에 추가
sudo usermod -aG ai-users $USER

# 다른 팀원 추가 (5명 예시)
# spai0415, spai0416, spai0426, spai0411, spai0438
sudo usermod -aG ai-users user2
sudo usermod -aG ai-users user3
sudo usermod -aG ai-users user4
sudo usermod -aG ai-users user5

# 그룹 추가 확인
groups
# 출력에 ai-users가 포함되어야 함
```

**참고**: `$USER`는 환경 변수로 자동으로 현재 사용자 이름으로 치환됩니다.

### 1.2 공유 모델 디렉토리 생성

```bash
# 모델 저장 디렉토리 생성
sudo mkdir -p /opt/ai-models/sdxl
# sudo mkdir -p /opt/ai-models/flux

# 그룹 소유권 및 권한 설정
sudo chown -R root:ai-users /opt/ai-models
sudo chmod -R 775 /opt/ai-models

# setgid 설정 (새 파일이 자동으로 ai-users 그룹 상속)
sudo chmod g+s /opt/ai-models
sudo chmod g+s /opt/ai-models/sdxl
# sudo chmod g+s /opt/ai-models/flux

# 권한 확인
ls -la /opt/ai-models
# 예상 결과:
# drwxrwsr-x 3 root ai-users 4096 Jan  8 01:44 .
# drwxrwsr-x 2 root ai-users 4096 Jan  8 01:44 sdxl
#       ↑
#       's' 확인 (setgid 설정됨)
```

### 1.3 그룹 적용 및 확인

```bash
# 그룹 변경 적용 (재로그인 또는)
newgrp ai-users

# 확인
id
# 출력 예: uid=1001(user) gid=1001(user) groups=1001(user),1002(ai-users)
```

---

## (완료) 2. 프로젝트에서 심볼릭 링크 생성

### 2.1 각 사용자별 설정

```bash
# 프로젝트 디렉토리로 이동
cd ~/codeit_ad_smallbiz/

# 기존 models 디렉토리가 있다면 제거
rm -rf models

# 심볼릭 링크 생성
ln -s /opt/ai-models models

# 확인
ls -la | grep models
# 출력: lrwxrwxrwx ... models -> /opt/ai-models
```

### 2.2 디렉토리 구조 확인

```bash
cd ~/codeit_ad_smallbiz/
tree -L 2 models/
# models/
# ├── sdxl/
# └── flux/
```

---

## (완료) 3. Hugging Face Token 설정 (선택사항)

SDXL Base 1.0은 공개 모델이므로 토큰 없이도 다운로드 가능하지만, 설정해두면 더 안정적입니다.

### 3.1 Token 발급

1. https://huggingface.co/ 로그인
2. 프로필 → Settings → Access Tokens
3. "New token" 클릭
4. Token 타입: **Read** 선택
5. 이름 입력 (예: `gcp-vm-sdxl`)
6. 생성된 토큰 복사

### 3.2 프로젝트 .env 파일에 추가

```bash
cd ~/codeit_ad_smallbiz/
nano .env
```

`.env` 파일 내용:
```env
# OpenAI
OPENAI_API_KEY=your_openai_key_here

# Hugging Face (선택사항)
HF_TOKEN=hf_xxxxxxxxxxxxxxxxxxxxxxxxxx

# Database
DATABASE_URL=postgresql://user:password@localhost:5432/adbizdb
```

---

## 4. SDXL 모델 다운로드

### 4.1 다운로드 스크립트 생성

```bash
# 가상환경 활성화
cd ~/codeit_ad_smallbiz/
source source /opt/jhub-venv/bin/activate

# 필요한 패키지 설치
pip install huggingface_hub python-dotenv

# 다운로드 스크립트 생성
cd /opt/ai-models/sdxl
cat > download_sdxl_minimal.py << 'EOF'
from huggingface_hub import hf_hub_download
import os
from pathlib import Path
from dotenv import load_dotenv

# .env 파일 로드 (프로젝트 루트에서)
env_path = Path.home() / "codeit_ad_smallbiz" / ".env"
load_dotenv(dotenv_path=env_path)
hf_token = os.getenv("HF_TOKEN")

repo_id = "stabilityai/stable-diffusion-xl-base-1.0"
local_dir = "/opt/ai-models/sdxl"

print("=" * 60)
print("SDXL 최소 파일만 다운로드 (약 9-10GB)")
print("=" * 60)
print(f"저장 위치: {local_dir}")
print(f"HF_TOKEN: {'사용' if hf_token else '미사용 (공개 모델은 문제없음)'}")
print()

# 필수 파일 목록
files_to_download = [
    "sd_xl_base_1.0.safetensors",           # 메인 모델 (6.9GB)
    "model_index.json",                      # 설정 파일
    "vae/config.json",
    "vae/diffusion_pytorch_model.safetensors",
    "text_encoder/config.json",
    "text_encoder/model.safetensors",
    "text_encoder_2/config.json", 
    "text_encoder_2/model.safetensors",
    "tokenizer/merges.txt",
    "tokenizer/special_tokens_map.json",
    "tokenizer/tokenizer_config.json",
    "tokenizer/vocab.json",
    "tokenizer_2/merges.txt",
    "tokenizer_2/special_tokens_map.json",
    "tokenizer_2/tokenizer_config.json",
    "tokenizer_2/vocab.json",
    "scheduler/scheduler_config.json",
]

for i, filename in enumerate(files_to_download, 1):
    print(f"[{i}/{len(files_to_download)}] 다운로드: {filename}")
    try:
        hf_hub_download(
            repo_id=repo_id,
            filename=filename,
            local_dir=local_dir,
            local_dir_use_symlinks=False,
            token=hf_token,
            resume_download=True,
        )
        print(f"  ✅ 완료\n")
    except Exception as e:
        print(f"  ⚠️  오류: {e}\n")

print("=" * 60)
print("✅ 다운로드 완료!")
print("=" * 60)

# 용량 확인
import subprocess
result = subprocess.run(['du', '-sh', local_dir], capture_output=True, text=True)
print(f"총 용량: {result.stdout.split()[0]}")
EOF
```

### 4.2 다운로드 실행

```bash
# 디스크 공간 확인 (최소 15GB 필요)
df -h /opt/ai-models

# 다운로드 실행
python download_sdxl_minimal.py
```

**예상 소요 시간**: 5-20분 (네트워크 속도에 따라)

### 4.3 다운로드 확인

```bash
# 파일 목록 확인
ls -lh /opt/ai-models/sdxl/

# 권한 확인 (ai-users 그룹이어야 함)
ls -la /opt/ai-models/sdxl/ | head -5
# -rw-rw-r-- 1 youruser ai-users ... sd_xl_base_1.0.safetensors

# 총 용량 확인
du -sh /opt/ai-models/sdxl/
# 예상: 9.0G ~ 10G
```

---

## 5. .gitignore 설정

프로젝트 루트의 `.gitignore`:

```bash
cd ~/codeit_ad_smallbiz/
nano .gitignore
```

`.gitignore` 내용:
```gitignore
# AI 모델 파일 (심볼릭 링크)
models/

# 데이터 파일
data/images/input/*
data/images/generated/*
!data/images/input/.gitkeep
!data/images/generated/.gitkeep

# 로그 파일
logs/

# 환경 변수
.env
.env.local

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/

# IDE
.vscode/
.idea/
```

---

## 6. 프로젝트 설정 파일 업데이트

### 6.1 src/utils/config.py

```python
from pathlib import Path
import os
import sys
from dotenv import load_dotenv

load_dotenv()

# 프로젝트 루트 디렉토리
PROJECT_ROOT = Path(__file__).parent.parent.parent

# 모델 디렉토리 (심볼릭 링크를 통해 /opt/ai-models를 가리킴)
MODELS_DIR = PROJECT_ROOT / "models"
SDXL_MODEL_PATH = MODELS_DIR / "sdxl"
FLUX_MODEL_PATH = MODELS_DIR / "flux"

# 데이터 디렉토리
DATA_DIR = PROJECT_ROOT / "data"
IMAGES_DIR = DATA_DIR / "images"
INPUT_IMAGES_DIR = IMAGES_DIR / "input"
GENERATED_IMAGES_DIR = IMAGES_DIR / "generated"


def validate_model_access():
    """모델 디렉토리 접근 권한 검증"""
    if not MODELS_DIR.exists():
        print(f"❌ 오류: 모델 디렉토리가 없습니다: {MODELS_DIR}")
        print("다음 명령으로 심볼릭 링크를 생성하세요:")
        print(f"  cd {PROJECT_ROOT} && ln -s /opt/ai-models models")
        sys.exit(1)
    
    if not SDXL_MODEL_PATH.exists():
        print(f"❌ 오류: SDXL 모델이 없습니다: {SDXL_MODEL_PATH}")
        print("README.md의 '모델 설치 가이드'를 참고하여 모델을 다운로드하세요.")
        sys.exit(1)
    
    # 읽기 권한 확인
    test_file = SDXL_MODEL_PATH / "model_index.json"
    if test_file.exists():
        try:
            with open(test_file, 'r') as f:
                f.read(1)
            print(f"✅ 모델 디렉토리 접근 가능: {MODELS_DIR}")
        except PermissionError:
            print(f"❌ 오류: 모델 디렉토리 읽기 권한 없음")
            print("다음 명령으로 그룹에 추가하세요:")
            print(f"  sudo usermod -aG ai-users $USER")
            print("  newgrp ai-users")
            sys.exit(1)


class Settings:
    # OpenAI
    OPENAI_API_KEY: str = os.getenv("OPENAI_API_KEY")
    
    # Hugging Face
    HF_TOKEN: str = os.getenv("HF_TOKEN")
    
    # 모델 경로
    SDXL_MODEL_PATH: Path = SDXL_MODEL_PATH
    FLUX_MODEL_PATH: Path = FLUX_MODEL_PATH
    
    # 데이터베이스
    DATABASE_URL: str = os.getenv(
        "DATABASE_URL", 
        "postgresql://user:password@localhost:5432/adbizdb"
    )


settings = Settings()

# 앱 시작 시 자동 검증 (import 시에만)
if __name__ != "__main__":
    validate_model_access()
```

### 6.2 src/generation/image_generation/unified_generator.py

```python
from diffusers import StableDiffusionXLPipeline
import torch
from src.utils.config import settings

class ImageGenerator:
    def __init__(self):
        self.pipe = None
        
    def load_model(self):
        """SDXL 모델 로드"""
        model_path = settings.SDXL_MODEL_PATH
        
        # 모델 경로 검증
        if not model_path.exists():
            raise FileNotFoundError(
                f"SDXL 모델을 찾을 수 없습니다: {model_path}\n"
                f"README.md의 모델 설치 가이드를 참고하세요."
            )
        
        print(f"모델 로드 중: {model_path}")
        
        self.pipe = StableDiffusionXLPipeline.from_pretrained(
            str(model_path),
            torch_dtype=torch.float16,
            use_safetensors=True,
            variant="fp16"
        )
        
        # GPU 사용 (L4 GPU)
        if torch.cuda.is_available():
            self.pipe = self.pipe.to("cuda")
            print("✅ GPU(CUDA) 사용")
        else:
            print("⚠️  CPU 사용 (느림)")
        
    async def generate(self, prompt: str, **kwargs):
        """이미지 생성"""
        if self.pipe is None:
            self.load_model()
            
        image = self.pipe(
            prompt=prompt,
            num_inference_steps=kwargs.get("steps", 30),
            guidance_scale=kwargs.get("guidance_scale", 7.5)
        ).images[0]
        
        return image
```

---

## 7. README.md 업데이트

프로젝트의 `README.md`에 추가:

```markdown
## 모델 설치 가이드

### 전제 조건
- GCP VM 인스턴스 (GPU 권장: NVIDIA L4)
- Python 3.10+
- 디스크 여유 공간: 최소 15GB

### 1. AI 사용자 그룹 설정 (최초 1회)

```bash
# AI 모델 전용 그룹 생성
sudo groupadd ai-users

# 현재 사용자를 그룹에 추가
sudo usermod -aG ai-users $USER

# 그룹 적용
newgrp ai-users

# 확인
groups  # ai-users가 출력되어야 함
```

### 2. 모델 디렉토리 설정

```bash
# 디렉토리 생성
sudo mkdir -p /opt/ai-models/sdxl
sudo mkdir -p /opt/ai-models/flux

# 그룹 소유권 및 권한 설정
sudo chown -R root:ai-users /opt/ai-models
sudo chmod -R 775 /opt/ai-models
sudo chmod g+s /opt/ai-models

# 프로젝트에서 심볼릭 링크 생성
cd ~/codeit_ad_smallbiz/
ln -s /opt/ai-models models
```

### 3. 환경 변수 설정

`.env` 파일 생성:

```env
OPENAI_API_KEY=your_openai_key_here
HF_TOKEN=hf_xxxxxxxxxxxxxxxxxxxxxxxxxx  # 선택사항
DATABASE_URL=postgresql://user:password@localhost:5432/adbizdb
```

### 4. SDXL 모델 다운로드

```bash
# 가상환경 활성화
source venv/bin/activate

# 필요한 패키지 설치
pip install huggingface_hub python-dotenv

# 다운로드 스크립트 실행
cd /opt/ai-models/sdxl
python download_sdxl_minimal.py
```

다운로드 스크립트는 `/opt/ai-models/sdxl/download_sdxl_minimal.py`에 있습니다.

### 5. 새 팀원 추가 시

```bash
# 신규 사용자를 ai-users 그룹에 추가
sudo usermod -aG ai-users newuser

# 해당 사용자로 재로그인 후
newgrp ai-users
```

### 디렉토리 구조

```
/opt/ai-models/           # 공유 모델 저장소
├── sdxl/                 # SDXL 모델 (~10GB)
└── flux/                 # Flux 모델 (추후)

~/codeit_ad_smallbiz/
├── models -> /opt/ai-models  # 심볼릭 링크
├── src/
├── data/
└── .env
```
```

---

## 8. 테스트

### 8.1 권한 테스트

```bash
# 쓰기 권한 확인
cd /opt/ai-models/sdxl
touch test.txt
ls -la test.txt
# -rw-rw-r-- 1 youruser ai-users ... test.txt

# 정리
rm test.txt
```

### 8.2 모델 로드 테스트

```bash
cd ~/codeit_ad_smallbiz/
source venv/bin/activate

python << 'EOF'
from src.utils.config import settings
from pathlib import Path

print(f"SDXL 모델 경로: {settings.SDXL_MODEL_PATH}")
print(f"경로 존재 여부: {settings.SDXL_MODEL_PATH.exists()}")

if settings.SDXL_MODEL_PATH.exists():
    print("\n모델 파일:")
    for f in settings.SDXL_MODEL_PATH.iterdir():
        print(f"  - {f.name}")
EOF
```

---

## 요약

✅ **완료된 설정**:
1. 다중 사용자가 공유할 수 있는 `/opt/ai-models` 디렉토리 생성
2. `ai-users` 그룹으로 권한 관리
3. 심볼릭 링크로 프로젝트와 연결
4. Git에는 모델 파일이 포함되지 않음
5. 필요한 파일만 선택적으로 다운로드 (9-10GB)

✅ **장점**:
- 모델 파일 중복 없음
- 팀원 모두 읽기/쓰기 가능
- Git 저장소 경량 유지
- 새 팀원 추가 간단