# 이미지 생성 모듈 (Image Generation Module)

## 1. 아키텍처: 노드 기반 파이프라인

**노드 기반 아키텍처**로 설계했습니다.

```
[입력] → [전처리 노드] → [생성 노드] → [후처리 노드] → [출력]
```

**장점:**
- 각 노드가 독립적으로 동작하여 스크립트 간 의존성 최소화
- 노드 단위로 교체/추가가 가능하여 유지보수 용이
- 각 노드의 실행 시간, 상태 등 메타데이터 자동 추적

**디렉토리 구조:**
```
image_generation/
├── config.py              # 설정 (해상도, 스텝 수 등)
├── generator.py           # 메인 진입점
├── workflow.py            # 워크플로우 오케스트레이션
├── nodes/
│   ├── base.py            # BaseNode 추상 클래스
│   ├── text2image.py      # T2I 노드
│   ├── image2image.py     # I2I 노드
│   ├── controlnet.py      # ControlNet 노드
│   ├── preprocessing.py   # 전처리 노드
│   └── postprocessing.py  # 후처리 노드
```

---

## 2. 모델 선택 전략

### 2.1 3가지 스타일 체크포인트

사용자가 어떤 그림체를 선호할지 알 수 없어 3가지 스타일을 지원합니다.

| 스타일 | 모델 | 설명 |
|--------|------|------|
| Ultra Realistic | RealVisXL V4.0 | 실사 스타일 |
| Semi Realistic | BSS Equinox | 반실사 스타일 |
| Anime | Animagine XL 3.1 | 애니메이션 스타일 |

**선택 이유:**
- LoRA나 단일 Base Model로는 다양한 스타일 커버에 한계
- 병합된 체크포인트(Merged Checkpoint)가 스타일 일관성과 품질 면에서 가장 신뢰도 높음

### 2.2 VAE

**madebyollin/sdxl-vae-fp16-fix** - SDXL 최적화 VAE, FP16 NaN 문제 해결 버전

---

## 3. Text-to-Image / Image-to-Image 자동 분기

백엔드와의 소통 복잡도를 줄이기 위해 **단일 엔드포인트**로 설계했습니다.

```python
def generate_image(prompt, reference_image=None, ...):
    if reference_image is None:
        return text_to_image(prompt, ...)   # T2I
    else:
        return image_to_image(prompt, reference_image, ...)  # I2I (ControlNet)
```

**설계 이유:**
- T2I와 I2I는 `reference_image`를 제외하면 파라미터가 동일
- 백엔드에서 상황마다 다른 함수를 호출하도록 하면 소통 비용 증가
- `reference_image` 유무만으로 자동 분기하여 API 단순화

---

## 4. 메모리 관리

### 4.1 문제 상황

- L4 GPU 가용 VRAM: 약 22GB
- 체크포인트 파일 자체는 약 6GB지만, 실제 로드 시 (UNet + 텍스트 인코더 2개) 약 20GB 사용
- 즉, 모델 1개만 로드해도 VRAM 거의 전부 사용
- 3개 모델 동시 로드는 불가능

### 4.2 해결책

**Auto Unload:**
- 한 번에 하나의 체크포인트만 메모리에 유지
- 스타일 변경 시 기존 모델 자동 언로드 후 새 모델 로드

**VAE 캐싱:**
- 3개 체크포인트 모두 동일한 SDXL 기반 (파생 모델)
- 체크포인트마다 학습 방향만 다를 뿐, VAE는 공용 사용 가능
- VAE는 언로드하지 않고 캐시로 유지하여 불필요한 재로드 방지

---

## 5. 저장 전략

백엔드 요청에 따라 **해시 기반 파일명**을 사용합니다.

```
generated_images/
├── ab/                      # 해시 앞 2자리로 서브디렉토리
│   └── ab3f7c2d...png      # 전체 해시값 파일명
└── cd/
    └── cd9a1b2e...png
```

**장점:** 중복 이미지 자동 감지, 파일 시스템 최적화

---

## 6. 프롬프트 생성 시스템 개선 (예정)

### 6.1 현재 구조
```
[한글 입력] → [GPT 키워드 추출] → [HybridPromptBuilder] → [Prompt]
```
- 현재는 Realistic 스타일에 최적화된 템플릿만 존재

### 6.2 개선 방향

**새로운 파이프라인:**
```
[한글 입력 + User Input] → [GPT 키워드 추출] → [StyleRouter] → [Prompt]
       ↓                         ↓                    ↓
  의도 파악 강화            style/purpose 추출    스타일별 분기
```

**핵심 개선:**
- **User Input 통합**: GPT에 user input을 함께 전달하여 의도 파악 정확도 향상
- **StyleRouter 추가**: realistic / anime / illustration 스타일별 분기
- **텍스트 생성 방지**: 텍스트는 오버레이로 별도 처리하므로 이미지 내 텍스트 생성 차단
