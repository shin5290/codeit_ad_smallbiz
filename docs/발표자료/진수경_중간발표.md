# 백엔드 로직 중간발표 자료

**작성자:** 진수경
**작성일:** 2026-01-14

---

## 목차
1. [프로젝트 개요](#1-프로젝트-개요)
2. [기술 스택](#2-기술-스택)
3. [시스템 아키텍처](#3-시스템-아키텍처)
4. [데이터베이스 설계](#4-데이터베이스-설계)
5. [API 엔드포인트](#5-api-엔드포인트)
6. [핵심 비즈니스 로직](#6-핵심-비즈니스-로직)
7. [보안 및 인증](#7-보안-및-인증)
8. [작업 상태 관리](#8-작업-상태-관리)
9. [향후 개선 사항](#9-향후-개선-사항)

---

## 1. 프로젝트 개요

AI 기반 광고 생성 플랫폼의 백엔드 서버를 FastAPI로 구현했습니다. 사용자 인증, 광고 텍스트/이미지 생성, 채팅 세션 관리, 히스토리 관리 등의 기능을 제공합니다.

### 주요 기능
- 회원가입/로그인/회원정보 관리 (JWT 기반 인증)
- AI 광고 텍스트 생성
- AI 광고 이미지 생성 (Text-to-Image, Image-to-Image)
- 채팅 세션 관리 (게스트/로그인 사용자 구분)
- 생성 히스토리 저장 및 조회 (페이징 지원)
- 이미지 파일 관리 (해시 기반 중복 제거)
- 비동기 작업 처리 및 진행률 추적

---

## 2. 기술 스택

### Backend Framework
- **FastAPI**: 고성능 비동기 웹 프레임워크
- **Python 3.10+**

### Database
- **SQLAlchemy**: ORM (Object-Relational Mapping)
- **PostgreSQL**: 데이터베이스
- psycopg2: PostgreSQL의 파이썬 어댑터

### Authentication & Security
- **JWT (JSON Web Token)**: 토큰 기반 인증
- **Jose**: JWT 토큰 생성/검증
- **Passlib + bcrypt**: 비밀번호 해싱

### Data Validation
- **Pydantic**: 요청/응답 데이터 검증 및 직렬화

### Image Processing
- **Pillow (PIL)**: 이미지 처리

### Others
- **CORS Middleware**: 크로스 오리진 요청 허용
- **OAuth2PasswordBearer**: OAuth2 토큰 스키마

---

## 3. 시스템 아키텍처

### 디렉토리 구조
```
src/
├── backend/
│   ├── models.py           # DB 모델 정의
│   ├── schemas.py          # Pydantic 스키마
│   ├── process_db.py       # DB 처리 함수
│   ├── services.py         # 비즈니스 로직
│   └── task.py             # 작업 상태 관리
├── utils/
│   ├── config.py           # 환경 설정
│   ├── security.py         # 인증 및 보안
│   ├── session.py          # 세션 관리
│   └── image.py            # 이미지 처리
└── main.py                 # FastAPI 애플리케이션 엔트리포인트
```

### 레이어 구조

![시스템 아키텍처 레이어 구조](https://private-user-images.githubusercontent.com/94505794/535383841-8fefdc87-23bd-43e5-a0cf-b90237b3fe45.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjgzNTczNTEsIm5iZiI6MTc2ODM1NzA1MSwicGF0aCI6Ii85NDUwNTc5NC81MzUzODM4NDEtOGZlZmRjODctMjNiZC00M2U1LWEwY2YtYjkwMjM3YjNmZTQ1LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTE0VDAyMTczMVomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWIzZjJiZjgxZDgwNGM3OTY2MGZiOTFkYWNiYTU3OGZkYmZjYTllOGUzOGIwNTVjMDJhMzIxNDA0ZGMwZTliYjkmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.8Dpg1E5kBWr_c84jiuxXOKyC_ErqXPKM8kjJKdYhL38)

---

## 4. 데이터베이스 설계

### ERD 개요

**5개의 핵심 테이블:**

#### 1. User (사용자)
- `user_id` (PK): 사용자 고유 ID
- `login_id` (Unique): 로그인 아이디
- `login_pw`: 해시화된 비밀번호
- `name`: 사용자 이름
- `created_at`: 생성 시각

#### 2. ChatSession (채팅 세션)
- `session_id` (PK): 세션 고유 ID
- `user_id` (FK → User): 유저 ID (NULL 가능, 게스트 지원)
- `created_at`: 생성 시각

**특징:**
- 게스트 사용자 지원 (`user_id = NULL`)
- 로그인 시 게스트 세션을 유저에게 귀속 가능
- 절대 삭제하지 않음 (히스토리 보존)

#### 3. ChatHistory (채팅 메시지)
- `id` (PK): 메시지 고유 ID
- `session_id` (FK → ChatSession): 세션 ID
- `role`: "user" 또는 "assistant"
- `content`: 메시지 내용
- `image_id` (FK → ImageMatching): 첨부 이미지 (NULL 가능)
- `created_at`: 생성 시각

#### 4. GenerationHistory (생성 이력)
- `id` (PK): 생성 이력 고유 ID
- `session_id` (FK → ChatSession): 세션 ID
- `content_type`: "text" 또는 "image"
- `input_text`: 사용자 입력 텍스트
- `output_text`: 생성된 광고 문구
- `prompt`: 이미지 생성용 프롬프트
- `input_image_id` (FK → ImageMatching): 입력 이미지
- `output_image_id` (FK → ImageMatching): 출력 이미지
- `generation_method`: 생성 방법 (canny, depth, openpose 등)
- `style`: 이미지 스타일 (ultra_realistic, semi_realistic, anime)
- `industry`: 업종 분류
- `seed`: 생성 시드 값
- `aspect_ratio`: 이미지 비율 (1:1, 16:9, 9:16, 4:3)
- `created_at`: 생성 시각

#### 5. ImageMatching (이미지 파일 레지스트리)
- `id` (PK): 이미지 고유 ID
- `file_hash` (Unique): SHA-256 해시값
- `file_directory`: 디스크 경로
- `created_at`: 생성 시각

**특징:**
- 파일 해시 기반 중복 제거 (동일한 이미지는 한 번만 저장)
- 이미지 파일 캐시 테이블 역할

### ERD (Entity Relationship Diagram)

![ERD](https://private-user-images.githubusercontent.com/94505794/535384975-d331e8c0-c78e-4404-a4f8-121c5c6db131.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjgzNTc2MTYsIm5iZiI6MTc2ODM1NzMxNiwicGF0aCI6Ii85NDUwNTc5NC81MzUzODQ5NzUtZDMzMWU4YzAtYzc4ZS00NDA0LWE0ZjgtMTIxYzVjNmRiMTMxLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTE0VDAyMjE1NlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWZhNGQ1OGM0YWM4ZTBmNWNmNjc1MWMzMGYyZDM0NTM0YmUxZDg4MDMxNWRmMGYxN2VhNTU0ODBiOWUxNjA5ZjMmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.L7benlNwIrcSLQsPnaEq-aOctAOUdhVCwBsHEIk8ce8)

### 관계 설정
- User → ChatSession: 1:N (유저 삭제 시 session.user_id = NULL)
- ChatSession → ChatHistory: 1:N
- ChatSession → GenerationHistory: 1:N
- ImageMatching → ChatHistory: 1:N
- ImageMatching → GenerationHistory (input): 1:N
- ImageMatching → GenerationHistory (output): 1:N

### 인덱싱 전략
```python
# models.py:200-208
Index("idx_chat_session_user", ChatSession.user_id)
Index("idx_generation_session_created", GenerationHistory.session_id, GenerationHistory.created_at)
Index("idx_chat_history_image", ChatHistory.image_id)
Index("idx_generation_input_image", GenerationHistory.input_image_id)
Index("idx_generation_output_image", GenerationHistory.output_image_id)
```

---

## 5. API 엔드포인트

### 5.1 인증 (Authentication)

#### POST /auth/signup
회원가입

**Request:**
```json
{
  "login_id": "user123",      // 3-20자, 영문+숫자만
  "login_pw": "password1234",  // 4-30자
  "name": "홍길동"             // 1-50자
}
```

**Response:**
```json
{
  "user_id": 1,
  "login_id": "user123",
  "name": "홍길동",
  "created_at": "2026-01-14T12:00:00"
}
```

**구현 위치:** `main.py:55-60`, `services.py:50-66`

#### POST /auth/login
로그인

**Request (Form Data):**
```
username: user123
password: password1234
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer"
}
```

**구현 위치:** `main.py:63-69`, `services.py:69-78`

#### GET /auth/me
현재 로그인 사용자 정보 조회

**Headers:**
```
Authorization: Bearer <access_token>
```

**Response:**
```json
{
  "name": "홍길동"
}
```

**구현 위치:** `main.py:46-52`

#### PUT /auth/user
회원정보 수정

**Request:**
```json
{
  "name": "김철수",              // 선택
  "current_password": "password1234",  // 필수
  "new_password": "newpass5678"        // 선택
}
```

**구현 위치:** `main.py:76-84`, `services.py:81-98`

#### DELETE /auth/user
회원 탈퇴

**Request:**
```json
{
  "login_pw": "password1234"
}
```

**구현 위치:** `main.py:86-95`, `services.py:101-108`

---

### 5.2 광고 생성 (Generation)

#### POST /generate
광고 생성 요청 (비동기)

**Request (Multipart Form Data):**
```
input_text: "신제품 스마트폰 광고 만들어줘"
image: <file> (선택)
session_id: "abc123" (선택)
generation_type: "image" or "text"
style: "ultra_realistic" (선택, 기본값: ultra_realistic)
aspect_ratio: "16:9" (선택, 기본값: 1:1)
```

**Response (즉시 반환):**
```json
{
  "task_id": "uuid-1234-5678-...",
  "session_id": "abc123",
  "status": "processing"
}
```

**구현 위치:** `main.py:100-170`

**처리 흐름:**
1. 즉시 `task_id` 반환
2. 백그라운드에서 파이프라인 실행
3. `/tasks/{task_id}`로 진행 상황 조회

---

### 5.3 작업 상태 조회 (Task Monitoring)

#### GET /tasks/{task_id}
작업 진행 상황 조회

**Response:**
```json
{
  "task_id": "uuid-1234-5678-...",
  "status": "generating",  // pending, ingesting, analyzing, generating, persisting, done, failed
  "progress": 70,          // 0-100
  "result": {              // 완료 시에만
    "session_id": "abc123",
    "output": {
      "content_type": "image",
      "output_text": "혁신을 손안에",
      "image": "hash123..."
    }
  },
  "error": null,           // 실패 시 에러 메시지
  "created_at": "2026-01-14T12:00:00",
  "updated_at": "2026-01-14T12:01:30"
}
```

**구현 위치:** `main.py:212-235`

#### DELETE /tasks/{task_id}
완료된 작업 삭제

**구현 위치:** `main.py:238-248`

---

### 5.4 채팅 세션 (Chat Session)

#### POST /chat/session
세션 ID 조회/생성

**Request:**
```json
{
  "session_id": "abc123" // 선택
}
```

**Response:**
```json
{
  "session_id": "abc123"
}
```

**구현 위치:** `main.py:173-182`

#### GET /chat/history
채팅 히스토리 조회 (페이징)

**Query Parameters:**
- `limit`: 페이지 크기 (기본값: 15)
- `cursor`: 커서 ID (다음 페이지 조회용)

**Response:**
```json
{
  "items": [
    {
      "id": 1,
      "role": "user",
      "content": "스마트폰 광고 만들어줘",
      "image": {
        "image_hash": "hash123",
        "file_directory": "/images/hash123",
        "role": "input"
      },
      "created_at": "2026-01-14T12:00:00"
    },
    {
      "id": 2,
      "role": "assistant",
      "content": "혁신을 손안에",
      "image": {
        "image_hash": "hash456",
        "file_directory": "/images/hash456",
        "role": "output"
      },
      "created_at": "2026-01-14T12:01:30"
    }
  ],
  "next_cursor": 15
}
```

**구현 위치:** `main.py:185-200`, `process_db.py:380-408`

---

### 5.5 이미지 서빙 (Image Serving)

#### GET /images/{file_hash}
이미지 파일 서빙

**Example:**
```
GET /images/a1b2c3d4e5f6...
```

**Response:** 이미지 파일 (FileResponse)

**구현 위치:** `main.py:204-209`, `utils/image.py:97-109`

---

## 6. 핵심 비즈니스 로직

### 6.1 광고 생성 파이프라인 (services.py)

전체 파이프라인은 `handle_generate_pipeline` 함수에서 통합 관리됩니다.

#### 파이프라인 플로우차트

<img width="500" alt="Image" src="https://private-user-images.githubusercontent.com/94505794/535386617-a015f75b-b56e-45c5-95fd-64c875a3d9fb.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjgzNTgwNDIsIm5iZiI6MTc2ODM1Nzc0MiwicGF0aCI6Ii85NDUwNTc5NC81MzUzODY2MTctYTAxNWY3NWItYjU2ZS00NWM1LTk1ZmQtNjRjODc1YTNkOWZiLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTE0VDAyMjkwMlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTlkOWNhZTY3YzI2ZTFiYzMyZGI0ZjFkM2FmMWJiN2VmYjkzOGNiNjFkNWIxYmRhOGY2ZjU5NTNmZDc4NTlkN2MmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0._xfjyXsdwM8n2C895iBC_eBxcROVtWd_M9CN10IFIoo" />

#### 파이프라인 단계

**1단계: 입력 수집/저장 (Ingesting) - 0% → 5%**

함수: `ingest_user_message` (services.py:118-185)

```python
async def ingest_user_message(
    *, db, input_text, session_id, user_id, image=None
) -> IngestResult
```

**처리 내용:**
- 세션 ID 정규화 및 확보/생성
- 게스트 세션을 로그인 유저에게 귀속
- 업로드 이미지 디스크 저장 (SHA-256 해시 기반)
- 이미지 DB 등록 (중복 제거)
- 사용자 메시지 DB 저장

**반환값:**
```python
@dataclass
class IngestResult:
    session_id: str
    chat_history_id: int
    input_image: Optional[dict]  # {"file_hash": ..., "file_directory": ...}
```

---

**2단계: 콘텐츠 생성 (Generating) - 5% → 70%**

함수: `generate_contents` (services.py:216-319)

```python
async def generate_contents(
    *, input_text, input_image, generation_type, style, aspect_ratio
) -> GeneratedContent
```

**처리 내용:**
- AI 광고 문구 생성 (`generate_advertisement`)
- 업종 분류 추출
- 이미지 생성 타입 분기:
  - **텍스트 생성**: 광고 문구만 반환
  - **이미지 생성**:
    - 프롬프트 생성
    - 이미지 생성 (`generate_and_save_image`)
      - Text-to-Image (T2I)
      - Image-to-Image (I2I with ControlNet)
    - 생성된 이미지 파일 저장

**반환값:**
```python
@dataclass
class GeneratedContent:
    content_type: str          # "text" or "image"
    input_text: str
    input_image: Optional[dict]
    output_text: Optional[str]
    output_image: Optional[dict]
    prompt: Optional[str]
    generation_method: Optional[str]
    style: Optional[str]
    industry: Optional[str]
    seed: Optional[int]
    aspect_ratio: Optional[str]
```

---

**3단계: 결과 저장 (Persisting) - 70% → 90%**

함수: `persist_generation_result` (services.py:322-376)

```python
def persist_generation_result(*, db, session_id, gen)
```

**처리 내용:**
- 출력 이미지 DB 저장
- ChatHistory에 assistant 메시지 저장
- GenerationHistory에 생성 이력 저장

---

**4단계: 완료 (Done) - 90% → 100%**

```python
result = {
    "session_id": ingest.session_id,
    "output": gen_result.to_public_dict()
}
complete_task(task_id, result)
```

---

### 6.2 세션 관리 로직 (utils/session.py)

#### 세션 관리 플로우

![세션 관리 플로우 차트](https://private-user-images.githubusercontent.com/94505794/535386256-5f58191a-db3b-4d96-845b-85c7ad2b0988.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjgzNTc5NTQsIm5iZiI6MTc2ODM1NzY1NCwicGF0aCI6Ii85NDUwNTc5NC81MzUzODYyNTYtNWY1ODE5MWEtZGIzYi00ZDk2LTg0NWItODVjN2FkMmIwOTg4LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTE0VDAyMjczNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWI2NTg3MWQ2ZDNjYTViN2NhNjdkMGZjMTczYTgwMTU1YmM2NzM0NmI1MTM2Y2E2ZWU5N2Q5NDVjM2M5MzM3MDAmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.CiBRAL3jba5BuBpfAC3y30Vb9ZIvnNOo69ztvnDoShc)

**핵심 기능:**
- **게스트 세션**: `user_id = NULL`로 생성, 로그인 전에도 사용 가능
- **세션 귀속**: 게스트가 로그인하면 기존 세션을 유저에게 연결
- **보안**: 다른 유저의 세션 탈취 방지
- **연속성**: 로그인 전후 히스토리 보존

#### 세션 ID 정규화
```python
def normalize_session_id(session_id: Optional[str]) -> str
```

**처리 내용:**
- `undefined`, `null`, `None` 등을 새 UUID로 변환
- 유효한 세션 ID는 그대로 반환

#### 세션 확보/생성
```python
def ensure_chat_session(db, session_id, user_id) -> str
```

**처리 내용:**
1. 세션 ID로 DB 조회
2. 없으면 새 세션 생성 (user_id 포함)
3. 게스트 세션(`user_id = NULL`)이면 로그인 유저에게 귀속

**특징:**
- 게스트 → 로그인 유저 전환 시 세션 연속성 보장
- 다른 유저의 세션 탈취 방지

---

### 6.3 이미지 해시 기반 중복 제거 (utils/image.py)

#### 이미지 중복 제거 플로우

![이미지 중복 제거 플로우 차트](https://private-user-images.githubusercontent.com/94505794/535387058-9dc9e58f-bebd-46d2-9b55-3be6439d0548.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjgzNTgxNTIsIm5iZiI6MTc2ODM1Nzg1MiwicGF0aCI6Ii85NDUwNTc5NC81MzUzODcwNTgtOWRjOWU1OGYtYmViZC00NmQyLTliNTUtM2JlNjQzOWQwNTQ4LnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTE0VDAyMzA1MlomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWE3MmVhZmUxYTI0MDhhZGQ2MjMwZTgxN2M1NzE3YjYyMTVhYmExMWFlMGVlYzhhM2YyZTllZjUwMDViOWE5Y2YmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.ZdOhwTyKC_eLIBbHwv5GxxbIhJHJLEk8JD2W0gs1MCw)

**핵심 장점:**
- **스토리지 절약**: 동일 파일을 여러 사용자가 업로드해도 1번만 저장
- **성능 향상**: 중복 체크로 불필요한 I/O 방지
- **일관성**: SHA-256 해시로 파일 무결성 보장

---

## 7. 보안 및 인증

### 7.1 인증 플로우

#### 회원가입/로그인 시퀀스 다이어그램

![회원가입 로그인 시퀀스 다이어그램](https://private-user-images.githubusercontent.com/94505794/535387719-dec431bf-50df-436f-b964-0f89d79063f0.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjgzNTgzMjQsIm5iZiI6MTc2ODM1ODAyNCwicGF0aCI6Ii85NDUwNTc5NC81MzUzODc3MTktZGVjNDMxYmYtNTBkZi00MzZmLWI5NjQtMGY4OWQ3OTA2M2YwLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTE0VDAyMzM0NFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPTM0MzZmN2VhZjU1OTQxYzMyZGNhNDJmMDRiODEzMDY4Y2M2Y2I1NTcxZGM2ZDFmZjc2ZGVhYWQ5ODAyYjI4YTYmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.JLefCSuP9wzr7ODUSWvVdw3hhztAxXrt60dijwMqqO8)

---

### 7.2 비밀번호 보안 (utils/security.py)

#### 해싱 알고리즘
```python
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
```

- **bcrypt**: 솔트 자동 생성, 느린 해싱 (무차별 대입 공격 방어)

#### 회원가입 시
```python
def hash_password(password: str) -> str:
    return pwd_context.hash(password)
```

#### 로그인 시
```python
def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)
```

---

### 7.3 JWT 토큰 인증

#### 토큰 생성 (로그인 시)
```python
def create_access_token(user_id: int, extra: dict = None) -> str:
    now = datetime.utcnow()
    payload = {
        "sub": str(user_id),
        "iat": now,
        "exp": now + timedelta(minutes=settings.JWT_EXPIRE_MINUTES)
    }
    return jwt.encode(payload, settings.JWT_SECRET_KEY, algorithm=settings.JWT_ALGO)
```

**토큰 페이로드:**
- `sub`: 사용자 ID
- `iat`: 발급 시각
- `exp`: 만료 시각 (기본 60분)

#### 토큰 검증 (요청 시)
```python
def get_current_user(token: str, db: Session):
    if not token:
        return None  # 게스트 허용

    try:
        payload = decode_token(token)
        user_id = int(payload.get("sub"))
    except (JWTError, TypeError, ValueError):
        raise HTTPException(status_code=401, detail="토큰 오류")

    user = process_db.get_user_by_id(db, user_id)
    if not user:
        raise HTTPException(status_code=401, detail="유효하지 않은 사용자")

    return user
```

**특징:**
- `auto_error=False`: 토큰이 없어도 게스트로 접근 가능
- 토큰 만료/변조 시 401 에러

---

### 7.4 입력 검증 (schemas.py)

Pydantic 모델로 요청 데이터 검증

**회원가입 검증 예시:**
```python
class SignupRequest(BaseModel):
    login_id: str = Field(min_length=3, max_length=20, pattern=r"^[a-zA-Z0-9]+$")
    login_pw: str = Field(min_length=4, max_length=30)
    name: str = Field(min_length=1, max_length=50)
```

**검증 항목:**
- 길이 제한
- 정규표현식 (login_id는 영문+숫자만)
- 필수/선택 필드

---

## 8. 작업 상태 관리 (task.py)

### 8.1 작업 상태 전이 다이어그램

![작업 상태 전이 다이어그램](https://private-user-images.githubusercontent.com/94505794/535388145-8473534e-2298-4a69-ace2-2f7bc25b59a2.png?jwt=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3NjgzNTg0MzQsIm5iZiI6MTc2ODM1ODEzNCwicGF0aCI6Ii85NDUwNTc5NC81MzUzODgxNDUtODQ3MzUzNGUtMjI5OC00YTY5LWFjZTItMmY3YmMyNWI1OWEyLnBuZz9YLUFtei1BbGdvcml0aG09QVdTNC1ITUFDLVNIQTI1NiZYLUFtei1DcmVkZW50aWFsPUFLSUFWQ09EWUxTQTUzUFFLNFpBJTJGMjAyNjAxMTQlMkZ1cy1lYXN0LTElMkZzMyUyRmF3czRfcmVxdWVzdCZYLUFtei1EYXRlPTIwMjYwMTE0VDAyMzUzNFomWC1BbXotRXhwaXJlcz0zMDAmWC1BbXotU2lnbmF0dXJlPWM0Njg2NTU1ODNhMmE1YTFkMWIzNzM0ZWY2Y2E3MmYwNjIxZDQyYzU1Y2Y1YmUyNWNlZmUwMTk0ZDNiOGI3YzQmWC1BbXotU2lnbmVkSGVhZGVycz1ob3N0In0.gaFz9YHVWhJl4ofP45K9l5sdLxKzalPeGhAWqmh4sO4)

### 8.2 TaskStatus Enum
```python
class TaskStatus(str, Enum):
    PENDING = "pending"          # 대기 중
    INGESTING = "ingesting"      # 입력 수집/저장
    ANALYZING = "analyzing"      # 분석 (미사용)
    GENERATING = "generating"    # 콘텐츠 생성
    PERSISTING = "persisting"    # DB 저장
    DONE = "done"                # 완료
    FAILED = "failed"            # 실패
```

### 8.3 TaskState 구조
```python
@dataclass
class TaskState:
    task_id: str
    status: TaskStatus
    progress: int  # 0-100
    result: Optional[Dict[Any, Any]] = None
    error: Optional[str] = None
    created_at: datetime = None
    updated_at: datetime = None
```

### 8.4 작업 생성 및 업데이트

```python
# 1. 작업 생성 (0%)
create_task(task_id)

# 2. 진행률 업데이트
update_task_progress(task_id, 5, TaskStatus.INGESTING)
update_task_progress(task_id, 30, TaskStatus.GENERATING)
update_task_progress(task_id, 70, TaskStatus.GENERATING)
update_task_progress(task_id, 80, TaskStatus.PERSISTING)
update_task_progress(task_id, 90, TaskStatus.PERSISTING)

# 3. 완료
complete_task(task_id, result)

# 또는 실패
fail_task(task_id, error_message)
```

### 8.5 인메모리 스토리지

```python
_task_storage: Dict[str, TaskState] = {}
```

**특징:**
- 현재는 메모리에 저장 (서버 재시작 시 소멸)
- 향후 Redis/DB로 교체 가능
- 프로토타입 단계에서는 충분

---

## 9. 향후 개선 사항

- 현재 ui만 챗봇 형식이지 생성 요청과 저장 로직이 단발성에 그치고 있다. 정말 챗봇과 같이 memory, state 등을 통해 구현 필요
- 상담 , 생성, 편집 등 intent 등과 같은 분석도 필요
- 앤드포인트는 테스트할려고 대충 만든거라 httpsonly와 쿠키로 jwt 토큰 보안 강화 필요(앤드포인트에서 유노님이)
- task로 메모리 관리 < 못하고 있음
- 광고 이미지 형식 6개 템플릿 뽑기
- 브랜드 별 폰트 정하기 
- 현재 런타임(fastAPI 실행 /home )유저의 폴더에 이미지들이 쌓이는 구조여서 그거를 root 폴더로 옮기고, 폰트와 같은 공용 파일들도 옮겨야함
- 현재 hugging face 모델로만 이미지를 생성중 -> 나노바나나로도 해보기



## 주요 파일별 역할

| 파일 | 역할 |
|------|------|
| `main.py` | FastAPI 엔트리포인트, 엔드포인트 정의(유노님 파트) |
| `backend/models.py` |  SQLAlchemy DB 모델 정의 |
| `backend/schemas.py` |  Pydantic 스키마 (요청/응답) |
| `backend/process_db.py` |  DB CRUD 함수 |
| `backend/services.py` |  비즈니스 로직 (인증, 생성 파이프라인) |
| `backend/task.py` |  작업 상태 관리 |
| `utils/session.py` |  세션 관리 유틸리티 |
| `utils/security.py` |  보안 유틸리티 (해싱, JWT) |
| `utils/config.py` |  환경 설정 |
| `utils/image.py` |  이미지 처리 유틸리티 |

---

## PPT 슬라이드 구성안

### 프로젝트 개요
- 주요 기능 7가지 나열
- 기술 스택 아이콘 배치

###  시스템 아키텍처
- **[다이어그램]** 레이어 구조 (Mermaid 플로우차트)
- 4계층 구조: Client → API → Business Logic → Database

###  데이터베이스 설계
- **[다이어그램]** ERD (Mermaid)
- 5개 테이블 관계 시각화
- 특징: 게스트 지원, 해시 기반 중복 제거

### 광고 생성 파이프라인
- **[다이어그램]** 4단계 플로우차트 (Mermaid)
- 각 단계별 진행률 표시
- 비동기 처리 강조

###  세션 관리 로직
- **[다이어그램]** 세션 관리 플로우 (Mermaid)
- 게스트 → 로그인 전환 시나리오
- 보안 및 연속성 보장

###  이미지 중복 제거
- **[다이어그램]** 이미지 해시 플로우 (Mermaid)
- SHA-256 해시 기반
- 스토리지 절약 효과

###  보안 및 인증
- **[다이어그램]** 인증 시퀀스 다이어그램 (Mermaid)
- bcrypt 비밀번호 해싱
- JWT 토큰 인증 (30분 만료)

### 작업 상태 관리
- **[다이어그램]** 작업 상태 전이 다이어그램 (Mermaid)
- 7가지 상태 (PENDING → DONE/FAILED)
- 실시간 진행률 추적



---

## 발표 팁

### 기술적 내용 설명 시
1. **레이어 구조**: "클라이언트 요청이 4개의 레이어를 거쳐 처리됩니다"
2. **ERD**: "5개 테이블로 사용자, 세션, 채팅, 생성 이력, 이미지를 관리합니다"
3. **파이프라인**: "비동기로 4단계를 거쳐 0%에서 100%까지 진행됩니다"
4. **세션 관리**: "게스트가 로그인하면 기존 세션이 유저에게 자동 귀속됩니다"
5. **이미지 중복 제거**: "SHA-256 해시로 동일 이미지를 한 번만 저장합니다"


