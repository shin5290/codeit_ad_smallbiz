---
name: 백엔드 4가지 문제 해결
overview: 의도분석기에 need_rmbg 파라미터 추가, modification intent에서 original 폴더 원본 이미지 참조 로직 추가, 텍스트 생성의 max_length 및 이전 생성 내용 연계 문제 해결, industry 불일치 및 aspect_ratio 저장 문제 해결
todos:
  - id: "1"
    content: 의도분석기 프롬프트에 need_rmbg 설명 추가 및 반환값에 need_rmbg 필드 추가
    status: pending
  - id: "2"
    content: 서비스단에서 need_rmbg 파라미터를 이미지 생성 함수에 전달하도록 수정
    status: pending
  - id: "3"
    content: 맥락분석기에서 텍스트 수정 여부 감지 로직 추가
    status: pending
  - id: "4"
    content: original 폴더 경로 조회 함수 추가 및 수정 처리에서 원본 이미지 사용
    status: pending
  - id: "5"
    content: 텍스트 생성에 chat_history와 generation_history 전달 로직 추가
    status: pending
  - id: "6"
    content: 텍스트 생성의 max_length 프롬프트 강화 및 후처리 개선
    status: pending
  - id: "7"
    content: industry 불일치 문제 해결 - 의도분석기 결과를 기준으로 통일
    status: pending
  - id: "8"
    content: 텍스트 생성 시 aspect_ratio가 DB에 저장되지 않도록 수정
    status: pending
isProject: false
---

# 백엔드 4가지 문제 해결 계획

## 문제 분석

### 1. need_rmbg 파라미터 추가

- 현재 상태: `generate_and_save_image`에는 `need_rmbg` 파라미터가 이미 존재하지만, 의도분석기에서 반환하지 않음
- 수정 필요: 의도분석기 프롬프트와 반환값에 `need_rmbg` 추가, 서비스단에서 이미지 생성 시 전달

### 2. original 폴더 원본 이미지 참조

- 현재 상태: 텍스트 오버레이 완성본만 DB에 저장, modification intent에서 참조 이미지 찾을 때 완성본 사용
- 수정 필요: modification intent + 텍스트 수정인 경우, original 폴더의 원본 이미지를 참조사진으로 사용

### 3. 텍스트 생성 max_length 문제

- 현재 상태: 텍스트 생성 시 이전 생성 내용을 끌고가는 로직 없음, max_length가 제대로 작동하지 않음
- 수정 필요: chat_history를 텍스트 생성에 전달, max_length 프롬프트 강화 및 후처리 개선

### 4. 의도분석기와 생성 industry 불일치 문제
- 현재 상태: 의도분석기는 단순하게 사용자가 입력한 업종을 영어로 키워드화 하고있고, 생성쪽은 텍스트의 경우 30개 업종 세분화, 이미지의 경우 이미지 생성 모델에 맞는 로직으로 되어있음
- 수정 필요: 생성 프롬프트에서 뽑은  industry를 DB에 넣어야됨

## 구현 계획

### Task 1: need_rmbg 파라미터 추가

**1.1 의도분석기 프롬프트 수정** (`src/backend/chatbot.py`)

- `analyze_intent` 함수의 system_prompt에 need_rmbg 설명 추가
- "배경 제거가 필요한 경우 need_rmbg: true" 가이드라인 추가
- JSON 응답 형식에 `need_rmbg` 필드 추가

**1.2 의도분석기 반환값 수정** (`src/backend/chatbot.py`)

- `analyze_intent` 함수의 반환값에 `need_rmbg` 필드 추가
- 기본값은 `False`, 사용자가 배경 제거를 요청하면 `True`

**1.3 서비스단 수정** (`src/backend/services.py`)

- `handle_chat_message_stream`에서 `intent_result`에서 `need_rmbg` 추출
- `_execute_generation_pipeline`에 `need_rmbg` 파라미터 추가
- `generate_contents` 호출 시 `need_rmbg` 전달 (이미지 생성일 때만)
- `generate_and_save_image` 호출 시 `need_rmbg` 전달

**1.4 이미지 생성 함수 수정** (`src/generation/image_generation/generator.py`)

- `generate_and_save_image`는 이미 `need_rmbg` 파라미터가 있으므로 확인만

### Task 2: original 폴더 원본 이미지 참조

**2.1 맥락분석기 수정** (`src/backend/chatbot.py`)

- `refine_generation_input` 함수에서 텍스트 수정 여부 감지
- 반환값에 `is_text_modification` 플래그 추가 (텍스트 수정인 경우 True)

**2.2 이미지 경로 조회 함수 추가** (`src/backend/services.py`)

- `_get_original_image_path` 함수 추가
- `output_image_id`로 `ImageMatching` 테이블에서 `file_directory` 조회
- `file_directory`에서 완성본 경로를 original 폴더 경로로 변환
- 예: `/mnt/data/generated/ab/abc123.jpg` → `/mnt/data/generated/ab/origin/abc123.jpg`

**2.3 수정 처리 로직 수정** (`src/backend/services.py`)

- `handle_chat_revise` 함수에서:
- `refinement_result`에서 `is_text_modification` 확인
- 텍스트 수정이고 이미지 생성인 경우:
- `target_generation`의 `output_image_id`로 original 이미지 경로 조회
- original 이미지가 존재하면 `load_image_from_payload`로 로드
- `reference_image`로 사용

**2.4 이미지 로드 유틸리티 확인** (`src/utils/image.py`)

- `load_image_from_payload`가 파일 경로도 처리할 수 있는지 확인
- 필요시 경로 기반 로드 함수 추가

### Task 3: 텍스트 생성 max_length 및 이전 생성 내용 연계

**아키텍처 결정**:

- 맥락분석기는 유지 (참조 이미지 찾기, 대명사/숫자 해석)
- 텍스트 생성: refined_input + chat_history + generation_history 모두 전달
- 이미지 생성: refined_input + 참조 이미지 (맥락분석기에서 찾은 것)

**3.1 텍스트 생성 함수 수정** (`src/generation/text_generation/text_generator.py`)

- `generate_ad_copy` 함수는 이미 `chat_history` 파라미터를 받지만 실제로 전달되지 않음
- `generate_ad_copy`에 `generation_history` 파라미터 추가
- `_get_system_prompt`에서 이전 생성 내용을 더 명확하게 반영하도록 수정
- `_build_user_prompt`에서:
- 정제된 입력(refined_input) 사용
- 이전 대화 내용 포함
- 이전 생성된 텍스트도 포함하여 맥락 보완

**3.2 서비스단 수정** (`src/backend/services.py`)

- `generate_contents` 함수에 `session_id` 파라미터 추가 (히스토리 조회용)
- `_execute_generation_pipeline`에서:
- `chat_history` 조회 (ConversationManager 사용)
- `generation_history` 조회 (이전 생성된 텍스트 참조용)
- 텍스트 생성 시:
- `refined_input` (맥락분석기에서 정제된 입력) 사용
- `chat_history` 전달
- `generation_history` 전달 (이전 생성된 텍스트 포함)
- 이미지 생성 시:
- `refined_input` 사용 (맥락분석기에서 정제된 입력)
- 참조 이미지는 맥락분석기에서 찾은 것 사용

**3.3 max_length 강화** (`src/generation/text_generation/text_generator.py`)

- `_get_system_prompt`에서 max_length를 더 강조
- `_postprocess`에서 max_length 체크 강화
- 생성 중 로그와 완료 로그의 결과가 다른 문제 해결 (후처리에서 길이 체크)
- 프롬프트에서 "반드시 {max_length}자 이내로 작성" 명시

**3.4 프롬프트 개선** (`src/generation/text_generation/text_generator.py`)

- 정제된 입력(refined_input)을 메인 입력으로 사용
- 이전 대화 내용을 컨텍스트로 포함
- 이전 생성된 텍스트를 "이전에 생성한 내용: [이전 텍스트]" 형식으로 추가
- max_length를 초과하지 않도록 명확히 지시

## 파일 수정 목록

1. `src/backend/chatbot.py` - 의도분석기, 맥락분석기 수정
2. `src/backend/services.py` - 서비스 로직 수정
3. `src/generation/text_generation/text_generator.py` - 텍스트 생성 로직 개선
4. `src/utils/image.py` - 이미지 로드 유틸리티 확인/수정 (필요시)

### Task 4: industry 불일치 문제 해결

**문제 분석**:

- 의도분석기: "cafe", "restaurant" 같은 간단한 값 반환
- 텍스트 생성: `detect_industry`로 자체 감지 (s1_hot_cooking, s3_emotional 같은 코드)
- 이미지 생성: PromptProcessorNode에서 자체 감지
- 서로 다른 형식으로 불일치 발생

**해결 전략**: 의도분석기에서 industry 추출 로직 제거, 생성 쪽에서만 감지

**4.1 의도분석기 수정** (`src/backend/chatbot.py`)

- `analyze_intent` 함수에서 industry 관련 프롬프트 제거
- JSON 응답 형식에서 `industry` 필드 제거
- 반환값에서 `industry` 필드 제거

**4.2 텍스트 생성에서 industry 감지** (`src/generation/text_generation/text_generator.py`)

- `generate_ad_copy`에서 `PromptTemplateManager.detect_industry`로 자체 감지
- 감지된 industry를 반환값에 포함 (튜플 또는 딕셔너리로 반환)

**4.3 이미지 생성에서 industry 감지** (`src/generation/image_generation/generator.py`)

- `PromptProcessorNode`가 `PromptTemplateManager._detect_industry`로 자체 감지함 (확인됨)
- `generate_and_save_image`의 반환값에 `industry` 필드가 있음
- 워크플로우 실행 후 `result`에서 `industry` 추출하여 반환

**4.4 서비스단 수정** (`src/backend/services.py`)

- `handle_chat_message_stream`에서:
- `intent_result`에서 `industry` 추출하는 부분 제거
- `_execute_generation_pipeline`에 `industry` 파라미터 전달하지 않음
- 텍스트 생성 시:
- `text_gen.generate_ad_copy`에서 자체 감지한 industry를 반환하도록 수정
- `generate_contents`에서 텍스트 생성 결과의 industry를 `GeneratedContent.industry`에 저장
- 이미지 생성 시:
- `generate_and_save_image`의 반환값에서 `industry` 추출
- `generate_contents`에서 이미지 생성 결과의 industry를 `GeneratedContent.industry`에 저장
- DB 저장 시: 생성 쪽에서 감지한 industry를 저장
- `persist_generation_result`에서 `gen.industry`를 그대로 저장 (생성 쪽에서 감지한 값)

### Task 5: 텍스트 생성 시 aspect_ratio 저장 문제 해결

**문제 분석**:

- 텍스트 생성인데 `aspect_ratio`가 DB에 "1:1"로 고정 저장됨
- `generate_contents`에서 텍스트 생성일 때도 `aspect_ratio`가 전달되고 있음
- `persist_generation_result`에서 `gen.aspect_ratio`를 그대로 저장

**5.1 서비스단 수정** (`src/backend/services.py`)

- `generate_contents` 함수에서:
- 텍스트 생성일 때 `aspect_ratio=None`으로 설정
- `GeneratedContent` 생성 시 `aspect_ratio`는 이미지 생성일 때만 설정
- `_execute_generation_pipeline`에서:
- 텍스트 생성일 때 `aspect_ratio`를 전달하지 않음
- `persist_generation_result`에서:
- 텍스트 생성(`content_type == "text"`)일 때 `aspect_ratio=None`으로 저장

## 주의사항

1. **need_rmbg**: 이미지 생성에만 적용되므로 `generation_type == "image"`일 때만 처리
2. **original 폴더**: 파일 시스템 경로 기반이므로 경로 변환 로직 정확성 중요
3. **텍스트 생성**: chat_history와 generation_history를 모두 활용하여 맥락 반영
4. **max_length**: 프롬프트와 후처리 모두에서 체크하여 일관성 유지
5. **industry 통일**: 의도분석기 결과를 기준으로 텍스트/이미지 생성 모두에 동일하게 전달
6. **aspect_ratio**: 텍스트 생성일 때는 None으로 설정하여 DB에 저장되지 않도록 함