# ì§„ìˆ˜ê²½ë‹˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
## ë°±ì—”ë“œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (services.py, db_processor.py, schemas.py)

**ë‹´ë‹¹ ë²”ìœ„**: 
- DB ì„¤ê³„ ë° ORM ëª¨ë¸ (SQLAlchemy)
- DB ì ‘ê·¼ ë ˆì´ì–´ (process_db.py)
- ë°ì´í„° ìŠ¤í‚¤ë§ˆ (schemas.py)
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—°ê²° (services.py)

**í”„ë¡œì íŠ¸ ê¸°ê°„**: 2025-12-29 ~ 2026-01-27

---

## ğŸ“‹ ì „ì²´ êµ¬ì¡°

```
src/backend/
â”œâ”€â”€ models.py           # SQLAlchemy ORM ëª¨ë¸ (6ê°œ í…Œì´ë¸”)
â”œâ”€â”€ process_db.py       # DB CRUD í•¨ìˆ˜
â”œâ”€â”€ schemas.py          # Pydantic ìŠ¤í‚¤ë§ˆ
â”œâ”€â”€ services.py         # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (AI í˜¸ì¶œ)
â””â”€â”€ routes.py          # FastAPI ì—”ë“œí¬ì¸íŠ¸ (ì´ìœ ë…¸ë‹˜)

src/generation/
â”œâ”€â”€ image_generation/
â”‚   â”œâ”€â”€ generator.py    # SDXL ì´ë¯¸ì§€ ìƒì„± (ì´í˜„ì„ë‹˜), ì¶”í›„ ì‘ì„±ëœ ë‚´ìš© í™•ì¸ í•„ìš”
â”‚   â””â”€â”€ controlnet.py   # ControlNet (ì´í˜„ì„ë‹˜), ì¶”í›„ ì‘ì„±ëœ ë‚´ìš© í™•ì¸ í•„ìš”
â””â”€â”€ text_generation/
    â””â”€â”€ prompt_manager.py  # GPT í”„ë¡¬í”„íŠ¸ ìƒì„± (ë°°í˜„ì„ë‹˜), ì¶”í›„ ì‘ì„±ëœ ë‚´ìš© í™•ì¸ í•„ìš”
```

---

## ğŸ“… 1ë‹¨ê³„ (MVP): ~ 2026-01-15

### ğŸ—“ 1ì£¼ì°¨ (12/29 ~ 1/4): DB ì„¤ê³„ ë° ëª¨ë¸ ì‘ì„±

#### Day 1-2 (12/29-12/30): PostgreSQL ì„¤ì •

**PostgreSQL ì„¤ì¹˜ (GCP VM)**
```bash
# SSH ì ‘ì†
gcloud compute ssh ad-generator-vm

# PostgreSQL ì„¤ì¹˜
sudo apt-get update
sudo apt-get install -y postgresql postgresql-contrib

# ì„œë¹„ìŠ¤ ì‹œì‘
sudo systemctl start postgresql
sudo systemctl enable postgresql

# ìƒíƒœ í™•ì¸
sudo systemctl status postgresql
```

**ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±**
```bash
# PostgreSQL ì ‘ì†
sudo -u postgres psql

# DB ë° ì‚¬ìš©ì ìƒì„±
CREATE DATABASE adbizdb;
CREATE USER ad_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE adbizdb TO ad_user;

# ì¢…ë£Œ
\q

# ì—°ê²° í…ŒìŠ¤íŠ¸
psql -U ad_user -d adbizdb -h localhost
```

- [ ] PostgreSQL 15 ì„¤ì¹˜
- [ ] adbizdb ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
- [ ] ad_user ì‚¬ìš©ì ìƒì„± ë° ê¶Œí•œ ë¶€ì—¬
- [ ] ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ

**SQLAlchemy ì„¤ì¹˜**
```bash
cd ~/codeit_ad_smallbiz
source venv/bin/activate

pip install sqlalchemy psycopg2-binary bcrypt python-dotenv
```

- [ ] ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ

---

#### Day 3-5 (12/31-1/2): models.py ì‘ì„±

**íŒŒì¼ ìƒì„±**: `src/backend/models.py`

**ê¸°ë³¸ êµ¬ì¡°**
```python
"""
SQLAlchemy ORM ëª¨ë¸ ì •ì˜
DB êµ¬ì¡° v5.0 (2025-01-05)
"""

from sqlalchemy import (
    Column, Integer, String, Text, ForeignKey,
    DateTime, Boolean, func
)
from sqlalchemy.orm import relationship, declarative_base

Base = declarative_base()
```

- [ ] íŒŒì¼ ìƒì„± ë° ê¸°ë³¸ import

**User ëª¨ë¸**
```python
class User(Base):
    """ì‚¬ìš©ì ì •ë³´"""
    __tablename__ = "user"

    user_id = Column(Integer, primary_key=True, index=True)
    login_id = Column(String(50), unique=True, nullable=False, index=True)
    login_pw = Column(String(255), nullable=False)
    name = Column(String(50), nullable=False)
    created_at = Column(DateTime, server_default=func.now())

    # Relationships
    sessions = relationship("ChatSession", back_populates="user", 
                          cascade="all, delete-orphan")
```

- [ ] User í´ë˜ìŠ¤ ì‘ì„±
- [ ] í•„ë“œ ì •ì˜ (user_id, login_id, login_pw, name, created_at)
- [ ] sessions relationship ì •ì˜

**ChatSession ëª¨ë¸**
```python
class ChatSession(Base):
    """ì±„íŒ… ì„¸ì…˜"""
    __tablename__ = "chat_session"

    session_id = Column(String(100), primary_key=True, index=True)
    user_id = Column(Integer, ForeignKey("user.user_id"), nullable=True)
    created_at = Column(DateTime, server_default=func.now())
    is_active = Column(Boolean, default=True, nullable=False)
    closed_at = Column(DateTime, nullable=True)

    # Relationships
    user = relationship("User", back_populates="sessions")
    chat_histories = relationship("ChatHistory", back_populates="session",
                                 cascade="all, delete-orphan")
    generation_histories = relationship("GenerationHistory", 
                                       back_populates="session")
```

- [ ] ChatSession í´ë˜ìŠ¤ ì‘ì„±
- [ ] is_active, closed_at í•„ë“œ ì¶”ê°€
- [ ] Relationships ì •ì˜

**ChatHistory ëª¨ë¸**
```python
class ChatHistory(Base):
    """ì±„íŒ… ë©”ì‹œì§€"""
    __tablename__ = "chat_history"

    id = Column(Integer, primary_key=True, index=True)
    # user_id ì„¤ì • í•„ìš”
    session_id = Column(String(100), 
                       ForeignKey("chat_session.session_id"), 
                       nullable=False)
    role = Column(String(20), nullable=False)
    content = Column(Text, nullable=False)
    created_at = Column(DateTime, server_default=func.now())

    # Relationships
    session = relationship("ChatSession", back_populates="chat_histories")
    images = relationship("HistoryImage", back_populates="chat_history",
                         cascade="all, delete-orphan")
```

- [ ] ChatHistory í´ë˜ìŠ¤ ì‘ì„±
- [ ] ì´ë¯¸ì§€ ê´€ë ¨ í•„ë“œ ì œê±° (v5.0 ë³€ê²½)
- [ ] images relationship ì¶”ê°€

**GenerationHistory ëª¨ë¸**
```python
class GenerationHistory(Base):
    """ê´‘ê³  ìƒì„± ì´ë ¥"""
    __tablename__ = "generation_history"

    id = Column(Integer, primary_key=True, index=True)
    # user_id ì„¤ì • í•„ìš”
    session_id = Column(String(100), 
                       ForeignKey("chat_session.session_id"), 
                       nullable=False)
    content_type = Column(String(20), nullable=False)
    input_text = Column(Text)
    output_text = Column(Text)
    generation_method = Column(String(50))
    style = Column(String(50))
    industry = Column(String(50))
    seed = Column(Integer)
    aspect_ratio = Column(String(10))
    created_at = Column(DateTime, server_default=func.now())

    # Relationships
    session = relationship("ChatSession", back_populates="generation_histories")
    images = relationship("HistoryImage", back_populates="generation_history",
                         cascade="all, delete-orphan")
```

- [ ] GenerationHistory í´ë˜ìŠ¤ ì‘ì„±
- [ ] output_text, aspect_ratio í•„ë“œ ì¶”ê°€
- [ ] user_id ì œê±° (session í†µí•´ ê°„ì ‘ ì°¸ì¡°)

**HistoryImage ëª¨ë¸** (ì‹ ê·œ)
```python
class HistoryImage(Base):
    """ì´ë¯¸ì§€-íˆìŠ¤í† ë¦¬ ì—°ê²°"""
    __tablename__ = "history_image"

    id = Column(Integer, primary_key=True, index=True)
    chat_history_id = Column(Integer, ForeignKey("chat_history.id"), 
                            nullable=True)
    generation_history_id = Column(Integer, 
                                  ForeignKey("generation_history.id"), 
                                  nullable=True)
    image_id = Column(Integer, ForeignKey("image_matching.id"), 
                     nullable=False)
    role = Column(String(20), nullable=False)  # "input" / "output"
    position = Column(Integer, nullable=False)
    created_at = Column(DateTime, server_default=func.now())

    # Relationships
    chat_history = relationship("ChatHistory", back_populates="images")
    generation_history = relationship("GenerationHistory", 
                                     back_populates="images")
    image = relationship("ImageMatching", back_populates="history_images")
```

- [ ] HistoryImage í´ë˜ìŠ¤ ì‘ì„± (ì‹ ê·œ)
- [ ] role, position í•„ë“œ ì •ì˜
- [ ] 3-way relationship ì •ì˜

**ImageMatching ëª¨ë¸**
```python
class ImageMatching(Base):
    """ì´ë¯¸ì§€ íŒŒì¼ ë§¤ì¹­"""
    __tablename__ = "image_matching"

    id = Column(Integer, primary_key=True, index=True)
    file_hash = Column(String(128), unique=True, nullable=False, index=True)
    file_directory = Column(Text, nullable=False)
    created_at = Column(DateTime, server_default=func.now())

    # Relationships
    history_images = relationship("HistoryImage", back_populates="image")
```

- [ ] ImageMatching í´ë˜ìŠ¤ ì‘ì„±
- [ ] file_type ì œê±° (í†µí•©)
- [ ] history_images relationship ì¶”ê°€

**ëª¨ë¸ ê²€ì¦**
```bash
python -c "from src.backend.models import Base; print('âœ… ëª¨ë¸ ë¡œë“œ ì„±ê³µ')"
```

- [ ] íŒŒì¼ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
- [ ] Import ì˜¤ë¥˜ ì—†ìŒ í™•ì¸

---

#### Day 6-7 (1/3-1/4): process_db.py ë° schemas.py

**process_db.py ê¸°ë³¸ êµ¬ì¡°**

íŒŒì¼: `src/backend/process_db.py`

```python
"""
DB ì ‘ê·¼ ë ˆì´ì–´
SQLAlchemy CRUD í•¨ìˆ˜
"""

from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, Session
from typing import Optional, List
from datetime import datetime
import uuid

from . import models, schemas
from utils.config import settings
from utils.auth_utils import hash_password, verify_password

# ì—”ì§„ ìƒì„±
engine = create_engine(
    settings.DATABASE_URL,
    pool_pre_ping=True,
    pool_size=10,
    max_overflow=20
)

# ì„¸ì…˜ íŒ©í† ë¦¬
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

def init_db():
    """í…Œì´ë¸” ìƒì„±"""
    models.Base.metadata.create_all(bind=engine)
    print("âœ… í…Œì´ë¸” ìƒì„± ì™„ë£Œ")

def get_db():
    """FastAPI ì˜ì¡´ì„± ì£¼ì…"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

- [ ] ê¸°ë³¸ êµ¬ì¡° ì‘ì„±
- [ ] ì—”ì§„ ë° ì„¸ì…˜ ì„¤ì •
- [ ] init_db(), get_db() í•¨ìˆ˜

**User CRUD í•¨ìˆ˜**
```python
def get_user_by_login_id(db: Session, login_id: str) -> Optional[models.User]:
    return db.query(models.User).filter(
        models.User.login_id == login_id
    ).first()

def create_user(db: Session, user_data: schemas.UserCreate) -> models.User:
    hashed_pw = hash_password(user_data.login_pw)
    db_user = models.User(
        login_id=user_data.login_id,
        login_pw=hashed_pw,
        name=user_data.name
    )
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user

def authenticate_user(db: Session, login_data: schemas.UserLogin):
    user = get_user_by_login_id(db, login_data.login_id)
    if not user:
        return None
    if not verify_password(login_data.login_pw, user.login_pw):
        return None
    return user
```

- [ ] get_user_by_login_id() ì‘ì„±
- [ ] create_user() ì‘ì„± (ë¹„ë°€ë²ˆí˜¸ í•´ì‹± í¬í•¨)
- [ ] authenticate_user() ì‘ì„±

**ChatSession CRUD í•¨ìˆ˜**
```python
def create_session(db: Session, user_id: Optional[int] = None):
    session_id = str(uuid.uuid4())
    db_session = models.ChatSession(
        session_id=session_id,
        user_id=user_id,
        is_active=True
    )
    db.add(db_session)
    db.commit()
    db.refresh(db_session)
    return db_session

def close_session(db: Session, session_id: str):
    session = db.query(models.ChatSession).filter(
        models.ChatSession.session_id == session_id
    ).first()
    if session:
        session.is_active = False
        session.closed_at = datetime.utcnow()
        db.commit()
    return session

def get_active_sessions(db: Session, user_id: int, limit: int = 20):
    return db.query(models.ChatSession).filter(
        models.ChatSession.user_id == user_id,
        models.ChatSession.is_active == True
    ).order_by(
        models.ChatSession.created_at.desc()
    ).limit(limit).all()
```

- [ ] create_session() ì‘ì„±
- [ ] close_session() ì‘ì„± (ì‹ ê·œ)
- [ ] get_active_sessions() ì‘ì„± (ì‹ ê·œ)

**í…Œì´ë¸” ìƒì„±**
```bash
cd ~/codeit_ad_smallbiz
python -c "from src.backend.process_db import init_db; init_db()"

# í™•ì¸
psql -U ad_user -d adbizdb -c "\dt"
```

- [ ] í…Œì´ë¸” ìƒì„± ì‹¤í–‰
- [ ] 6ê°œ í…Œì´ë¸” í™•ì¸

**schemas.py ì‘ì„±**

íŒŒì¼: `src/backend/schemas.py`

```python
"""
Pydantic ìŠ¤í‚¤ë§ˆ
"""

from pydantic import BaseModel, ConfigDict
from datetime import datetime
from typing import Optional, Literal

# User ìŠ¤í‚¤ë§ˆ
class UserCreate(BaseModel):
    login_id: str
    login_pw: str
    name: str

class UserResponse(BaseModel):
    user_id: int
    login_id: str
    name: str
    created_at: datetime
    
    model_config = ConfigDict(from_attributes=True)

class UserLogin(BaseModel):
    login_id: str
    login_pw: str

# Generation ìŠ¤í‚¤ë§ˆ
class GenerationRequest(BaseModel):
    session_id: str
    input_text: str
    aspect_ratio: Literal["1:1", "4:3", "3:4"]

class GenerationResponse(BaseModel):
    id: int
    session_id: str
    content_type: str
    input_text: Optional[str]
    output_text: Optional[str]
    aspect_ratio: Optional[str]
    created_at: datetime
    
    model_config = ConfigDict(from_attributes=True)
```

- [ ] UserCreate, UserResponse, UserLogin ì‘ì„±
- [ ] GenerationRequest, GenerationResponse ì‘ì„±
- [ ] aspect_ratio, output_text í•„ë“œ í¬í•¨

---

### ğŸ—“ 2ì£¼ì°¨ (1/5 ~ 1/11): CRUD í•¨ìˆ˜ ì™„ì„± ë° services.py ì‹œì‘

#### Day 8-9 (1/5-1/6): ë‚˜ë¨¸ì§€ CRUD í•¨ìˆ˜

**ChatHistory CRUD**
```python
def save_chat_message(db: Session, session_id: str, role: str, content: str):
    db_message = models.ChatHistory(
        session_id=session_id,
        role=role,
        content=content
    )
    db.add(db_message)
    db.commit()
    db.refresh(db_message)
    return db_message

def get_chat_history(db: Session, session_id: str, limit: Optional[int] = None):
    query = db.query(models.ChatHistory).filter(
        models.ChatHistory.session_id == session_id
    ).order_by(models.ChatHistory.created_at)
    
    if limit:
        query = query.limit(limit)
    
    return query.all()
```

- [ ] save_chat_message() ì‘ì„±
- [ ] get_chat_history() ì‘ì„±

**GenerationHistory CRUD**
```python
def save_generation(db: Session, generation_data: dict):
    db_gen = models.GenerationHistory(
        session_id=generation_data["session_id"],
        content_type=generation_data["content_type"],
        input_text=generation_data.get("input_text"),
        output_text=generation_data.get("output_text"),
        generation_method=generation_data.get("generation_method"),
        style=generation_data.get("style"),
        industry=generation_data.get("industry"),
        seed=generation_data.get("seed"),
        aspect_ratio=generation_data.get("aspect_ratio")
    )
    db.add(db_gen)
    db.commit()
    db.refresh(db_gen)
    return db_gen
```

- [ ] save_generation() ì‘ì„±

**ImageMatching ë° HistoryImage CRUD**
```python
def save_image(db: Session, file_hash: str, file_directory: str):
    # ì¤‘ë³µ ì²´í¬
    existing = db.query(models.ImageMatching).filter(
        models.ImageMatching.file_hash == file_hash
    ).first()
    
    if existing:
        return existing
    
    db_image = models.ImageMatching(
        file_hash=file_hash,
        file_directory=file_directory
    )
    db.add(db_image)
    db.commit()
    db.refresh(db_image)
    return db_image

def save_history_image(db: Session, image_data: dict):
    db_history_image = models.HistoryImage(
        chat_history_id=image_data.get("chat_history_id"),
        generation_history_id=image_data.get("generation_history_id"),
        image_id=image_data["image_id"],
        role=image_data["role"],
        position=image_data["position"]
    )
    db.add(db_history_image)
    db.commit()
    db.refresh(db_history_image)
    return db_history_image
```

- [ ] save_image() ì‘ì„± (ì¤‘ë³µ ì²´í¬ í¬í•¨)
- [ ] save_history_image() ì‘ì„±

---

#### Day 10-11 (1/7-1/8): services.py ê¸°ë³¸ êµ¬ì¡°

**íŒŒì¼ ìƒì„±**: `src/backend/services.py`

```python
"""
ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
ê´‘ê³  ìƒì„± ì›Œí¬í”Œë¡œìš°
"""

import hashlib
import os
from datetime import datetime
from typing import Dict, Any
import logging

from . import process_db
# ì´í•˜ ë‚´ìš©ì€ ì¶”í›„ ì‘ì„±ëœ ë‚´ìš© í™•ì¸ í•„ìš”
from generation.image_generation.generator import SDXLGenerator
from generation.text_generation.prompt_manager import PromptTemplateManager
from utils.config import settings

logger = logging.getLogger(__name__)

# ì „ì—­ ê°ì²´ (í•œ ë²ˆë§Œ ë¡œë“œ)
sdxl_generator = None
prompt_manager = None

def init_generators():
    """AI ëª¨ë¸ ì´ˆê¸°í™”"""
    global sdxl_generator, prompt_manager
    
    try:
        sdxl_generator = SDXLGenerator()
        prompt_manager = PromptTemplateManager()
        logger.info("âœ… AI ëª¨ë¸ ì´ˆê¸°í™” ì™„ë£Œ")
    except Exception as e:
        logger.error(f"âŒ AI ëª¨ë¸ ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")
        raise
```

- [ ] íŒŒì¼ ìƒì„± ë° ê¸°ë³¸ import
- [ ] init_generators() í•¨ìˆ˜ ì‘ì„±

**ê´‘ê³  ìƒì„± ë©”ì¸ í•¨ìˆ˜ (ê³¨ê²©)**
```python
def generate_advertisement(
    db,
    session_id: str,
    user_input: str,
    aspect_ratio: str = "1:1",
    style: str = "realistic",
    industry: str = None
) -> Dict[str, Any]:
    """
    ê´‘ê³  ìƒì„± ë©”ì¸ í•¨ìˆ˜
    
    Args:
        db: DB ì„¸ì…˜
        session_id: ì±„íŒ… ì„¸ì…˜ ID
        user_input: ì‚¬ìš©ì ì…ë ¥ í…ìŠ¤íŠ¸
        aspect_ratio: ì´ë¯¸ì§€ ë¹„ìœ¨
        style: ìŠ¤íƒ€ì¼
        industry: ì—…ì¢…
    
    Returns:
        ìƒì„± ê²°ê³¼ ë”•ì…”ë„ˆë¦¬
    """
    try:
        logger.info(f"ğŸ¨ ê´‘ê³  ìƒì„± ì‹œì‘: {user_input[:50]}...")
        
        # 1. í”„ë¡¬í”„íŠ¸ ìƒì„± (4ë²ˆ ë‹´ë‹¹ì)
        # 2. ì´ë¯¸ì§€ ìƒì„± (3ë²ˆ ë‹´ë‹¹ì)
        # 3. ê´‘ê³  ë¬¸êµ¬ ìƒì„± (4ë²ˆ ë‹´ë‹¹ì)
        # 4. DB ì €ì¥
        # 5. ê²°ê³¼ ë°˜í™˜
        
        pass  # Day 12-14ì—ì„œ êµ¬í˜„
        
    except Exception as e:
        logger.error(f"âŒ ê´‘ê³  ìƒì„± ì‹¤íŒ¨: {e}")
        raise
```

- [ ] generate_advertisement() ê³¨ê²© ì‘ì„±
- [ ] ì£¼ì„ìœ¼ë¡œ í”Œë¡œìš° ì •ë¦¬

---

#### Day 12-14 (1/9-1/11): services.py êµ¬í˜„ ì™„ì„±

**1ë‹¨ê³„: í”„ë¡¬í”„íŠ¸ ìƒì„±**
```python
def generate_advertisement(db, session_id: str, user_input: str, 
                          aspect_ratio: str = "1:1", style: str = "realistic",
                          industry: str = None) -> Dict[str, Any]:
    try:
        logger.info(f"ğŸ¨ ê´‘ê³  ìƒì„± ì‹œì‘")
        
        # 1. í”„ë¡¬í”„íŠ¸ ìƒì„± (PromptTemplateManager í˜¸ì¶œ)
        image_prompt = prompt_manager.generate_image_prompt(
            user_input=user_input,
            style=style
        )
        logger.info(f"âœ… í”„ë¡¬í”„íŠ¸ ìƒì„± ì™„ë£Œ: {image_prompt[:50]}...")
        
        # ... (ê³„ì†)
```

- [ ] prompt_manager.generate_image_prompt() í˜¸ì¶œ
- [ ] ë¡œê¹… ì¶”ê°€

**2ë‹¨ê³„: ì´ë¯¸ì§€ ìƒì„±**
```python
        # 2. ì´ë¯¸ì§€ ìƒì„± (SDXLGenerator í˜¸ì¶œ)
        generation_result = sdxl_generator.generate(
            prompt=image_prompt,
            aspect_ratio=aspect_ratio
        )
        
        image_path = generation_result["image_path"]
        seed = generation_result["seed"]
        
        logger.info(f"âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ: {image_path}")
```

- [ ] sdxl_generator.generate() í˜¸ì¶œ
- [ ] ì´ë¯¸ì§€ ê²½ë¡œ ë° seed ë°›ê¸°

**3ë‹¨ê³„: íŒŒì¼ í•´ì‹œ ê³„ì‚°**
```python
        # 3. ì´ë¯¸ì§€ íŒŒì¼ í•´ì‹œ ê³„ì‚°
        with open(image_path, 'rb') as f:
            file_hash = hashlib.sha256(f.read()).hexdigest()
        
        logger.info(f"âœ… íŒŒì¼ í•´ì‹œ: {file_hash[:16]}...")
```

- [ ] SHA-256 í•´ì‹œ ê³„ì‚°

**4ë‹¨ê³„: ê´‘ê³  ë¬¸êµ¬ ìƒì„±**
```python
        # 4. ê´‘ê³  ë¬¸êµ¬ ìƒì„± (PromptTemplateManager í˜¸ì¶œ)
        ad_copy = prompt_manager.generate_ad_copy(
            user_input=user_input,
            style=style,
            industry=industry
        )
        
        logger.info(f"âœ… ê´‘ê³  ë¬¸êµ¬ ìƒì„±: {ad_copy[:30]}...")
```

- [ ] generate_ad_copy() í˜¸ì¶œ (4ë²ˆ ë‹´ë‹¹ìì™€ í˜‘ì˜)

**5ë‹¨ê³„: DB ì €ì¥ (í†µí•© ì›Œí¬í”Œë¡œìš°)**
```python
        # 5. DB ì €ì¥
        # 5-1. ìƒì„± ì´ë ¥
        generation = process_db.save_generation(db, {
            "session_id": session_id,
            "content_type": "image",
            "input_text": user_input,
            "output_text": ad_copy,
            "generation_method": "t2i",
            "style": style,
            "industry": industry,
            "seed": seed,
            "aspect_ratio": aspect_ratio
        })
        
        # 5-2. ì´ë¯¸ì§€ íŒŒì¼
        image = process_db.save_image(db, file_hash, image_path)
        
        # 5-3. ì´ë¯¸ì§€ ì—°ê²°
        process_db.save_history_image(db, {
            "generation_history_id": generation.id,
            "image_id": image.id,
            "role": "output",
            "position": 1
        })
        
        # 5-4. ì±„íŒ… ì´ë ¥ (ì‚¬ìš©ì)
        user_msg = process_db.save_chat_message(
            db, session_id, "user", user_input
        )
        
        # 5-5. ì±„íŒ… ì´ë ¥ (AI)
        ai_msg = process_db.save_chat_message(
            db, session_id, "assistant", ad_copy
        )
        
        # 5-6. AI ë©”ì‹œì§€ì— ì´ë¯¸ì§€ ì—°ê²°
        process_db.save_history_image(db, {
            "chat_history_id": ai_msg.id,
            "image_id": image.id,
            "role": "output",
            "position": 1
        })
        
        logger.info(f"âœ… DB ì €ì¥ ì™„ë£Œ")
```

- [ ] ì „ì²´ ì›Œí¬í”Œë¡œìš° êµ¬í˜„
- [ ] 6ë‹¨ê³„ DB ì €ì¥ (generation, image, history_image, chat x2, history_image)

**6ë‹¨ê³„: ê²°ê³¼ ë°˜í™˜**
```python
        # 6. ê²°ê³¼ ë°˜í™˜
        return {
            "generation_id": generation.id,
            "image_path": image_path,
            "image_url": f"/api/images/{file_hash}",
            "ad_copy": ad_copy,
            "seed": seed,
            "aspect_ratio": aspect_ratio,
            "style": style
        }
        
    except Exception as e:
        logger.error(f"âŒ ê´‘ê³  ìƒì„± ì‹¤íŒ¨: {e}")
        db.rollback()
        raise
```

- [ ] ê²°ê³¼ ë”•ì…”ë„ˆë¦¬ ë°˜í™˜
- [ ] ì˜ˆì™¸ ì²˜ë¦¬ (rollback í¬í•¨)

**ì „ì²´ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸**
```python
# í…ŒìŠ¤íŠ¸ ì½”ë“œ
if __name__ == "__main__":
    from process_db import SessionLocal, init_db, create_session
    
    # ì´ˆê¸°í™”
    init_db()
    init_generators()
    
    # DB ì„¸ì…˜
    db = SessionLocal()
    
    try:
        # ì„¸ì…˜ ìƒì„±
        session = create_session(db)
        
        # ê´‘ê³  ìƒì„±
        result = generate_advertisement(
            db,
            session_id=session.session_id,
            user_input="ì¹´í˜ ì‹ ë©”ë‰´ í™ë³´, ë”°ëœ»í•œ ëŠë‚Œ",
            aspect_ratio="1:1",
            style="realistic",
            industry="cafe"
        )
        
        print("âœ… ìƒì„± ì™„ë£Œ!")
        print(f"ì´ë¯¸ì§€: {result['image_path']}")
        print(f"ë¬¸êµ¬: {result['ad_copy']}")
        
    finally:
        db.close()
```

- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
- [ ] ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸

---

### ğŸ—“ 3ì£¼ì°¨ (1/12 ~ 1/15): í†µí•© ë° ìµœì í™”

#### Day 15-16 (1/12-1/13): ì´í˜„ì„ë‹˜, ë°°í˜„ì„ë‹˜ê³¼ í†µí•©

**ì´í˜„ì„ë‹˜ê³¼ í˜‘ì—…**
- [ ] SDXLGenerator ì¸í„°í˜ì´ìŠ¤ í™•ì¸
- [ ] generate() í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ í™•ì¸
- [ ] ë°˜í™˜ í˜•ì‹ í†µì¼ (image_path, seed)
- [ ] ì—ëŸ¬ ì²˜ë¦¬ í˜‘ì˜

**ë°°í˜„ì„ë‹˜ê³¼ í˜‘ì—…**
- [ ] PromptTemplateManager ì¸í„°í˜ì´ìŠ¤ í™•ì¸
- [ ] generate_image_prompt() í•¨ìˆ˜ í™•ì¸
- [ ] generate_ad_copy() í•¨ìˆ˜ í˜‘ì˜ (ì‹ ê·œ)
- [ ] ë°˜í™˜ í˜•ì‹ í†µì¼

**í†µí•© í…ŒìŠ¤íŠ¸**
```python
# ì´í˜„ì„ë‹˜ ì½”ë“œ import
from generation.image_generation.generator import SDXLGenerator

# ë°°í˜„ì„ë‹˜ ì½”ë“œ import
from generation.text_generation.prompt_manager import PromptTemplateManager

# í†µí•© í…ŒìŠ¤íŠ¸
generator = SDXLGenerator()
prompt_mgr = PromptTemplateManager()

# ì‹¤ì œ ìƒì„±
result = generate_advertisement(db, ...)
```

- [ ] ì „ì²´ í”Œë¡œìš° í†µí•© í…ŒìŠ¤íŠ¸
- [ ] ì—ëŸ¬ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸

---

#### Day 17-18 (1/14-1/15): ì´ìœ ë…¸ë‹˜ê³¼ API ì—°ë™

**ì´ìœ ë…¸ë‹˜ê³¼ í˜‘ì—…**

**routes.pyì—ì„œ services.py í˜¸ì¶œ**
```python
# routes.py (ì´ìœ ë…¸ë‹˜ ì‘ì„±)
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session
from . import services, schemas
from .process_db import get_db

router = APIRouter()

@router.post("/generate")
def generate_ad_api(
    request: schemas.GenerationRequest,
    db: Session = Depends(get_db)
):
    """ê´‘ê³  ìƒì„± API"""
    result = services.generate_advertisement(
        db=db,
        session_id=request.session_id,
        user_input=request.input_text,
        aspect_ratio=request.aspect_ratio
    )
    
    return {
        "generation_id": result["generation_id"],
        "image_url": result["image_url"],
        "ad_copy": result["ad_copy"]
    }
```

- [ ] API ì—”ë“œí¬ì¸íŠ¸ ì—°ë™
- [ ] ìš”ì²­/ì‘ë‹µ í˜•ì‹ í˜‘ì˜
- [ ] ì—ëŸ¬ ì²˜ë¦¬ í˜‘ì˜

**Postman í…ŒìŠ¤íŠ¸**
```json
POST /api/generate
{
    "session_id": "abc-123-def",
    "input_text": "ì¹´í˜ ì‹ ë©”ë‰´ í™ë³´",
    "aspect_ratio": "1:1"
}
```

- [ ] API í…ŒìŠ¤íŠ¸ (Postman)
- [ ] ì „ì²´ í”Œë¡œìš° ê²€ì¦

---

## ğŸ“… 2ë‹¨ê³„ (ê°œì„ ): 2026-01-16 ~ 27

### ğŸ—“ 4ì£¼ì°¨ (1/16 ~ 1/22): ê³ ê¸‰ ê¸°ëŠ¥

#### Day 19-20 (1/16-1/17): Eager Loading ìµœì í™”

**N+1 ë¬¸ì œ í•´ê²°**
```python
from sqlalchemy.orm import joinedload

def get_chat_history_with_images(db: Session, session_id: str):
    return db.query(models.ChatHistory).options(
        joinedload(models.ChatHistory.images).joinedload(
            models.HistoryImage.image
        )
    ).filter(
        models.ChatHistory.session_id == session_id
    ).order_by(
        models.ChatHistory.created_at
    ).all()
```

- [ ] joinedload ì ìš©
- [ ] ì¿¼ë¦¬ ê°œìˆ˜ í™•ì¸ (before/after)

---

#### Day 21-22 (1/18-1/19): í˜ì´ì§€ë„¤ì´ì…˜

**í˜ì´ì§€ë„¤ì´ì…˜ í•¨ìˆ˜**
```python
def get_paginated_generations(
    db: Session,
    user_id: int,
    page: int = 1,
    page_size: int = 20
):
    from sqlalchemy import func
    import math
    
    total = db.query(func.count(models.GenerationHistory.id)).join(
        models.ChatSession
    ).filter(
        models.ChatSession.user_id == user_id
    ).scalar()
    
    skip = (page - 1) * page_size
    items = db.query(models.GenerationHistory).join(
        models.ChatSession
    ).filter(
        models.ChatSession.user_id == user_id
    ).order_by(
        models.GenerationHistory.created_at.desc()
    ).offset(skip).limit(page_size).all()
    
    return {
        "items": items,
        "total": total,
        "page": page,
        "page_size": page_size,
        "total_pages": math.ceil(total / page_size)
    }
```

- [ ] í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„
- [ ] API ì—°ë™ (ì´ìœ ë…¸ë‹˜)

---

#### Day 23-24 (1/20-1/21): ë¹„ë™ê¸° ì²˜ë¦¬ (ì„ íƒ)

**FastAPI ë¹„ë™ê¸° ì§€ì›**
```python
# services.py
async def generate_advertisement_async(
    db,
    session_id: str,
    user_input: str,
    ...
):
    """ë¹„ë™ê¸° ê´‘ê³  ìƒì„±"""
    # AI ìƒì„±ì€ ë¸”ë¡œí‚¹ì´ë¯€ë¡œ ThreadPoolExecutor ì‚¬ìš©
    import asyncio
    from concurrent.futures import ThreadPoolExecutor
    
    executor = ThreadPoolExecutor(max_workers=2)
    loop = asyncio.get_event_loop()
    
    # ì´ë¯¸ì§€ ìƒì„±ì„ ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ
    image_task = loop.run_in_executor(
        executor,
        sdxl_generator.generate,
        image_prompt,
        aspect_ratio
    )
    
    result = await image_task
    
    # ... (ë‚˜ë¨¸ì§€ ë™ì¼)
```

- [ ] ë¹„ë™ê¸° ë²„ì „ êµ¬í˜„ (ì„ íƒ)
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

---

### ğŸ—“ 5ì£¼ì°¨ (1/23 ~ 1/27): ë§ˆë¬´ë¦¬

#### Day 25-26 (1/23-1/24): í†µê³„ ë° ëŒ€ì‹œë³´ë“œ API

**ì‚¬ìš©ì í†µê³„**
```python
def get_user_statistics(db: Session, user_id: int):
    from sqlalchemy import func
    
    stats = {
        "total_sessions": db.query(func.count(models.ChatSession.session_id))
            .filter(models.ChatSession.user_id == user_id).scalar(),
        
        "total_generations": db.query(func.count(models.GenerationHistory.id))
            .join(models.ChatSession)
            .filter(models.ChatSession.user_id == user_id).scalar(),
        
        "total_messages": db.query(func.count(models.ChatHistory.id))
            .join(models.ChatSession)
            .filter(models.ChatSession.user_id == user_id).scalar()
    }
    
    return stats
```

- [ ] í†µê³„ í•¨ìˆ˜ êµ¬í˜„
- [ ] API ì—”ë“œí¬ì¸íŠ¸ ì—°ë™

---

#### Day 27-30 (1/25-1/27): ë¬¸ì„œí™” ë° ìµœì¢… í…ŒìŠ¤íŠ¸

**Docstring ì¶”ê°€**
- [ ] ëª¨ë“  í•¨ìˆ˜ì— ì„¤ëª… ì¶”ê°€
- [ ] íƒ€ì… íŒíŠ¸ í™•ì¸

**í†µí•© í…ŒìŠ¤íŠ¸**
- [ ] ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- [ ] ì—ëŸ¬ ì¼€ì´ìŠ¤ í…ŒìŠ¤íŠ¸
- [ ] ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

**ë¬¸ì„œ ì‘ì„±**
- [ ] API ë¬¸ì„œ (1ë²ˆ ë‹´ë‹¹ìì™€ í˜‘ì—…)
- [ ] DB ìŠ¤í‚¤ë§ˆ ë¬¸ì„œ
- [ ] ë°°í¬ ê°€ì´ë“œ (5ë²ˆ ë‹´ë‹¹ìì™€ í˜‘ì—…)

---

## ğŸ¤ í˜‘ì—… í¬ì¸íŠ¸

### ì´ìœ ë…¸ë‹˜ (API)
- [ ] schemas.py ê³µìœ 
- [ ] get_db() ì˜ì¡´ì„± ì‚¬ìš©ë²•
- [ ] services.generate_advertisement() í˜¸ì¶œ
- [ ] ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ í†µì¼

### ì´í˜„ì„ë‹˜ (ì´ë¯¸ì§€ ìƒì„±)
- [ ] SDXLGenerator ì¸í„°í˜ì´ìŠ¤ í™•ì¸
- [ ] generate() ë°˜í™˜ í˜•ì‹ í†µì¼
- [ ] ì—ëŸ¬ ì²˜ë¦¬ í˜‘ì˜

### ë°°í˜„ì„ë‹˜ (í…ìŠ¤íŠ¸ ìƒì„±)
- [ ] PromptTemplateManager ì¸í„°í˜ì´ìŠ¤ í™•ì¸
- [ ] generate_ad_copy() í•¨ìˆ˜ í˜‘ì˜
- [ ] í”„ë¡¬í”„íŠ¸ í˜•ì‹ í†µì¼

### ì‹ ìŠ¹ëª©ë‹˜ (ì¸í”„ë¼)
- [ ] DATABASE_URL í™˜ê²½ ë³€ìˆ˜
- [ ] í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸
- [ ] ì´ë¯¸ì§€ ì €ì¥ ê²½ë¡œ í™•ì¸

---

## ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸ ìš”ì•½

### Week 1: DB ì„¤ê³„
- [ ] PostgreSQL ì„¤ì¹˜ ë° ì„¤ì •
- [ ] models.py ì‘ì„± (6ê°œ í…Œì´ë¸”)
- [ ] process_db.py ê¸°ë³¸ êµ¬ì¡°
- [ ] schemas.py ì‘ì„±
- [ ] í…Œì´ë¸” ìƒì„± ì™„ë£Œ

### Week 2: CRUD ë° services.py
- [ ] ëª¨ë“  CRUD í•¨ìˆ˜ ì‘ì„±
- [ ] services.py ê¸°ë³¸ êµ¬ì¡°
- [ ] generate_advertisement() êµ¬í˜„
- [ ] í†µí•© ì›Œí¬í”Œë¡œìš° ì™„ì„±

### Week 3: í†µí•© ë° í…ŒìŠ¤íŠ¸
- [ ] 3ë²ˆ, 4ë²ˆ ë‹´ë‹¹ìì™€ í†µí•©
- [ ] 1ë²ˆ ë‹´ë‹¹ìì™€ API ì—°ë™
- [ ] ì „ì²´ í”Œë¡œìš° í…ŒìŠ¤íŠ¸

### Week 4: ê³ ê¸‰ ê¸°ëŠ¥
- [ ] Eager Loading ìµœì í™”
- [ ] í˜ì´ì§€ë„¤ì´ì…˜
- [ ] í†µê³„ API
- [ ] ë¬¸ì„œí™”

---

**ì‘ì„±ì¼**: 2025-01-05  
**ë²„ì „**: ìµœì¢… í†µí•©ë³¸
**ë‹´ë‹¹ì**: ì§„ìˆ˜ê²½ë‹˜ (ë°±ì—”ë“œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)  
**ìµœì¢… ìˆ˜ì •**: 2026-01-05