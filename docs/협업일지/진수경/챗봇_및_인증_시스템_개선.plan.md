# 챗봇 및 인증 시스템 개선 계획

## 개요

현재 시스템의 챗봇 기능, 인증 보안, 사용자 경험을 개선하기 위한 종합 계획입니다.

---

## 1. 스트리밍 챗봇 구현

### 목표
챗봇 응답을 실시간으로 스트리밍하여 사용자 경험 개선

### 백엔드 구현

**파일**: `main.py`

- `POST /chat/message/stream` 엔드포인트만 스트리밍으로 제공
- `handle_chat_message_stream`에서 상담(intent="consulting") 응답을 스트리밍으로 전송
- LLM 응답을 청크 단위로 실시간 전송

**구현 세부사항**:
```python
from fastapi.responses import StreamingResponse
import json

@app.post("/chat/message/stream")
async def chat_message_stream(...):
    async def generate_response():
        async for chunk in llm_response_stream:
            yield f"data: {json.dumps({'chunk': chunk})}\n\n"
    return StreamingResponse(generate_response(), media_type="text/event-stream")
```

### 프론트엔드 구현

**파일**: `src/frontend/test.html`

- `fetch`를 `ReadableStream` 처리로 변경
- EventSource 또는 ReadableStream API 사용
- 스트림 청크를 순차적으로 렌더링
- 완료 후 최종 응답을 DB에 저장

**구현 세부사항**:
```javascript
async function sendChatStream() {
    const eventSource = new EventSource(`${API_BASE}/chat/message/stream`);
    const placeholderId = appendAssistantPlaceholder("");
    
    eventSource.onmessage = (event) => {
        const data = JSON.parse(event.data);
        updateAssistantPlaceholder(placeholderId, data.chunk);
    };
}
```

---

## 2. 채팅 버블에 마크다운 적용 (프론트엔드)

### 목표
채팅 메시지에 마크다운 형식 적용으로 가독성 향상

### 구현

**파일**: `src/frontend/test.html`

- `marked.js` 또는 `marked` 라이브러리 CDN 추가
- `createMessageElement` 함수에서 `escapeHtml` 대신 마크다운 파싱 적용
- XSS 방지를 위한 `DOMPurify` 통합
- 코드 블록, 링크, 강조 표시 등 기본 마크다운 지원

**변경 사항**:
```javascript
// 기존: escapeHtml(text)
// 변경: marked.parse(DOMPurify.sanitize(text))
```

**라이브러리**:
- `marked` (마크다운 파서)
- `DOMPurify` (XSS 방지)

---

## 3. 스트리밍 생성 중 주요 로그 사용자 표시

### 목표
생성 과정의 주요 단계를 사용자에게 실시간 표시

### 백엔드 구현

**파일**: `src/backend/services.py`

- `handle_chat_message_stream`에서 `progress` 이벤트 전송
- 주요 단계별 메시지 설정:
  - "의도 분석 중..."
  - "이미지 생성 중... (스타일: 실사)"
  - "광고 문구 생성 중..."
  - "결과 저장 중..."

### 프론트엔드 구현

**파일**: `src/frontend/test.html`

- 스트리밍 이벤트에서 `progress` 메시지 표시
- 스피너와 함께 진행 상태 메시지 업데이트

**변경 사항**:
```javascript
// 스트리밍 이벤트 처리
const message = payload.message || "처리 중...";
updateAssistantPlaceholder(placeholderId, message);
```

---

## 4. 이미지/텍스트 생성 자동 구분 및 플랫폼별 비율 결정

### 목표
메시지 분석 시 생성 타입(이미지/텍스트) 및 플랫폼별 이미지 비율 자동 결정

### 백엔드 구현

**파일**: `src/backend/chatbot.py`

- `LLMOrchestrator.analyze_intent`의 시스템 프롬프트 확장
- 생성 타입 구분: `image`, `text`
- 플랫폼 감지: `instagram`(1:1), `story`(9:16), `naver`, `facebook`(4:3)
- 반환 형식: `{intent, generation_type, platform, aspect_ratio}`

**프롬프트 예시**:
```
플랫폼별 비율 결정:
- instagram, 피드: 1:1
- youtube, 배너: 16:9
- story, 릴스, 스토리: 9:16
- facebook: 4:3
- naver, 네이버, 스마트스토어, 네이버 지도
- 당근
- 배달, 배민
```

**파일**: `src/backend/services.py`

- `_execute_generation_pipeline`에서 플랫폼 기반 비율 자동 적용
- 플랫폼별 기본값 매핑:
  - `instagram`: "1:1"
  - `youtube`: "16:9"
  - `story`: "9:16"
  - `facebook`: "4:3"

---

## 5. 업종/광고 형태 기반 스타일 자동 결정

### 목표
사용자의 업종과 원하는 광고 형태에 따라 이미지 스타일 자동 결정

### 백엔드 구현

**파일**: `src/backend/chatbot.py`

- `LLMOrchestrator.analyze_intent`에 스타일 분석 로직 추가
- 업종 및 분위기 키워드 기반 스타일 결정:
  - `ultra_realistic`: 고급/프로페셔널한 이미지
  - `semi_realistic`: 친근한/웜톤 이미지
  - `anime`: 캐주얼/브랜드 이미지, 이벤트나 공지는 이쪽으로
- 컨텍스트 고려: 이전 생성 이력, 업종 정보, 사용자 요청 분위기

**스타일 결정 예시**:
```
- 카페/카페테리아 → semi_realistic
- 고급 레스토랑, 음식쪽 → ultra_realistic
- 브랜드/패션, 템플릿 → anime
```

**파일**: `src/backend/services.py`

- `generate_contents`에서 스타일 파라미터 자동 적용

---

## 6. JWT를 HttpOnly 쿠키로 변경

### 목표
XSS 공격 방지를 위해 JWT를 HttpOnly 쿠키로 저장

### 백엔드 구현

**파일**: `src/backend/services.py`

- `authenticate_user` 함수 수정: 토큰을 `Set-Cookie` 헤더로 전송
- 쿠키 옵션: `httpOnly=True`, `secure=True` (HTTPS), `sameSite="lax"`
- `get_current_user` 함수 수정: Authorization 헤더 대신 쿠키에서 토큰 읽기

**변경 사항**:
```python
# 기존: return {"access_token": token}
# 변경:
response.set_cookie(
    key="access_token",
    value=token,
    httponly=True,
    secure=True,
    samesite="lax"
)
```

**파일**: `main.py`

- `POST /auth/logout` 엔드포인트에서 쿠키 삭제 처리

### 프론트엔드 구현

**파일**: `src/frontend/test.html`

- `localStorage`에서 JWT 제거
- 모든 API 호출에 `credentials: 'include'` 설정
- 쿠키는 자동으로 전송되므로 헤더 수정 불필요

**변경 사항**:
```javascript
// 기존: headers: { Authorization: `Bearer ${token}` }
// 변경: credentials: 'include' (쿠키 자동 전송)
```

---

## 7. 라우터 및 엔드포인트 정리

### 목표
`main.py`와 `chat.py`의 라우터 및 엔드포인트 구조화

### main.py 정리

- `/generate` 엔드포인트 제거 (또는 `chat.py`로 이동)
- `/auth/*` 엔드포인트 유지 (인증 관련)
- `/chat/*` 엔드포인트는 `chat.py`로 위임
- `/images/{hash}` 유지 (이미지 서빙)
- `/chat/history` 유지 (히스토리 조회)

**최종 구조**:
```
main.py:
  - /auth/login
  - /auth/signup
  - /auth/logout
  - /auth/me
  - /auth/user (PUT, DELETE)
  - /images/{hash}
  - /chat/history
  - /chat/history/{session_id}
  - /chat/generation/{session_id}
  - /chat/message/stream
  - /chat/session
```

---

## 8. 수정/확정 컬럼 제거 및 메시지 분석 기반 확인

### 목표
UI 버튼 제거, 메시지 분석을 통한 자동 확정/수정 처리

### 데이터베이스 변경

**마이그레이션**: `alembic/versions/003_remove_revision_columns.py`

- `generation_history` 테이블에서 다음 컬럼 제거:
  - `is_confirmed`
  - `revision_of_id`
  - `revision_number`

**파일**: `src/backend/models.py`

- `GenerationHistory` 모델에서 관련 필드 제거

### 백엔드 구현

**파일**: `src/backend/services.py`

- `handle_chat_confirm` 함수 제거
- `handle_chat_revise` 함수 제거
- 메시지 분석에서 자동 확정/수정 처리:
  - "완벽해", "확정", "이대로 해줘" → 최신 생성 확정
  - "다시", "수정", "변경" → 수정 요청

**변경 사항**:
```python
# handle_chat_message에서
if intent == "modification":
    # 수정 요청 자동 처리
    if "확정" in message or "완벽" in message:
        # 최신 생성 확정 처리 (내부적으로만)
        auto_confirm_latest_generation(session_id)
```

### 프론트엔드 구현

**파일**: `src/frontend/test.html`

- `adActions` div 및 관련 버튼 제거
- `handleRevise`, `handleConfirm` 함수 제거
- `checkUnconfirmedGeneration` 함수 제거
- UI에서 수정/확정 버튼 완전 제거

---

## 9. 관리자용 생성 히스토리 조회 페이지

### 목표
관리자 계정으로 모든 사용자의 생성 히스토리 조회 기능 제공

### 데이터베이스 변경

**마이그레이션**: `alembic/versions/004_add_admin_role.py`

**파일**: `src/backend/models.py`

- `User` 모델에 `is_admin: Boolean` 필드 추가 (기본값: False)
- 관리자 계정 생성 마이그레이션
- login_id = 'admin'인 사람한테 주면 됨
- 한 페이지에 5개씩 보여주기(왜냐면 프롬프트가 꽤나 길다)

### 백엔드 구현

**새 파일**: `src/backend/routers/admin.py`

- `GET /admin/generations`: 전체 생성 히스토리 조회
  - 페이징 지원 (limit, offset)
  - 필터링 (사용자, 날짜, 타입)
  - 응답 형식:
    ```json
    {
      "generations": [
        {
          "user_name": "홍길동",
          "user_input": "카페 광고 만들어줘",
          "input_image": "url",
          "prompt": "prompt text",
          "generated_image": "url",
          "created_at": "2026-01-16T..."
        }
      ],
      "total": 100,
      "page": 1
    }
    ```
- 관리자 권한 검증 미들웨어

**파일**: `main.py`

- `admin.py` 라우터 등록

### 프론트엔드 구현

**새 파일**: `src/frontend/admin.html`

- 관리자 전용 히스토리 조회 페이지
- 테이블 형식으로 히스토리 표시
- 필터링 및 검색 기능
- 이미지 미리보기 모달
- 관리자 로그인 체크

---

## 구현 순서 및 우선순위

### Phase 1: 기반 구조 정리(완료)
1. 라우터 및 엔드포인트 정리 (7번)
2. 인증 쿠키 전환 (6번)

### Phase 2: UI/UX 개선(완료)
3. 채팅 버블 마크다운 렌더링 (2번)
4. 스트리밍 챗봇 구현 (1번)

### Phase 3: 분석 로직 개선(완료)
5. 이미지/텍스트 생성 구분 및 플랫폼별 비율 (4번)
6. 업종 기반 스타일 자동 결정 (5번)

### Phase 4: 사용자 경험 개선
7. 생성 중 로그 표시 (3번)

### Phase 5: 기능 단순화(완료)
8. 수정/확정 컬럼 제거 및 자동 처리 (8번)

### Phase 6: 관리 기능
9. 관리자 페이지 구현 (9번)

---

## 주의사항 및 고려사항

### 보안
- HttpOnly 쿠키 전환 시 기존 JWT 사용자 로그아웃 처리 필요
- 관리자 페이지 접근 권한 엄격히 제어
- XSS 방지를 위한 마크다운 렌더링 시 DOMPurify 필수

### 데이터 마이그레이션
- 수정/확정 컬럼 제거 전 백업 필수
- 기존 `is_confirmed=True` 데이터 처리 방안 검토
- 마이그레이션 롤백 계획 수립

### 성능
- 스트리밍 구현 시 연결 유지 및 에러 핸들링 중요
- 관리자 페이지 대용량 데이터 조회 시 페이징/인덱싱 필수
- LLM 호출 빈도 증가에 따른 비용 모니터링

### 호환성
- 기존 API 클라이언트와의 호환성 고려
- 점진적 마이그레이션 전략 검토

---

## 예상 작업 시간

- Phase 1: 4-6시간
- Phase 2: 6-8시간
- Phase 3: 8-10시간
- Phase 4: 3-4시간
- Phase 5: 4-5시간
- Phase 6: 6-8시간

**총 예상 시간**: 31-41시간

---

## 테스트 체크리스트

- [ ] 스트리밍 응답이 정상적으로 표시되는가?
- [ ] 마크다운이 올바르게 렌더링되는가?
- [ ] XSS 공격이 차단되는가?
- [ ] 쿠키 인증이 정상 작동하는가?
- [ ] 플랫폼별 비율이 자동으로 결정되는가?
- [ ] 스타일이 업종에 맞게 자동 결정되는가?
- [ ] 생성 중 메시지가 표시되는가?
- [ ] 메시지 분석 기반 확정/수정이 작동하는가?
- [ ] 관리자 페이지가 정상적으로 작동하는가?
- [ ] 마이그레이션이 롤백 가능한가?
