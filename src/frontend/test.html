<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>AI ê´‘ê³  ì±—ë´‡ í…ŒìŠ¤íŠ¸ ì„¼í„°</title>
  <style>
    body { font-family: 'Pretendard', sans-serif; background: #f8f9fa; margin: 0; display: flex; flex-direction: column; height: 100vh; }

    /* í—¤ë” ìŠ¤íƒ€ì¼: ìš°ìƒë‹¨ ë²„íŠ¼ ë°°ì¹˜ */
    header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); position: relative; z-index: 10; }
    .logo { font-weight: bold; color: #4F46E5; font-size: 1.2rem; }
    .auth-buttons button { width: auto; padding: 8px 15px; margin-left: 5px; font-size: 0.9rem; border-radius: 6px; }

    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
    .main-container { flex: 1; display: flex; justify-content: center; align-items: flex-start; overflow: hidden; }
    .chat-container { width: 100%; background: white; display: flex; flex-direction: column; height: 100%; }

    /* ì±„íŒ… ì˜ì—­ */
    .chat-box { flex: 1; overflow-y: auto; padding: 20px; background: #fafbfc; border-bottom: 1px solid #eee; }
    .msg { margin-bottom: 15px; padding: 14px 18px; border-radius: 16px; font-size: 14px; line-height: 1.6; max-width: 75%; position: relative; word-wrap: break-word; }
    .user { background: linear-gradient(135deg, #667eea 0%, #4F46E5 100%); color: white; margin-left: auto; border-bottom-right-radius: 4px; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3); }
    .assistant { background: white; color: #333; margin-right: auto; border-bottom-left-radius: 4px; border: 1px solid #e9ecef; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

    /* ì…ë ¥ ì˜ì—­ */
    .input-area { padding: 20px; display: flex; gap: 12px; background: white; }
    input[type="text"] { flex: 1; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 10px; outline: none; font-size: 14px; transition: all 0.2s; }
    input[type="text"]:focus { border-color: #4F46E5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

    /* ê³µí†µ ë²„íŠ¼ */
    button { cursor: pointer; border: none; font-weight: 600; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #4F46E5 100%); color: white; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); }
    .btn-secondary { background: #f8f9fa; color: #495057; border: 1px solid #e9ecef; }
    .btn-secondary:hover { background: #e9ecef; }
    .btn-round { border-radius: 10px; }

    /* ë¡œê·¸ì¸ ëª¨ë‹¬(íŒì—…) ìŠ¤íƒ€ì¼ */
    #auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-content { background: white; padding: 40px; border-radius: 16px; width: 400px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    .close-btn { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 24px; color: #999; transition: color 0.2s; }
    .close-btn:hover { color: #333; }
    .modal-content h2 { margin: 0 0 30px 0; font-size: 24px; color: #333; text-align: center; }
    .modal-content input { width: 100%; padding: 14px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 12px; font-size: 14px; box-sizing: border-box; transition: border-color 0.2s; }
    .modal-content input:focus { border-color: #4F46E5; outline: none; }
    .modal-content button { margin-top: 10px; padding: 14px; font-size: 15px; border-radius: 8px; }
    .auth-toggle { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #f0f0f0; }
    .auth-toggle-text { font-size: 14px; color: #666; margin-bottom: 8px; }
    .auth-toggle-link { color: #4F46E5; font-weight: 600; cursor: pointer; text-decoration: none; font-size: 14px; }
    .auth-toggle-link:hover { text-decoration: underline; }

    /* íšŒì›ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ */
    #profile-edit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(4px); }
    .profile-edit-row {
      margin-bottom: 12px;
    }
    .profile-edit-row label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .profile-edit-row.required label::after {
      content: ' *';
      color: #dc3545;
      font-weight: bold;
    }

    .hidden { display: none !important; }

    /* ë©”ì‹œì§€ ë‚´ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .msg img {
      max-width: 300px;
      max-height: 300px;
      margin-top: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s;
      object-fit: contain;
    }
    .msg img:hover {
      opacity: 0.9;
    }

    .user-info { font-size: 0.9rem; color: #666; margin-right: 15px; }

    /* ì´ë¯¸ì§€ ëª¨ë‹¬ ë¼ì´íŠ¸ë°•ìŠ¤ */
    #image-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      cursor: pointer;
    }

    #image-modal img {
      max-width: 95%;
      max-height: 95%;
      object-fit: contain;
      border-radius: 0;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    }

    #image-modal .close-modal {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 40px;
      color: white;
      cursor: pointer;
      z-index: 2001;
      transition: color 0.2s;
    }

    #image-modal .close-modal:hover {
      color: #ccc;
    }

    /*ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼*/
    .image-upload-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #f1f3f5;
      border: 1px solid #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }
    .image-upload-btn:hover:not(.disabled) {
      background: #e9ecef;
      transform: scale(1.05);
    }
    .image-upload-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: #f8f9fa;
    }

    /* input-areaë¥¼ ì„¸ë¡œ ìŠ¤íƒìœ¼ë¡œ */
    .input-area {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: white;
    }

    /* ê´‘ê³  ì•¡ì…˜ ë²„íŠ¼ ê·¸ë£¹ (ìˆ˜ì •/í™•ì •) */
    .ad-actions {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      align-items: center;
      margin-top: 10px;
    }
    .ad-actions .label {
      font-size: 13px;
      color: #666;
      margin-right: auto;
    }
    .ad-actions button {
      padding: 8px 16px;
      font-size: 13px;
      border-radius: 6px;
    }
    .btn-revise {
      background: #ffc107;
      color: #000;
    }
    .btn-revise:hover {
      background: #ffb300;
    }
    .btn-confirm {
      background: #28a745;
      color: white;
    }
    .btn-confirm:hover {
      background: #218838;
    }

    /* ì…ë ¥ í•œ ì¤„ */
    .input-row {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* ë¯¸ë¦¬ë³´ê¸° ìŠ¤íŠ¸ë¦½ */
    .preview-strip {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 6px 2px;
      overflow-x: auto;
    }

    /* ì¸ë„¤ì¼ ì¹´ë“œ */
    .preview-item {
      position: relative;
      width: 64px;
      height: 64px;
      border-radius: 14px;
      overflow: hidden;
      border: 1px solid #e9ecef;
      background: #fff;
      flex: 0 0 auto;
    }
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      margin: 0;
    }

    /* ì¸ë„¤ì¼ X ë²„íŠ¼ */
    .preview-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid white;
      background: rgba(0,0,0,0.75);
      color: white;
      font-size: 14px;
      line-height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2;
    }

    /* disabled ì „ì†¡ ë²„íŠ¼ */
    #sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

  </style>
</head>
<body>
<header>
  <div class="logo">AD Chatbot</div>
  <div class="auth-buttons">
    <span id="userInfo" class="user-info hidden"></span>
    <button id="loginTabBtn" class="btn-secondary" onclick="openModal()">ë¡œê·¸ì¸</button>
    <button id="profileEditBtn" class="btn-secondary hidden" onclick="openProfileEditModal()">íšŒì›ì •ë³´ ìˆ˜ì •</button>
    <button id="logoutBtn" class="btn-secondary hidden" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</header>

<div class="main-container">
  <div class="chat-container">
    <div class="chat-box" id="chatBox">
      <div class="msg assistant">ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ê´‘ê³  ì•„ì´ë””ì–´ê°€ í•„ìš”í•˜ì‹ ê°€ìš”?</div>
    </div>
    <div class="input-area">
      <!-- ë¯¸ë¦¬ë³´ê¸° ìŠ¤íŠ¸ë¦½ -->
      <div id="previewStrip" class="preview-strip hidden"></div>

      <!-- ê´‘ê³  ìˆ˜ì •/í™•ì • ì•¡ì…˜ ë²„íŠ¼ (ìƒì„± ì™„ë£Œ í›„ í‘œì‹œ) -->
      <div id="adActions" class="ad-actions hidden">
        <span class="label">ìƒì„±ëœ ê´‘ê³ :</span>
        <button class="btn-revise" onclick="handleRevise()">ìˆ˜ì • ìš”ì²­</button>
        <button class="btn-confirm" onclick="handleConfirm()">í™•ì •í•˜ê¸°</button>
      </div>

      <!-- ì…ë ¥/ë²„íŠ¼ í•œ ì¤„ -->
      <div class="input-row">
        <label for="imageUpload" id="imageUploadLabel" class="image-upload-btn" title="ì´ë¯¸ì§€ ì—…ë¡œë“œ">ğŸ“·</label>
        <input type="file" id="imageUpload" accept="image/*" hidden onchange="handleImageUpload(event)">

        <input type="text" id="userMsg" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ì¹´í˜ ê´‘ê³  ë§Œë“¤ì–´ì¤˜)"
               oninput="updateSendButton()"
               onkeypress="if(event.keyCode==13) sendChat()">

        <button id="sendBtn" class="btn-primary btn-round"
                style="width: 80px; padding: 14px;"
                onclick="sendChat()" disabled>ì „ì†¡</button>
      </div>
    </div>
  </div>
</div>

<div id="auth-modal" class="hidden" onclick="closeModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="closeModal()">&times;</span>
    <h2 id="auth-title">ë¡œê·¸ì¸</h2>
    <input type="text" id="loginId" placeholder="ì•„ì´ë””" onkeypress="if(event.keyCode==13) handleAuth()">
    <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeypress="if(event.keyCode==13) handleAuth()">
    <div id="signup-fields" class="hidden">
      <input type="text" id="nickname" placeholder="ì´ë¦„" onkeypress="if(event.keyCode==13) handleAuth()">
    </div>
    <button id="main-btn" class="btn-primary" style="width: 100%;" onclick="handleAuth()">ë¡œê·¸ì¸</button>
    <div class="auth-toggle">
      <div class="auth-toggle-text" id="toggle-question">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?</div>
      <a class="auth-toggle-link" id="toggle-link" onclick="toggleAuth()">íšŒì›ê°€ì…í•˜ê¸°</a>
    </div>
  </div>
</div>

<div id="profile-edit-modal" class="hidden" onclick="closeProfileEditModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close-btn" onclick="closeProfileEditModal()">&times;</span>
    <h2>íšŒì›ì •ë³´ ìˆ˜ì •</h2>
    <div class="profile-edit-row">
      <label for="editName">ì´ë¦„</label>
      <input type="text" id="editName" placeholder="ì´ë¦„">
    </div>
    <div class="profile-edit-row required">
      <label for="editCurrentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="editCurrentPassword" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" required>
    </div>
    <div class="profile-edit-row">
      <label for="editNewPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="editNewPassword" placeholder="ë³€ê²½í•  ë¹„ë°€ë²ˆí˜¸ (ì„ íƒì‚¬í•­)">
    </div>
    <button class="btn-primary" style="width: 100%;" onclick="handleProfileUpdate()">ìˆ˜ì •í•˜ê¸°</button>
  </div>
</div>

<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ ë¼ì´íŠ¸ë°•ìŠ¤ -->
<div id="image-modal" class="hidden" onclick="closeImageModal()">
  <span class="close-modal">&times;</span>
  <img id="modal-image" src="" alt="Full size image">
</div>

<script>
    const API_BASE = window.location.origin;
    let currentSessionId = null;
    let isSignup = false;
    let selectedImageFile = null; // ë‹¨ì¼ íŒŒì¼ ê°ì²´ ì €ì¥
    let oldestMessageId = null;
    let nextCursor = null;
    let isLoadingHistory = false;
    let hasUnconfirmedGeneration = false; // í™•ì •ë˜ì§€ ì•Šì€ ìƒì„± ê²°ê³¼ ì—¬ë¶€


    // ====== ì•ˆì „ JSON íŒŒì„œ ======
    async function safeJson(res) {
        try { return await res.json(); } catch { return {}; }
    }

    // ====== ì±„íŒ… ë Œë” ìœ í‹¸ ======
    function clearChatBox() {
        const box = document.getElementById('chatBox');
        box.innerHTML = '';
    }

    async function fetchHistoryPage(limit, cursor) {
        const token = localStorage.getItem("access_token");
        if (!token) return { items: [], next_cursor: null };

        const params = new URLSearchParams();
        params.set("limit", String(limit));
        if (cursor) params.set("cursor", String(cursor));

        const res = await fetch(`${API_BASE}/chat/history?${params.toString()}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
            },
        });

        if (!res.ok) return { items: [], next_cursor: null };
        return await safeJson(res);
    }

    function createMessageElement(role, text, imageUrls, messageId) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        if (messageId) div.dataset.messageId = String(messageId);

        if (text) div.innerHTML = `<p style="margin:0;">${escapeHtml(text)}</p>`;

        if (Array.isArray(imageUrls)) {
            imageUrls.forEach((url) => {
                div.innerHTML += `<img src="${url}" onclick="openImageModal('${url}')">`;
            });
        } else if (imageUrls) {
            div.innerHTML += `<img src="${imageUrls}" onclick="openImageModal('${imageUrls}')">`;
        }

        return div;
    }

    function renderMessages(items, { prepend = false } = {}) {
        const box = document.getElementById('chatBox');
        if (!box) return;

        const fragment = document.createDocumentFragment();
        (items || []).forEach((m) => {
            const role = (m.role === "assistant") ? "assistant" : "user";
            const imageUrls = m.image ? [m.image].map((img) => {
                const p = img.file_directory;
                if (!p) return null;
                if (p.startsWith("data:image/")) return p;
                if (p.startsWith("http")) return p;
                return `${API_BASE}${p}`;
            }).filter(Boolean) : [];

            fragment.appendChild(createMessageElement(role, m.content, imageUrls, m.id));
        });

        if (prepend) {
            box.insertBefore(fragment, box.firstChild);
        } else {
            box.appendChild(fragment);
        }
    }

    async function loadInitialHistory() {
        const data = await fetchHistoryPage(15, null);
        const items = Array.isArray(data.items) ? data.items : [];

        clearChatBox();
        if (items.length === 0) {
            appendMsg("assistant", "ì•ˆë…•í•˜ì„¸ìš”! ì–´ë–¤ ê´‘ê³  ì•„ì´ë””ì–´ê°€ í•„ìš”í•˜ì‹ ê°€ìš”?");
            nextCursor = null;
            oldestMessageId = null;
            return;
        }

        renderMessages(items);
        oldestMessageId = items[0].id ?? null;
        nextCursor = data.next_cursor ?? null;

        const box = document.getElementById('chatBox');
        if (box) box.scrollTop = box.scrollHeight;
    }

    async function loadOlderHistory() {
        if (isLoadingHistory || !nextCursor || !oldestMessageId) return;
        isLoadingHistory = true;

        const box = document.getElementById('chatBox');
        const prevHeight = box ? box.scrollHeight : 0;

        const data = await fetchHistoryPage(10, oldestMessageId);
        const items = Array.isArray(data.items) ? data.items : [];

        if (items.length > 0) {
            renderMessages(items, { prepend: true });
            oldestMessageId = items[0].id ?? oldestMessageId;
            nextCursor = data.next_cursor ?? null;

            if (box) {
                const newHeight = box.scrollHeight;
                box.scrollTop = newHeight - prevHeight;
            }
        } else {
            nextCursor = null;
        }

        isLoadingHistory = false;
    }


    async function initAuth() {
        const token = localStorage.getItem("access_token");
        if (!token) return;

        try {
          const res = await fetch(`${API_BASE}/auth/me`, {
              method: "GET",
              headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
              },
          });

          if (!res.ok) {
              // í† í° ë§Œë£Œ/ë¬´íš¨ë©´ ì €ì¥ê°’ ì •ë¦¬
              localStorage.removeItem("access_token");
              localStorage.removeItem("session_id");
              return;
          }

          const data = await res.json();

          const sessionRes = await fetch(`${API_BASE}/chat/session`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({
              session_id: localStorage.getItem("session_id"),
            }),
          });
          if (sessionRes.ok) {
            const sessionData = await safeJson(sessionRes);
            currentSessionId = sessionData.session_id ?? null;
            if (currentSessionId) localStorage.setItem("session_id", currentSessionId);
          }

          onLoginSuccess(data.name);
          await loadInitialHistory();
          await checkUnconfirmedGeneration();
        } catch (e) {
          console.error(e);
        }
    }

    // í˜ì´ì§€ ë¡œë“œë˜ë©´ ìë™ ë³µêµ¬
    window.addEventListener("DOMContentLoaded", () => {
        // ê¸°ì¡´ ë¡œê·¸ì¸ ë³µêµ¬
        initAuth();

        const box = document.getElementById('chatBox');
        if (box) {
            box.addEventListener('scroll', () => {
                if (box.scrollTop === 0) loadOlderHistory();
            });
        }
    });

    // ====== ëª¨ë‹¬ ì œì–´ ======
    function openModal() {
        if (isSignup) toggleAuth();
        document.getElementById('auth-modal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('auth-modal').classList.add('hidden');
        if (isSignup) toggleAuth();
        document.getElementById('loginId').value = '';
        document.getElementById('password').value = '';
        document.getElementById('nickname').value = '';
    }

    function toggleAuth() {
        isSignup = !isSignup;
        document.getElementById('auth-title').innerText = isSignup ? "íšŒì›ê°€ì…" : "ë¡œê·¸ì¸";
        document.getElementById('main-btn').innerText = isSignup ? "ê°€ì…í•˜ê¸°" : "ë¡œê·¸ì¸";
        document.getElementById('signup-fields').classList.toggle('hidden');
        document.getElementById('toggle-question').innerText = isSignup ? "ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?" : "ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?";
        document.getElementById('toggle-link').innerText = isSignup ? "ë¡œê·¸ì¸í•˜ê¸°" : "íšŒì›ê°€ì…í•˜ê¸°";
    }

    async function handleAuth() {
        const loginId = document.getElementById('loginId').value;
        const loginPw = document.getElementById('password').value;

        if (isSignup) {
        const name = document.getElementById('nickname').value;
        const res = await fetch(`${API_BASE}/auth/signup`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ login_id: loginId, login_pw: loginPw, name: name })
        });
        const data = await safeJson(res);
        if (res.ok) { alert("ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”."); toggleAuth(); }
        else { alert(data.detail ?? "íšŒì›ê°€ì… ì‹¤íŒ¨"); }
        return;
        }

        // ë¡œê·¸ì¸
        const loginForm = new URLSearchParams();
        loginForm.set("username", loginId);
        loginForm.set("password", loginPw);
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: loginForm.toString(),
        });

        const data = await safeJson(res);
        if (!res.ok) {
          alert(data.detail ?? "ë¡œê·¸ì¸ ì‹¤íŒ¨");
          return;
        }

        // ====== ë¡œê·¸ì¸ ì„±ê³µ ì²˜ë¦¬ ======
        // í† í° ì €ì¥
        if (data.access_token) localStorage.setItem("access_token", data.access_token);

        let displayName = "ì‚¬ìš©ì";
        if (data.access_token) {
          const meRes = await fetch(`${API_BASE}/auth/me`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${data.access_token}`,
            },
          });
          if (meRes.ok) {
            const me = await safeJson(meRes);
            displayName = me.name ?? displayName;
          }
        }

        const sessionRes = await fetch(`${API_BASE}/chat/session`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${data.access_token}`,
          },
          body: JSON.stringify({
            session_id: localStorage.getItem("session_id"),
          }),
        });
        if (sessionRes.ok) {
          const sessionData = await safeJson(sessionRes);
          currentSessionId = sessionData.session_id ?? null;
          if (currentSessionId) localStorage.setItem("session_id", currentSessionId);
        }

        onLoginSuccess(displayName);
        await loadInitialHistory();
        await checkUnconfirmedGeneration();

        closeModal();
    }

    function onLoginSuccess(name) {
        document.getElementById('loginTabBtn').classList.add('hidden');
        document.getElementById('profileEditBtn').classList.remove('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        document.getElementById('userInfo').innerText = `${name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
        document.getElementById('userInfo').classList.remove('hidden');
    }

    function handleLogout() {
        localStorage.removeItem("access_token");
        localStorage.removeItem("session_id");
        currentSessionId = null;
        document.getElementById('profileEditBtn').classList.add('hidden');
        document.getElementById('logoutBtn').classList.add('hidden');
        document.getElementById('loginTabBtn').classList.remove('hidden');
        document.getElementById('userInfo').classList.add('hidden');
        location.reload();
    }

    // ====== íšŒì›ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ ======
    async function openProfileEditModal() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/auth/me`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
            });

            if (!res.ok) {
                alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            const data = await safeJson(res);
            document.getElementById('editName').value = data.name || '';
            document.getElementById('editCurrentPassword').value = '';
            document.getElementById('editNewPassword').value = '';
            document.getElementById('profile-edit-modal').classList.remove('hidden');
        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function closeProfileEditModal() {
        document.getElementById('profile-edit-modal').classList.add('hidden');
        document.getElementById('editName').value = '';
        document.getElementById('editCurrentPassword').value = '';
        document.getElementById('editNewPassword').value = '';
    }

    async function handleProfileUpdate() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }

        const name = document.getElementById('editName').value;
        const currentPassword = document.getElementById('editCurrentPassword').value;
        const newPassword = document.getElementById('editNewPassword').value;

        // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ëŠ” í•„ìˆ˜
        if (!currentPassword.trim()) {
            alert("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const body = {
            current_password: currentPassword.trim()
        };
        if (name.trim()) body.name = name.trim();
        if (newPassword.trim()) body.new_password = newPassword.trim();

        try {
            const res = await fetch(`${API_BASE}/auth/user`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(body),
            });

            const data = await safeJson(res);

            if (!res.ok) {
                alert(data.detail || "ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            alert("íšŒì›ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
            if (body.name) {
                document.getElementById('userInfo').innerText = `${body.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`;
            }
            closeProfileEditModal();
        } catch (e) {
            console.error(e);
            alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ====== ì´ë¯¸ì§€ ì—…ë¡œë“œ (ë‹¨ì¼ íŒŒì¼) ======
    function handleImageUpload(event) {
        const files = Array.from(event.target.files || []);
        if (!files.length) return;

        // ì²« ë²ˆì§¸ íŒŒì¼ë§Œ ì„ íƒ (ê¸°ì¡´ íŒŒì¼ êµì²´)
        selectedImageFile = files[0];

        renderPreviews();
        updateSendButton();

        event.target.value = '';
    }

    function renderPreviews() {
        const strip = document.getElementById('previewStrip');
        strip.innerHTML = '';

        if (!selectedImageFile) {
            strip.classList.add('hidden');
            return;
        }

        strip.classList.remove('hidden');

        const item = document.createElement('div');
        item.className = 'preview-item';

        const img = document.createElement('img');
        img.alt = selectedImageFile.name;

        const reader = new FileReader();
        reader.onload = () => { img.src = reader.result; };
        reader.readAsDataURL(selectedImageFile);

        const removeBtn = document.createElement('div');
        removeBtn.className = 'preview-remove';
        removeBtn.innerText = 'Ã—';
        removeBtn.onclick = () => removePreview();

        item.appendChild(img);
        item.appendChild(removeBtn);
        strip.appendChild(item);
    }

    function removePreview() {
        selectedImageFile = null;
        renderPreviews();
        updateSendButton();
    }

    function updateSendButton() {
        const msg = document.getElementById('userMsg').value;
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = (msg.trim().length === 0);
    }

    // ====== (ì¶”ê°€) assistant placeholder / update ======
    function appendAssistantPlaceholder(text) {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        const id = `a_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        div.id = id;
        div.className = `msg assistant`;
        div.innerHTML = `<p style="margin:0;">${escapeHtml(text)}</p>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
        return id;
    }

    function updateAssistantPlaceholder(id, text, imageUrls) {
        const div = document.getElementById(id);
        if (!div) return;
        div.innerHTML = `<p style="margin:0;">${escapeHtml(text)}</p>`;
        if (Array.isArray(imageUrls)) {
            imageUrls.forEach((url) => {
                div.innerHTML += `<img src="${url}" onclick="openImageModal('${url}')">`;
            });
        } else if (imageUrls) {
            div.innerHTML += `<img src="${imageUrls}" onclick="openImageModal('${imageUrls}')">`;
        }
        const box = document.getElementById('chatBox');
        box.scrollTop = box.scrollHeight;
    }

    // ====== (ì¶”ê°€) HTML ì´ìŠ¤ì¼€ì´í”„ ======
    function escapeHtml(str) {
        return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }


    // ====== sendChat ======
    async function sendChat() {
        const input = document.getElementById('userMsg');
        const msg = input.value;

        if (msg.trim().length === 0) return;

        const previewUrls = selectedImageFile ? [await fileToDataUrl(selectedImageFile)] : [];

        appendMsg('user', msg, previewUrls);

        input.value = '';
        updateSendButton();

        const form = new FormData();
        if (currentSessionId) {
            form.append("session_id", currentSessionId);
        }
        form.append("message", msg);

        // ì´ë¯¸ì§€ íŒŒì¼ ì¶”ê°€ (ì„ íƒì‚¬í•­)
        if (selectedImageFile) {
            form.append("image", selectedImageFile);
        }

        selectedImageFile = null;
        renderPreviews();

        const loadingId = appendAssistantPlaceholder("ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...");

        try {
          const token = localStorage.getItem("access_token");

          const res = await fetch(`${API_BASE}/chat/message`, {
              method: 'POST',
              headers: token ? { Authorization: `Bearer ${token}` } : {},
              body: form
          });

          if (!res.ok) {
              const err = await safeJson(res);
              updateAssistantPlaceholder(loadingId, err.detail ?? "ìš”ì²­ ì‹¤íŒ¨");
              return;
          }

          const data = await res.json();
          currentSessionId = data.session_id;
          if (data.session_id) localStorage.setItem("session_id", data.session_id);

          // Intent ë¶„ì„ ê²°ê³¼ í™•ì¸
          const intent = data.intent || "consulting";

          // 1. ìƒë‹´ intent: ë°”ë¡œ ì‘ë‹µ í‘œì‹œ
          if (intent === "consulting") {
              const assistantMessage = data.assistant_message || "ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?";
              updateAssistantPlaceholder(loadingId, assistantMessage);
              return;
          }

          // 2. ìƒì„±/ìˆ˜ì • intent: ìƒì„± íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          if (intent === "generation" || intent === "modification") {
              if (data.redirect_to_pipeline && data.task_id) {
                  updateAssistantPlaceholder(loadingId, "ê´‘ê³ ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...");
                  await pollTask(data.task_id, loadingId);
                  // pollTask ë‚´ì—ì„œ ì´ë¯¸ checkUnconfirmedGeneration() í˜¸ì¶œí•¨
              } else {
                  updateAssistantPlaceholder(loadingId, data.assistant_message || "ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...");
              }
              return;
          }

          // ê¸°ë³¸ê°’: ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ
          updateAssistantPlaceholder(loadingId, data.assistant_message || "ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");

        } catch (e) {
            console.error(e);
            updateAssistantPlaceholder(loadingId, "ì„œë²„ì™€ í†µì‹ í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
        });
    }

    function appendMsg(role, text, imageUrls, messageId) {
      const box = document.getElementById('chatBox');
      if (!box) return;

      const div = createMessageElement(role, text, imageUrls, messageId);
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }



    // ====== í™•ì •ë˜ì§€ ì•Šì€ ìƒì„± ê²°ê³¼ í™•ì¸ ======
    async function checkUnconfirmedGeneration() {
        // ì„¸ì…˜ IDê°€ ì—†ìœ¼ë©´ í™•ì¸í•  ìˆ˜ ì—†ìŒ
        if (!currentSessionId) {
            hasUnconfirmedGeneration = false;
            toggleAdActions(false);
            return;
        }

        try {
            const token = localStorage.getItem("access_token");
            const headers = {
                "Content-Type": "application/json"
            };
            // í† í°ì´ ìˆìœ¼ë©´ Authorization í—¤ë” ì¶”ê°€ (ê²ŒìŠ¤íŠ¸ë„ ì¡°íšŒ ê°€ëŠ¥)
            if (token) {
                headers.Authorization = `Bearer ${token}`;
            }

            const res = await fetch(`${API_BASE}/chat/generation/${currentSessionId}`, {
                method: "GET",
                headers: headers,
            });

            if (!res.ok) {
                hasUnconfirmedGeneration = false;
                toggleAdActions(false);
                return;
            }

            const data = await safeJson(res);
            // APIëŠ” { generations: [...] } í˜•íƒœë¡œ ë°˜í™˜
            // ìµœì‹  ìƒì„± ê²°ê³¼(ë°°ì—´ì˜ ì²« ë²ˆì§¸ í•­ëª©)ê°€ ìˆê³ , is_confirmedê°€ falseì¸ ê²½ìš°
            const generations = data.generations || [];
            const latestGeneration = generations.length > 0 ? generations[0] : null;
            hasUnconfirmedGeneration = latestGeneration && latestGeneration.is_confirmed === false;
            toggleAdActions(hasUnconfirmedGeneration);
        } catch (e) {
            console.error(e);
            hasUnconfirmedGeneration = false;
            toggleAdActions(false);
        }
    }

    function toggleAdActions(show) {
        const actions = document.getElementById('adActions');
        if (show) {
            actions.classList.remove('hidden');
        } else {
            actions.classList.add('hidden');
        }
    }

    // ====== ê´‘ê³  ìˆ˜ì • ìš”ì²­ ======
    async function handleRevise() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }

        if (!currentSessionId) {
            alert("ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const revisionRequest = prompt("ì–´ë–»ê²Œ ìˆ˜ì •í• ê¹Œìš”? (ì˜ˆ: ë” ë°ê²Œ, í…ìŠ¤íŠ¸ ë³€ê²½, ìŠ¤íƒ€ì¼ ë³€ê²½)");
        if (!revisionRequest || revisionRequest.trim().length === 0) {
            return;
        }

        const loadingId = appendAssistantPlaceholder("ê´‘ê³ ë¥¼ ìˆ˜ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...");

        try {
            const form = new FormData();
            form.append("session_id", currentSessionId);
            form.append("revision_request", revisionRequest.trim());

            const res = await fetch(`${API_BASE}/chat/revise`, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${token}`,
                },
                body: form,
            });

            if (!res.ok) {
                const err = await safeJson(res);
                updateAssistantPlaceholder(loadingId, err.detail ?? "ìˆ˜ì • ìš”ì²­ ì‹¤íŒ¨");
                return;
            }

            const data = await safeJson(res);
            if (data.task_id) {
                await pollTask(data.task_id, loadingId);
                // pollTask ë‚´ì—ì„œ ì´ë¯¸ checkUnconfirmedGeneration() í˜¸ì¶œí•¨
            } else {
                updateAssistantPlaceholder(loadingId, "ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                await checkUnconfirmedGeneration();
            }
        } catch (e) {
            console.error(e);
            updateAssistantPlaceholder(loadingId, "ìˆ˜ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ====== ê´‘ê³  í™•ì • ======
    async function handleConfirm() {
        const token = localStorage.getItem("access_token");
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }

        if (!currentSessionId) {
            alert("ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        if (!confirm("ì´ ê´‘ê³ ë¥¼ ìµœì¢… í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            return;
        }

        try {
            const form = new FormData();
            form.append("session_id", currentSessionId);

            const res = await fetch(`${API_BASE}/chat/confirm`, {
                method: "POST",
                headers: {
                    Authorization: `Bearer ${token}`,
                },
                body: form,
            });

            if (!res.ok) {
                const err = await safeJson(res);
                alert(err.detail ?? "í™•ì • ì‹¤íŒ¨");
                return;
            }

            const data = await safeJson(res);
            appendMsg("assistant", data.message || "ê´‘ê³ ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");

            hasUnconfirmedGeneration = false;
            toggleAdActions(false);
        } catch (e) {
            console.error(e);
            alert("í™•ì • ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ====== pollTask: task ìƒíƒœ ì¡°íšŒ ======
    async function pollTask(taskId, placeholderId) {
        const token = localStorage.getItem("access_token");
        const headers = token ? { Authorization: `Bearer ${token}` } : {};
        const maxAttempts = 120;

        for (let i = 0; i < maxAttempts; i++) {
            const res = await fetch(`${API_BASE}/tasks/${taskId}`, {
                method: "GET",
                headers,
            });

            if (res.status === 404) {
                updateAssistantPlaceholder(placeholderId, "ì‘ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            if (!res.ok) {
                updateAssistantPlaceholder(placeholderId, "ì‘ì—… ìƒíƒœ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return;
            }

            const status = await safeJson(res);
            const statusValue = String(status.status || "").toLowerCase();

            if (statusValue === "done" || status.result) {
                const result = status.result || {};
                const output = result.output || {};
                const imageUrls = output.image ? [output.image].map((img) => {
                    if (!img) return null;
                    if (img.startsWith("data:image/")) return img;
                    if (img.startsWith("http")) return img;
                    if (img.startsWith("/")) return `${API_BASE}${img}`;
                    return `${API_BASE}/images/${img}`;
                }).filter(Boolean) : [];
                updateAssistantPlaceholder(placeholderId, output.output_text ?? "", imageUrls);
                // ê´‘ê³  ìƒì„± ì™„ë£Œ í›„ ìˆ˜ì •/í™•ì • ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€ í™•ì¸
                await checkUnconfirmedGeneration();
                return;
            }

            if (statusValue === "failed" || status.error) {
                updateAssistantPlaceholder(placeholderId, status.error ?? "ì‘ì—… ì‹¤íŒ¨");
                return;
            }

            const progress = Number.isFinite(status.progress) ? status.progress : 0;
            updateAssistantPlaceholder(
                placeholderId,
                `ìƒì„± ì¤‘ì…ë‹ˆë‹¤... (${progress}%) [${statusValue || "pending"}]`
            );
            await new Promise(r => setTimeout(r, 1000));
        }

        updateAssistantPlaceholder(placeholderId, "ì²˜ë¦¬ ì‹œê°„ì´ ê¸¸ì–´ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }

    // ====== ì´ë¯¸ì§€ ëª¨ë‹¬ ì œì–´ ======
    function openImageModal(imageUrl) {
        const modal = document.getElementById('image-modal');
        const modalImg = document.getElementById('modal-image');
        modalImg.src = imageUrl;
        modal.classList.remove('hidden');
    }

    function closeImageModal() {
        const modal = document.getElementById('image-modal');
        modal.classList.add('hidden');
    }
</script>
</body>
</html>
